{"version":3,"sources":["../src/pm_course_favorites.js"],"names":["define","$","ajax","notification","log","mview","ajaxNotify","enableAll","reloadCourseCardTemplate","renderable","cardEl","dfd","Deferred","trigger","callback","button","find","removeClass","focus","on","e","resolve","promise","getCardId","parseInt","data","getCardTitle","lowerCase","title","html","toLowerCase","getCardIndex","cards","length","sort","sortItem","each","card","push","a","b","aId","bId","indexOf","moveCard","listSelector","listSelectorWhenEmpty","prependWhenEmpty","onMoveComplete","cardEls","idx","insIdx","debug","eq","before","after","prepend","append","moveOutOfFavorites","container","publishedcount","addClass","collapse","window","console","favoriteCourse","hasClass","favorited","attr","parents","shortname","doAjax","jsid","call","methodname","args","courseshortname","fail","response","ifErrorShowBestMsg","then","M","util","js_complete","Date","getTime","toString","Math","floor","random","js_pending","preventDefault","stopPropagation"],"mappings":"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","sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package   theme_snap\n * @copyright Copyright (c) 2016 Blackboard Inc. (http://www.blackboard.com)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Course card favoriting.\n */\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/log', 'theme_snap/model_view', 'theme_snap/ajax_notification'],\n    function($, ajax, notification, log, mview, ajaxNotify) {\n        return function() {\n            log.enableAll(true);\n\n            /**\n             * The ajax call has returned a new course_card renderable.\n             *\n             * @method reloadCourseCardTemplate\n             * @param {object} renderable - coursecard renderable\n             * @param {jQuery} cardEl - coursecard element\n             * @returns {Promise}\n             */\n            var reloadCourseCardTemplate = function(renderable, cardEl) {\n                var dfd = $.Deferred();\n                mview(cardEl, 'theme_snap/course_cards');\n                var callback = function() {\n                    var button = $(cardEl).find('.favoritetoggle');\n                    $(button).removeClass('ajaxing');\n                    $(button).focus();\n                };\n                $(cardEl).trigger('modelUpdate', [renderable, callback]);\n                $(cardEl).on('modelUpdated', function(e) {\n                    dfd.resolve(e);\n                });\n                return dfd.promise();\n            };\n\n            /**\n             * Get course card course id.\n             * @param {jQuery} cardEl\n             * @returns {int}\n             */\n            var getCardId = function(cardEl) {\n                return parseInt($(cardEl).find('.coursecard-body').data('courseid'));\n            };\n\n            /**\n             * Get course card full name.\n             * @param {jQuery} cardEl\n             * @param {null|bool} lowerCase\n             * @returns {*|jQuery}\n             */\n            var getCardTitle = function(cardEl, lowerCase) {\n                // The title comes back in lower case by default as it's used for case insensitive sorting.\n                if (lowerCase === undefined) {\n                    lowerCase = true;\n                }\n                var title = $(cardEl).find('.coursecard-coursename').html();\n                if (lowerCase) {\n                    title = title.toLowerCase();\n                }\n                return title;\n            };\n\n            /**\n             * Get index of card within list.\n             *\n             * @param {jQuery} cardEl\n             * @param {jQuery} cards\n             * @returns {number}\n             */\n            var getCardIndex = function(cardEl, cards) {\n                if (cards.length === 0) {\n                    return -1;\n                }\n                // The sort variable is purely for sorting the cards by name.\n                var sort = [],\n                    sortItem = {};\n\n                cards.each(function() {\n                    sortItem = {\n                        title: getCardTitle(this),\n                        card: this\n                    };\n                    sort.push(sortItem);\n                });\n                // Add the item we are inserting to the list.\n                sortItem = {\n                    title: getCardTitle(cardEl),\n                    card: cardEl\n                };\n                sort.push(sortItem);\n                sort.sort(function(a, b) {\n                    var aId = getCardId(a.card);\n                    var bId = getCardId(b.card);\n                    if (a.title === b.title) {\n                        if (aId === bId) {\n                            return 0;\n                        }\n                        return aId > bId ? 1 : -1;\n                    }\n                    return a.title > b.title ? 1 : -1;\n                });\n                return sort.indexOf(sortItem);\n            };\n\n            /**\n             * Move card into alphabetical place in list.\n             * @param {jQuery} cardEl\n             * @param {string} listSelector\n             * @param {string} listSelectorWhenEmpty\n             * @param {bool} prependWhenEmpty\n             * @param {function} onMoveComplete\n             */\n            var moveCard = function(cardEl, listSelector, listSelectorWhenEmpty, prependWhenEmpty, onMoveComplete) {\n\n                var cardEls = $(listSelector);\n                var idx = getCardIndex(cardEl, cardEls);\n                var insIdx = idx + 1;\n\n                log.debug('Moving card element into position ' + insIdx +\n                    ' of list (size = ' + cardEls.length + ') : ' + listSelector);\n\n                if (insIdx > 0) {\n                    if (insIdx <= cardEls.length) {\n                        log.debug('Moving card before position ' + insIdx + '  using selector ' + listSelector);\n                        $(listSelector).eq(idx).before(cardEl);\n                    } else {\n                        log.debug('Moving card after position ' + cardEls.length + ' using selector ' + listSelector);\n                        $(listSelector).eq(cardEls.length - 1).after(cardEl);\n                    }\n                } else {\n                    log.debug('Destination ' + listSelector + ' empty');\n                    if (prependWhenEmpty) {\n                        log.debug('prepending to ' + listSelectorWhenEmpty);\n                        $(listSelectorWhenEmpty).prepend(cardEl);\n                    } else {\n                        log.debug('appending to ' + listSelectorWhenEmpty);\n                        $(listSelectorWhenEmpty).append(cardEl);\n                    }\n                }\n\n                if (typeof (onMoveComplete) === 'function') {\n                    onMoveComplete();\n                }\n            };\n\n            /**\n             * Move card element out of favorites.\n             * @param {jQuery} cardEl\n             * @param {function} onMoveComplete\n             * @returns {void}\n             */\n            var moveOutOfFavorites = function(cardEl, onMoveComplete) {\n                var container;\n                // Check there are courses which are not hidden.\n                // When this is 0 we only have hidden courses, so container is #snap-pm-courses-current-cards.\n                var publishedcount = $('#snap-pm-courses-current .coursecard:not([data-hidden=\"true\"])').length;\n                // Special stuff for when moving a hidden course.\n                if ($(cardEl).data('hidden') === true && publishedcount > 0) {\n                    container = '#snap-pm-courses-hidden-cards';\n                    // Open hidden courses section.\n                    $('#snap-pm-courses-hidden').addClass('state-visible');\n                    $('#snap-pm-courses-hidden-cards').collapse('show');\n                } else {\n                    window.console.log('not a hidden card');\n                    container = '#snap-pm-courses-current-cards';\n                }\n                moveCard(cardEl, container + ' .coursecard:not(.favorited)', container, false, onMoveComplete);\n            };\n\n            /**\n             * Favorite a course.\n             * @param {jQuery} button - button clicked on to favorite the course.\n             */\n            var favoriteCourse = function(button) {\n                if ($(button).hasClass('ajaxing')) {\n                    return;\n                }\n\n                $(button).addClass('ajaxing');\n\n                var favorited = $(button).attr('aria-pressed') === 'true' ? 0 : 1;\n                var cardEl = $($(button).parents('.coursecard')[0]);\n                var shortname = $(cardEl).data('shortname');\n\n                var doAjax = function(jsid) {\n                    return ajax.call([\n                        {\n                            methodname: 'theme_snap_course_card',\n                            args: {courseshortname: shortname, favorited: favorited},\n                            fail: function(response) {\n                                $(button).removeClass('ajaxing');\n                                ajaxNotify.ifErrorShowBestMsg(response);\n                            }\n                        }\n                    ], true, true)[0].then(function(response) {\n                        return reloadCourseCardTemplate(response, cardEl);\n                    }).then(function() {\n                        M.util.js_complete(jsid);\n                    });\n                };\n\n                var jsid;\n                if (favorited === 1) {\n                    jsid = 'favourite_' + new Date().getTime().toString(16) + (Math.floor(Math.random() * 1000));\n                    M.util.js_pending(jsid);\n                    // Move to favorites.\n                    moveCard(cardEl, '#snap-pm-courses-current-cards .coursecard.favorited', '#snap-pm-courses-current-cards', true,\n                        function() {\n                            doAjax(jsid);\n                        }\n                    );\n                } else {\n                    jsid = 'unfavourite_' + new Date().getTime().toString(16) + (Math.floor(Math.random() * 1000));\n                    M.util.js_pending(jsid);\n                    moveOutOfFavorites(cardEl,\n                        function() {\n                           doAjax(jsid);\n                        }\n                    );\n                }\n            };\n\n            /**\n             * On clicking favourite toggle. (Delegated).\n             */\n            $(\"#snap-pm\").on(\"click\", \".favoritetoggle\", function(e) {\n                e.preventDefault();\n                e.stopPropagation();\n                favoriteCourse(this);\n            });\n        };\n    }\n);\n"],"file":"pm_course_favorites.min.js"}