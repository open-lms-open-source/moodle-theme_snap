{"version":3,"file":"personal_menu.min.js","sources":["../src/personal_menu.js"],"sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package\n * @copyright Copyright (c) 2016 Open LMS (https://www.openlms.net)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Snap Personal menu.\n */\ndefine(['jquery', 'core/log', 'theme_snap/pm_course_cards', 'theme_snap/util', 'theme_snap/ajax_notification'],\n    function($, log, courseCards, util, ajaxNotify) {\n\n        /**\n         * Personal Menu (courses menu).\n         * @constructor\n         */\n        var PersonalMenu = function() {\n\n            var self = this;\n\n            var redirectToSitePolicy = false;\n\n            var snapFeedsEnabled = false;\n\n            /**\n             * Add deadlines, messages, grades & grading,  async'ly to the personal menu\n             *\n             */\n            this.update = function() {\n\n                // If site policy needs acceptance, then don't update, just redirect to site policy!\n                if (redirectToSitePolicy) {\n                    var redirect = M.cfg.wwwroot + '/user/policy.php';\n                    window.location = redirect;\n                    return;\n                }\n\n                // Update course cards with info.\n                courseCards.reqCourseInfo(courseCards.getCourseIds());\n\n\n                $('#snap-pm').focus();\n\n                /**\n                 * Load ajax info into personal menu.\n                 * @param {string} type\n                 */\n                var loadAjaxInfo = function(type) {\n                    // Target for data to be displayed on screen.\n                    var container = $('#snap-personal-menu-' + type);\n                    if ($(container).length) {\n                        var cacheKey = M.cfg.sesskey + 'personal-menu-' + type;\n                        try {\n                            // Display old content while waiting\n                            if (util.supportsSessionStorage() && window.sessionStorage[cacheKey]) {\n                                log.info('using locally stored ' + type);\n                                var html = window.sessionStorage[cacheKey];\n                                $(container).html(html);\n                            }\n                            log.info('fetching ' + type);\n                            $.ajax({\n                                type: \"GET\",\n                                async: true,\n                                url: M.cfg.wwwroot + '/theme/snap/rest.php?action=get_' + type + '&contextid=' + M.cfg.context,\n                                success: function(data) {\n                                    ajaxNotify.ifErrorShowBestMsg(data).done(function(errorShown) {\n                                        if (errorShown) {\n                                            return;\n                                        } else {\n                                            // No errors, update sesion storage.\n                                            log.info('fetched ' + type);\n                                            if (util.supportsSessionStorage() && typeof (data.html) != 'undefined') {\n                                                window.sessionStorage[cacheKey] = data.html;\n                                            }\n                                            // Note: we can't use .data because that does not manipulate the dom, we need the data\n                                            // attribute populated immediately so things like behat can utilise it.\n                                            // .data just sets the value in memory, not the dom.\n                                            $(container).attr('data-content-loaded', '1');\n                                            $(container).html(data.html);\n                                        }\n                                    });\n                                }\n                            });\n                        } catch (err) {\n                            sessionStorage.clear();\n                            log.error(err);\n                        }\n                    }\n                };\n                if (!snapFeedsEnabled) {\n                    loadAjaxInfo('deadlines');\n                    loadAjaxInfo('graded');\n                    loadAjaxInfo('grading');\n                    loadAjaxInfo('messages');\n                    loadAjaxInfo('forumposts');\n                    $(document).trigger('snapUpdatePersonalMenu');\n\n                    // Triggering event for external PM open listeners.\n                    // Try/catch added to ensure browser compatibility for webcomponents.\n                    try {\n                        document.dispatchEvent(new Event('snapPersonalMenuOpen'));\n                    } catch (error) {\n                        log.error(error.message);\n                        try {\n                            var evt = document.createEvent(\"Event\");\n                            evt.initEvent('snapPersonalMenuOpen', true, true);\n                            document.dispatchEvent(evt);\n                        } catch (err) {\n                            log.error(err.message);\n                        }\n                    }\n                }\n            };\n\n            /**\n             * Apply listeners for personal menu in mobile mode.\n             */\n            var mobilePersonalMenuListeners = function() {\n                /**\n                 * Get section left position and height.\n                 * @param {string} href\n                 * @returns {Object.<string, number>}\n                 */\n                var getSectionCoords = function(href) {\n                    var sections = $(\"#snap-pm-content section\");\n                    var sectionWidth = $(sections).outerWidth();\n                    var section = $(href);\n                    var selector = \"#snap-pm-updates section > div, #snap-pm-updates section > snap-feed > div\";\n                    var targetSection = $(selector).index(section) + 1;\n                    var position = sectionWidth * targetSection;\n                    var sectionHeight = $(href).outerHeight() + 200;\n\n                    // Course lists is at position 0.\n                    if (href == '#snap-pm-courses') {\n                        position = 0;\n                    }\n\n                    // Set the window height.\n                    var winHeight = $(window).height();\n                    if (sectionHeight < winHeight) {\n                        sectionHeight = winHeight;\n                    }\n                    return {left: position, height: sectionHeight};\n                };\n                // Personal menu small screen behaviour corrections on resize.\n                $(window).on('resize', function() {\n                    if (window.innerWidth >= 992) {\n                        // If equal or larger than Bootstrap 992 large breakpoint, clear left positions of sections.\n                        $('#snap-pm-content').removeAttr('style');\n\n                        if ($(\"#snap-pm-courses div#snap-personal-menu-intelliboard\").length > 0) {\n                            var section = $('#snap-pm div#snap-personal-menu-intelliboard').closest('section');\n                            section.prependTo('#snap-pm-updates');\n                        }\n                        if ($(\"#snap-pm-courses div#snap-personal-menu-intellicart\").length > 0) {\n                            var section = $('#snap-pm div#snap-personal-menu-intellicart').closest('section');\n                            section.prependTo('#snap-pm-updates');\n                        }\n                        return;\n                    }\n                    var activeLink = $('#snap-pm-mobilemenu a.state-active');\n                    if (!activeLink || !activeLink.length) {\n                        return;\n                    }\n\n                    if ($(\"#snap-pm-updates div#snap-personal-menu-intelliboard\").length > 0) {\n                        var section = $('#snap-pm div#snap-personal-menu-intelliboard').closest('section');\n                        section.appendTo('section#snap-pm-courses');\n                    }\n                    if ($(\"#snap-pm-updates div#snap-personal-menu-intellicart\").length > 0) {\n                        var section = $('#snap-pm div#snap-personal-menu-intellicart').closest('section');\n                        section.appendTo('section#snap-pm-courses');\n                    }\n\n                    var href = activeLink.attr('href');\n                    var posHeight = getSectionCoords(href);\n\n                    $('#snap-pm-content').css('left', '-' + posHeight.left + 'px');\n                    $('#snap-pm-content').css('height', posHeight.height + 'px');\n                });\n                // Personal menu small screen behaviour.\n                $(document).on(\"click\", '#snap-pm-mobilemenu a', function(e) {\n                    var href = this.getAttribute('href');\n                    var posHeight = getSectionCoords(href);\n\n                    $(\"html, body\").animate({scrollTop: 0}, 0);\n                    $('#snap-pm-content').animate({\n                            left: '-' + posHeight.left + 'px',\n                            height: posHeight.height + 'px'\n                        }, \"700\", \"swing\",\n                        function() {\n                            // Animation complete.\n                        });\n                    $('#snap-pm-mobilemenu a').removeClass('state-active');\n                    $(this).addClass('state-active');\n                    e.preventDefault();\n                });\n            };\n\n            /**\n             * Apply personal menu listeners.\n             */\n            var applyListeners = function() {\n                // On clicking personal menu trigger.\n                $(document).on(\"click\", \".js-snap-pm-trigger\", function(event) {\n                    $(\"html, body\").animate({scrollTop: 0}, 0);\n                    $('body').toggleClass('snap-pm-open');\n                    if ($('.snap-pm-open #snap-pm').is(':visible')) {\n                        self.update();\n                    }\n                    event.preventDefault();\n\n                    // Intelliboard and intellicart should be displayed under the courses on a small screen.\n                    if (window.innerWidth < 992) {\n                        if ($(\"#snap-pm-updates div#snap-personal-menu-intelliboard\").length > 0) {\n                            var section = $('#snap-pm div#snap-personal-menu-intelliboard').closest('section');\n                            section.appendTo('section#snap-pm-courses');\n                        }\n                        if ($(\"#snap-pm-updates div#snap-personal-menu-intellicart\").length > 0) {\n                            var section = $('#snap-pm div#snap-personal-menu-intellicart').closest('section');\n                            section.appendTo('section#snap-pm-courses');\n                        }\n                    }\n\n                    // If there is a message drawer, dispatch event to avoid opening both elements.\n                    if ($('.message-app.main').length === 0) {\n                        document.dispatchEvent(new Event(\"messages-drawer:pm-toggle\"));\n                    }\n                });\n\n                mobilePersonalMenuListeners();\n            };\n\n            /**\n             * Initialising function.\n             * @param {boolean} sitePolicyAcceptReqd\n             * @param {boolean} snapFeedsFlag\n             */\n            this.init = function(sitePolicyAcceptReqd, snapFeedsFlag) {\n                redirectToSitePolicy = sitePolicyAcceptReqd;\n                snapFeedsEnabled = snapFeedsFlag;\n                applyListeners();\n                if (!redirectToSitePolicy) {\n                    courseCards.init();\n                }\n            };\n        };\n\n        return new PersonalMenu();\n    }\n);\n"],"names":["define","$","log","courseCards","util","ajaxNotify","self","this","redirectToSitePolicy","snapFeedsEnabled","update","redirect","M","cfg","wwwroot","window","location","reqCourseInfo","getCourseIds","focus","loadAjaxInfo","type","container","length","cacheKey","sesskey","supportsSessionStorage","sessionStorage","info","html","ajax","async","url","context","success","data","ifErrorShowBestMsg","done","errorShown","attr","err","clear","error","document","trigger","dispatchEvent","Event","message","evt","createEvent","initEvent","applyListeners","getSectionCoords","on","event","animate","scrollTop","toggleClass","is","preventDefault","innerWidth","closest","appendTo","href","sections","sectionWidth","outerWidth","section","position","index","sectionHeight","outerHeight","winHeight","height","left","removeAttr","prependTo","activeLink","posHeight","css","e","getAttribute","removeClass","addClass","init","sitePolicyAcceptReqd","snapFeedsFlag"],"mappings":"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"}