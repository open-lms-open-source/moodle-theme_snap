define(["jquery","theme_snap/bootstrap","core/log","theme_snap/headroom","theme_snap/personal_menu","theme_snap/responsive_video","theme_snap/section_asset_movement","theme_snap/cover_image"],function($,bsjq,log,Headroom,personalMenu,responsiveVideo,sectionAssetMovement,coverImage){"use strict";$=bsjq,M.theme_snap=M.theme_snap||{};var loggingenabled=!1,navheight=$("#mr-nav").outerHeight(),resizestamp=null;loggingenabled?log.enableAll(!0):log.disableAll(!0);var getURLParams=function(a){var b=a.split("?");if(b.length<2)return!1;var c=b[1];c=c.split("#")[0];for(var d=c.split("&"),e=[],f=0;f<d.length;f++){var g=d[f].split("="),h=g[0],i=g[1];e[h]=i}return e},lightbox=function(a,b){var c=$("#snap-light-box");return 0===c.length&&($(a).append('<div id="snap-light-box" tabindex="-1"><div id="snap-light-box-content"></div><a id="snap-light-box-close" class="pull-right snap-action-icon" href="#"><i class="icon icon-close"></i><small>Close</small></a></div>'),$("#snap-light-box-close").click(function(a){a.preventDefault(),a.stopPropagation(),lightboxclose(),"function"==typeof b&&b()}),c=$("#snap-light-box")),c},lightboxclose=function(){var a=lightbox();a.remove()},lightboxopen=function(a,b,c){b=b?b:$("body");var d=lightbox(b,c);if(a){var e=$("#snap-light-box-content");e.html(""),e.append(a)}d.addClass("state-visible")},movePHPErrorsToHeader=function(){var a=$(".xdebug-error");if(a.length)for(var b=0;b<a.length;b++){var c=a[b],d=c.parentNode,e=$(d).prev("br");$(e).remove()}var f=$(".xdebug-error, .php-debug, .debuggingmessage");if(f.length){$(f).addClass("php-debug-footer");var g=$('<div id="footer-error-cont"><h3>'+M.util.get_string("debugerrors","theme_snap")+"</h3><hr></div>");$("#page-footer").append(g),$("#footer-error-cont").append(f),$(".php-debug-footer").after($("<hr>")),$("#mr-nav").addClass("errors-found");var h=$('<a class="footer-error-link btn btn-danger" href="#footer-error-cont">'+M.util.get_string("problemsfound","theme_snap")+' <span class="badge">'+f.length+"</span></a>");$("#page-header").append(h)}},onCoursePage=function(){return 0===$("body").attr("id").indexOf("page-course-view-")},scrollToElement=function(a){if(a.length&&!(a.length>1)){var b=a.offset().top-navheight;$("html, body").animate({scrollTop:b},600)}},applyBlockHash=function(){if(onCoursePage()&&$(".block_adminblock form").each(function(){$(this).attr("action",$(this).attr("action")+"#coursetools")}),""===location.hash){var a=getURLParams(location.href);onCoursePage()&&"undefined"!=typeof a.time&&(location.hash="coursetools",$(".block_calendar_month")&&scrollToElement($(".block_calendar_month")));var b=["body.path-blocks-collect #notice form"],c=["bui_deleteid","bui_editid"];for(var d in c){var e=c[d];if("undefined"!=typeof a[e]){b.push("#notice form");break}}$(b.join(", ")).each(function(){var a=$(this).attr("action");-1===a.indexOf("#")&&a.indexOf("/course/view.php")>-1&&$(this).attr("action",$(this).attr("action")+"#coursetools")})}},setForumStrings=function(){$(".path-mod-forum tr.discussion td.topic.starter").attr("data-cellname",M.util.get_string("forumtopic","theme_snap")),$(".path-mod-forum tr.discussion td.picture:not('.group')").attr("data-cellname",M.util.get_string("forumauthor","theme_snap")),$(".path-mod-forum tr.discussion td.picture.group").attr("data-cellname",M.util.get_string("forumpicturegroup","theme_snap")),$(".path-mod-forum tr.discussion td.replies").attr("data-cellname",M.util.get_string("forumreplies","theme_snap")),$(".path-mod-forum tr.discussion td.lastpost").attr("data-cellname",M.util.get_string("forumlastpost","theme_snap"))},processSearchString=function(a){return a=a.trim().toLowerCase()},tocSearchCourse=function(a){var b,c=window.navigator.userAgent;(c.indexOf("MSIE ")||c.indexOf("Trident/"))&&(a=$("#toc-searchables").find("li").clone(!0));var d=$("#toc-search-input").val();if(d=processSearchString(d),0===d.length)$("#toc-search-results").html(""),$("#toc-search-input").removeClass("state-active");else{$("#toc-search-input").addClass("state-active");var e=[];for(b=0;b<a.length;b++){var f=a[b];processSearchString($(f).text()).indexOf(d)>-1&&e.push(f)}$("#toc-search-results").html(e)}},scrollToModule=function(a){$("#toc-search-results").html("");var b=$("#"+a.replace("#",""));scrollToElement(b);var c=$("#searchpin");c.length||(c=$('<i id="searchpin"></i>')),$(b).find(".instancename").prepend(c),$(b).attr("tabindex","-1").focus()},checkHashScrollToModule=function(){0===location.hash.indexOf("#module")&&scrollToModule(location.hash)},showSection=function(){if(onCoursePage()){if(!$(".format-folderview").length){$(".course-content .main, #moodle-blocks,#coursetools, #snap-add-new-section").removeClass("state-visible");var a=location.hash.split("&"),b=a[0],c=a[1]||null;"#coursetools"==b&&$("#moodle-blocks").addClass("state-visible"),null!==c?($(b).addClass("state-visible"),scrollToModule(c)):($(b).addClass("state-visible").focus(),window.scrollTo(0,0))}var d=$(".course-content .main, #coursetools, #snap-add-new-section").filter(":visible");d.length||($("#section-0").addClass("state-visible").focus(),window.scrollTo(0,0)),responsiveVideo.apply();var e=".main.state-visible, #coursetools.state-visible, #snap-add-new-section.state-visible",f=$(e).attr("id");$("#chapters li").removeClass("current"),$('#chapters a[href$="'+f+'"]').parent("li").addClass("current")}},bodyClasses=function(){var a=[];$("#notice.snap-continue-cancel").length&&a.push("hascontinuecancel"),$("body").addClass(a.join(" "))},updateModCompletion=function(a,b){a.find(".autocompletion").replaceWith(b)},revealPageMod=function(a,b){a.find(".pagemod-content").slideToggle("fast",function(){a.is(".state-expanded")?(a.attr("aria-expanded","true"),a.find(".pagemod-content").focus()):(a.attr("aria-expanded","false"),a.focus())}),b&&updateModCompletion(a,b),responsiveVideo.apply()},lightboxMedia=function(resourcemod){var appendto=$("body"),spinner='<div class="loadingstat three-quarters">'+Y.Escape.html(M.util.get_string("loading","theme_snap"))+"</div>";lightboxopen(spinner,appendto,function(){$(resourcemod).attr("tabindex","-1").focus(),$(resourcemod).removeAttr("tabindex")}),$.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_media&contextid="+$(resourcemod).data("modcontext"),success:function(data){lightboxopen(data.html,appendto),updateModCompletion($(resourcemod),data.completionhtml);var hasflowplayerscript=!1;if($("#snap-light-box script").each(function(){var script=$(this).text();script=script.replace(/^(?:\s*)\/\/<!\[CDATA\[/,"").replace(/\/\/\]\](?:\s*)$/,""),script.indexOf("M.util.add_video_player")>-1&&(hasflowplayerscript=!0,M.util.video_players=[]),eval(script)}),hasflowplayerscript){var jsurl;jsurl=-1==M.cfg.jsrev?M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.13.js":M.cfg.wwwroot+"/lib/javascript.php?jsfile=/lib/flowplayer/flowplayer-3.2.13.min.js&rev="+M.cfg.jsrev,$('head script[src="'+jsurl+'"]').remove(),"undefined"!=typeof flowplayer&&(flowplayer=void 0),M.util.load_flowplayer(),$('head script[src="'+jsurl+'"]').trigger("onreadystatechange")}window.setTimeout(function(){responsiveVideo.apply()},1e3),$("#snap-light-box").focus()}})},addListeners=function(){var a=["body:not(.editing):not(.format-folderview) .chapters a","body:not(.format-folderview) .section_footer a","body:not(.format-folderview) #toc-search-results a"];$(document).on("click",a.join(", "),function(a){var b=this.getAttribute("href");window.history&&window.history.pushState?(history.pushState(null,null,b),$(window).trigger("hashchange"),a.preventDefault()):location.hash=b});var b=location.hash;$(window).on("popstate hashchange",function(a){var c=location.hash;log.info("hashchange"),c!==b&&("#primary-nav"===location.hash?personalMenu.update():($("#page, #moodle-footer, #js-personal-menu-trigger, #logo, .skiplinks").css("display",""),onCoursePage()&&(log.info("show section",a.target),$(".format-folderview").length?checkHashScrollToModule():showSection()))),b=c});var c=document.querySelector("#mr-nav"),d=new Headroom(c,{tolerance:5,offset:100,classes:{initial:"headroom",pinned:"headroom--pinned",unpinned:"headroom--unpinned",top:"headroom--top",notTop:"headroom--not-top"}});$(".notloggedin").length||d.init();var e=$("#toc-searchables").find("li").clone(!0);$("#toc-search-input").keyup(function(){tocSearchCourse(e)}),$("#toc-search-input").keydown(function(a){var b=a.keyCode||a.which;9===b&&$("#toc-search-results a").last().blur(function(){$(this).off("blur"),$("#toc-search-input").val(""),$("#toc-search-results").html(""),$("#toc-search-input").removeClass("state-active")})}),$(document).on("click","#toc-search-results a",function(){$("#toc-search-input").val(""),$("#toc-search-results").html(""),$("#toc-search-input").removeClass("state-active")}),$(document).on("click",function(a){$(a.target).closest("#toc-search-input").length||($("#toc-search-input").val(""),$("#toc-search-results").html(""),$("#toc-search-input").removeClass("state-active"))}),$(document).on("click","[data-action=hide],[data-action=show]",function(){$(this).closest("li.activity").toggleClass("draft")}),$(document).on("click",".snap-resource",function(a){var b=$(a.target),c="_self",d=$(b).closest(".snap-resource").find(".snap-asset-link a"),e="";if(d.length>0&&(e=$(d).attr("href")),!$(b).closest("form, a, input, label").length){if($(this).hasClass("js-snap-media"))lightboxMedia(this);else{if(""===e)return;"_blank"===$(d).attr("target")&&(c="_blank"),window.open(e,c)}a.preventDefault()}}),$(document).on("click","#admin-menu-trigger, #toc-mobile-menu-toggle",function(a){var b=this.getAttribute("href");"admin-menu-trigger"==this.getAttribute("id")&&($(this).toggleClass("active"),$("#page").toggleClass("offcanvas")),$(b).attr("tabindex","0"),$(b).toggleClass("state-visible").focus(),a.preventDefault()}),$(document).on("click","#course-toc.state-visible a",function(){$("#course-toc").removeClass("state-visible")});var f=".modtype_page .instancename,.pagemod-readmore,.pagemod-content .snap-action-icon";$(document).on("click",f,function(a){var b=$(this).closest(".modtype_page");scrollToElement(b);var c=b.hasClass("state-expanded");b.toggleClass("state-expanded");var d=b.find(".pagemod-readmore"),e=b.find(".pagemod-content");if(1==e.data("content-loaded")){revealPageMod(b);var f=M.cfg.wwwroot+"/theme/snap/rest.php?action=read_page&contextid="+d.data("pagemodcontext");c||$.ajax({type:"GET",async:!0,url:f,success:function(a){updateModCompletion(b,a.completionhtml)}})}else if(c)revealPageMod(b);else{b.find(".contentafterlink").prepend('<div class="ajaxstatus alert alert-info">'+M.str.theme_snap.loading+"</div>");var g=M.cfg.wwwroot+"/theme/snap/rest.php?action=get_page&contextid="+d.data("pagemodcontext");$.ajax({type:"GET",async:!0,url:g,success:function(a){e.prepend(a.html),e.data("content-loaded",1),b.find(".contentafterlink .ajaxstatus").remove(),revealPageMod(b,a.completionhtml)}})}a.preventDefault()}),$(document).on("click",".news-article .toggle",function(a){var b=$(this).closest(".news-article");scrollToElement(b),$(".news-article").not(b).removeClass("state-expanded"),$(".news-article-message").css("display","none"),b.toggleClass("state-expanded"),$(".state-expanded").find(".news-article-message").slideDown("fast",function(){b.is(".state-expanded")?(b.find(".news-article-message").focus(),b.attr("aria-expanded","true")):(b.focus(),b.attr("aria-expanded","false"))}),responsiveVideo.apply(),a.preventDefault()}),$(window).resize(function(){resizestamp=(new Date).getTime(),function(a){window.setTimeout(function(){log.info("checking "+a+" against "+resizestamp),a===resizestamp?(log.info("running resize hook functions"),responsiveVideo.apply()):log.info("skipping resize hook functions - timestamp has changed from "+a+" to "+resizestamp)},200)}(resizestamp)}),$(function(){var a=!1;"ontouchstart"in window?a=!0:window.navigator.msPointerEnabled&&(a=!0),a||$('[data-toggle="tooltip"]').tooltip()})};return{snapInit:function(a,b,c){M.theme_snap.courseid=a.id,M.theme_snap.courseconfig=a,M.cfg.context=a.contextid,$(document).ready(function(){if(movePHPErrorsToHeader(),setForumStrings(),addListeners(),applyBlockHash(),bodyClasses(),b&&sectionAssetMovement.init(),coverImage(M.theme_snap.courseconfig.shortname,c),onCoursePage()&&showSection(),$("body").hasClass("snap-fixy-open")&&personalMenu.update(),$("#page-course-editsection.format-topics").length){var a=document.getElementById("id_usedefaultname"),d=document.getElementById("id_name");a.value="0",a.checked=!1,d.required="required",d.focus(),$("#id_name + span").css("display","none"),$("#id_cancel").on("click",function(){$("#id_name").removeAttr("required"),$("#mform1").submit()})}if($(".format-folderview").length&&checkHashScrollToModule(),$("#page-mod-book-view").length){var e=getURLParams(location.href);$(".block_book_toc").append('<p><hr><a target="_blank" href="/mod/book/tool/print/index.php?id='+e.id+'">'+M.util.get_string("printbook","booktool_print")+"</a></p>")}var f=/^page-mod-.*-mod$/,g=f.test($("body").attr("id"))&&location.href.indexOf("modedit")>-1,h="page-course-edit"===$("body").attr("id"),i="page-course-editsection"===$("body").attr("id");if(g||h||i){var j=[":first","#page-course-edit #id_descriptionhdr","#id_contentsection","#id_general + #id_general","#id_content","#page-mod-choice-mod #id_optionhdr","#page-mod-assign-mod #id_availability","#page-mod-assign-mod #id_submissiontypes","#page-mod-workshop-mod #id_gradingsettings","#page-mod-choicegroup-mod #id_miscellaneoussettingshdr","#page-mod-choicegroup-mod #id_groups","#page-mod-scorm-mod #id_packagehdr"];j=j.join(),$("#mform1 > fieldset").not(j).wrapAll('<div class="snap-form-advanced col-md-4" />'),$(".snap-form-advanced").append($(".collapsible-actions"));for(var k=$("#mform1 fieldset:first"),l=$("#mform1 fieldset:first .fcontainer"),m=$("#mform1 > fieldset").not("#mform1 > fieldset:first"),n=0;n<m.length;n++){var o=$(m[n]).find(".fcontainer");$(l).append(o),$(m[n]).remove()}$(k).wrap('<div class="snap-form-required col-md-8" />');var p=$("#mform1 fieldset:first .fitem_feditor:not(.required)");if(g&&p){var q="page-mod-assign-mod"==$("body").attr("id"),r="page-mod-choice-mod"==$("body").attr("id"),s="page-mod-turnitintool-mod"==$("body").attr("id"),t="page-mod-workshop-mod"==$("body").attr("id");r||q||s||t||($(l).append(p),$(l).append($("#fitem_id_showdescription")))}var u=$("#mform1 #fgroup_id_buttonar");$(k).append(u)}$(window).on("load",function(){$("body").addClass("snap-js-loaded"),responsiveVideo.apply()})})}}});