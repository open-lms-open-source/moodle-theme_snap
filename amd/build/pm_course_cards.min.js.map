{"version":3,"sources":["../src/pm_course_cards.js"],"names":["define","$","log","templates","courseFavorites","mview","ajaxNotify","util","appear","CourseCards","self","applyCourseInfo","crsinfo","render","done","i","info","debug","course","cardEl","trigger","reqCourseInfo","courseids","length","courseiddata","join","courseInfoKey","M","cfg","sesskey","ajax","type","async","url","wwwroot","context","data","success","ifErrorShowBestMsg","errorShown","supportsSessionStorage","window","sessionStorage","JSON","stringify","warn","getCourseIds","courseIds","each","push","attr","applyAppearForImages","document","body","on","e","appeared","imgurl","card","trim","css","whichAnimationEvent","t","el","createElement","res","animations","style","selector","addEventListener","force_appear","appeartopoffset","appearleftoffset","init","ready","courseinfo","parse","target","closest","open","preventDefault"],"mappings":"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","sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package   theme_snap\n * @copyright Copyright (c) 2016 Blackboard Inc. (http://www.blackboard.com)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Personal menu course cards.\n */\ndefine(['jquery', 'core/log', 'core/templates', 'theme_snap/pm_course_favorites',\n    'theme_snap/model_view', 'theme_snap/ajax_notification', 'theme_snap/util',\n    'theme_snap/appear'],\n    function($, log, templates, courseFavorites, mview, ajaxNotify, util, appear) {\n\n        var CourseCards = function() {\n\n            var self = this;\n\n            /**\n             * Apply course information to courses in personal menu.\n             *\n             * @param {Array} crsinfo\n             */\n            this.applyCourseInfo = function(crsinfo) {\n                // Pre-load template or it will get loaded multiple times with a detriment on performance.\n                templates.render('theme_snap/course_cards', [])\n                    .done(function() {\n                        for (var i in crsinfo) {\n                            var info = crsinfo[i];\n                            log.debug('applying course data for courseid ' + info.course);\n                            var cardEl = $('.coursecard[data-courseid=\"' + info.course + '\"]');\n                            mview(cardEl, 'theme_snap/course_cards');\n                            $(cardEl).trigger('modelUpdate', info);\n                        }\n                    });\n            };\n\n            /**\n             * Request courseids.\n             * @param {number[]} courseids\n             */\n            this.reqCourseInfo = function(courseids) {\n                if (courseids.length === 0) {\n                    return;\n                }\n                // Get course info via ajax.\n                var courseiddata = 'courseids=' + courseids.join(',');\n                var courseInfoKey = M.cfg.sesskey + 'coursecard';\n                log.debug(\"fetching course data\");\n                $.ajax({\n                    type: \"GET\",\n                    async: true,\n                    url: M.cfg.wwwroot + '/theme/snap/rest.php?action=get_courseinfo&contextid=' + M.cfg.context,\n                    data: courseiddata,\n                    success: function(data) {\n                        ajaxNotify.ifErrorShowBestMsg(data).done(function(errorShown) {\n                            if (errorShown) {\n                                return;\n                            } else {\n                                // No errors, apply course info.\n                                if (data.info) {\n                                    log.debug('fetched coursedata', data.info);\n                                    if (util.supportsSessionStorage()) {\n                                        window.sessionStorage[courseInfoKey] = JSON.stringify(data.info);\n                                    }\n                                    self.applyCourseInfo(data.info);\n                                } else {\n                                    log.warn('fetched coursedata with error: JSON data object is missing info property', data);\n                                }\n                            }\n                        });\n                    }\n                });\n            };\n\n            /**\n             * Get course ids from cards.\n             * @returns {Array}\n             */\n            this.getCourseIds = function() {\n                var courseIds = [];\n                $('.coursecard').each(function() {\n                    courseIds.push($(this).attr('data-courseid'));\n                });\n                return courseIds;\n            };\n\n            this.applyAppearForImages = function() {\n                appear(document.body).on('appear', '.coursecard', function(e, appeared) {\n                    appeared.each(function() {\n                        var imgurl = $(this).data('image-url');\n                        if (imgurl !== undefined) {\n                            var card = $(this);\n                            // We use a fake image element to track the loading of the image so we can insert the\n                            // background image once the image is loaded. If we didn't do this then we'd see a flicker\n                            // from the course card gradient to the main brand colour before the image loaded.\n                            $('<img src=\"' + imgurl.trim() + '\" />').on('load', function() {\n                                $(card).css('background-image', 'url(' + imgurl.trim() + ')');\n                            });\n                        }\n                    });\n                });\n\n                /**\n                 * Detect when animation is completed.\n                 * https://davidwalsh.name/css-animation-callback\n                 * @returns {string}\n                 */\n                function whichAnimationEvent() {\n                    var t;\n                    var el = document.createElement('fakeelement');\n                    var res = 'Animationend';\n                    var animations = {\n                        'Animation': 'Animationend',\n                        'OAnimation': 'oAnimationEnd',\n                        'MozAnimation': 'Animationend',\n                        'WebkitAnimation': 'webkitAnimationEnd'\n                    };\n\n                    for (t in animations) {\n                        if (el.style[t] !== undefined) {\n                            res = animations[t];\n                            break;\n                        }\n                    }\n                    return res; // Adding a default return value.\n                }\n\n                // When the course archive navigation elements are clicked we need to force appear to check for\n                // newly visible course cards.\n                $('#snap-pm-courses .nav-tabs .nav-link').on('click', function() {\n                    var selector = $(this).attr('href');\n                    // Note, appear does not play nicely with CSS animations so we are waiting for the animation to\n                    // complete before we force appear to check for newly visible cards.\n                    $(selector)[0].addEventListener(whichAnimationEvent(), function() {\n                        $.force_appear();\n                    }, false);\n                });\n\n                // Appear configuration - start loading images when they are out of the view port by 100px.\n                var appearConf = {appeartopoffset: 100, appearleftoffset: 100};\n                $('.coursecard').appear(appearConf);\n                appear.force_appear();\n            };\n\n            /**\n             * Initialising function.\n             */\n            this.init = function() {\n                $(document).ready(function() {\n                    courseFavorites();\n\n                    // Load course information via ajax.\n                    var courseIds = self.getCourseIds();\n                    var courseInfoKey = M.cfg.sesskey + 'coursecard';\n                    if (courseIds.length > 0) {\n                        self.applyAppearForImages();\n                        // OK - lets see if we have grades/progress in session storage.\n                        if (util.supportsSessionStorage() && window.sessionStorage[courseInfoKey]) {\n                            var courseinfo = JSON.parse(window.sessionStorage[courseInfoKey]);\n                            self.applyCourseInfo(courseinfo);\n                        } else {\n                            // Only make AJAX request on document ready if the session storage isn't populated.\n                            self.reqCourseInfo(courseIds);\n                        }\n                    }\n                });\n\n                // Personal menu course card clickable.\n                $(document).on('click', '.coursecard[data-href]', function(e) {\n                    var trigger = $(e.target),\n                        hreftarget = '_self';\n                    // Excludes any clicks in the card deeplinks.\n                    if (!$(trigger).closest('a').length) {\n                        window.open($(this).data('href'), hreftarget);\n                        e.preventDefault();\n                    }\n                });\n            };\n\n        };\n\n        return new CourseCards();\n    }\n);\n"],"file":"pm_course_cards.min.js"}