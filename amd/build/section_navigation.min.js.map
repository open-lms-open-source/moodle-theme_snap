{"version":3,"file":"section_navigation.min.js","sources":["../src/section_navigation.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Section navigation component.\n *\n * @module     theme_snap/section_navigation\n * @copyright Copyright (c) 2025 Open LMS (https://www.openlms.net)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport BaseComponent from 'core_courseformat/local/content';\nimport {getCurrentCourseEditor} from 'core_courseformat/courseeditor';\n\nexport default class SectionNavigation extends BaseComponent {\n    static instances = new Map();\n\n    create(descriptor) {\n        super.create(descriptor);\n\n        this.sectionId = descriptor.sectionId;\n        this.navigationButtons = {\n            previous: null,\n            next: null,\n        };\n\n        this.selectors = {\n            SECTION: `.course-content ul.sections > li[data-id=\"${this.sectionId}\"]`,\n            PREVIOUS: `.section_footer .previous_section`,\n            NEXT: `.section_footer .next_section`,\n            TITLE: `.nav_title`,\n            ICON: `i[section-number]`,\n\n        };\n\n        this.classes = {\n            DISABLED: `disabled`,\n        };\n\n        this.attributes = {\n            SECTION_NUMBER: `section-number`\n        };\n    }\n\n    stateReady(state) {\n        this.section = state.section.get(this.sectionId);\n    }\n\n    static init(target, sectionId) {\n        const element = document.querySelector(target);\n        if (!element) {\n            return null;\n        }\n        let instance = null;\n        if (SectionNavigation.instances.has(sectionId)) {\n            instance = SectionNavigation.instances.get(sectionId);\n        } else {\n            instance = new this({\n                element,\n                reactive: getCurrentCourseEditor(),\n                sectionId: sectionId,\n            });\n            SectionNavigation.instances.set(sectionId, instance);\n        }\n        return instance;\n    }\n\n    getWatchers() {\n        return [\n            { watch: `course.sectionlist:updated`, handler: this._sectionNavigationUpdate },\n            { watch: `section.cmlist:updated`, handler: this._subsectionNavigationUpdate },\n        ];\n    }\n\n    /**\n     * Handles navigation updates when editing a subsection, triggered when cmlist mutates.\n     *\n     *  @param {Object} param0 - Object containing the DOM element.\n     *  @param {HTMLElement} param0.element - The element representing the current section/subsection.\n     * @private\n     */\n    _subsectionNavigationUpdate({element}) {\n        if (!this.reactive.isEditing) {\n            return;\n        }\n\n        const currentSectionId = this.sectionId;\n\n        const parentsectionid = this.reactive.state.section.get(currentSectionId).parentsectionid;\n        if (parentsectionid === null) {\n            return;\n        }\n\n        const sectionsMap = new Map(\n            [...this.reactive.state.section].filter(([, value]) => {\n                return value.component !== null && value.parentsectionid == parentsectionid;\n            })\n        );\n\n        let subsectionMap = this._getCmToSubsectionMapBySectionId(element);\n        const sections = element.cmlist\n            .filter(cmid => subsectionMap.has(cmid))\n            .map(cmid => subsectionMap.get(cmid));\n\n        this._updateNavigation(sections, sectionsMap, currentSectionId);\n    }\n\n    /**\n     * Handles navigation updates between main course sections (not subsections), triggered when sectionlist mutates.\n     *\n     * @param {Object} param0 - Object containing the DOM element.\n     * @param {HTMLElement} param0.element - The element representing the section list container.\n     * @private\n     */\n    _sectionNavigationUpdate({ element }) {\n        if (!this.reactive.isEditing){\n            return;\n        }\n        const currentSectionId = this.sectionId;\n\n        const parentsectionid = this.reactive.state.section.get(currentSectionId).component;\n        if (parentsectionid !== null) {\n            return;\n        }\n\n        const sectionsMap = new Map(\n            [...this.reactive.state.section].filter(([, value]) => value.component === null)\n        );\n\n\n        this._updateNavigation(element.sectionlist, sectionsMap, currentSectionId);\n    }\n\n    /**\n     * Updates the navigation state (previous/next) and triggers button rendering.\n     *\n     * @param {Array<string>} sections - Ordered list of section or subsection IDs.\n     * @param {Map<string, Object>} sectionsMap - Map of section IDs to their section data.\n     * @param {string|number} currentSectionId - The currently active section ID.\n     *\n     * @private\n     */\n    _updateNavigation(sections, sectionsMap, currentSectionId) {\n        const { previous, next } = this._getNextAndPrevious(sections, sectionsMap, currentSectionId);\n        this.navigationButtons = { previous, next };\n        this.renderNavigationButtons();\n    }\n\n    /**\n     * Determines the previous and next items based on the current section ID.\n     *\n     * @param {Array<string>} sections - Ordered array of section or subsection IDs.\n     * @param {Map<string, Object>} sectionsMap - Map linking section IDs to section data.\n     * @param {string|number} currentSection - The current section ID.\n     * @returns {{ previous: Object|null, next: Object|null }} Object containing previous and next section data.\n     *\n     * @private\n     */\n    _getNextAndPrevious(sections, sectionsMap, currentSection) {\n        const index = sections.indexOf(String(currentSection));\n        if (index === -1) {\n            return { previous: null, next: null };\n        }\n\n        const previousId = index > 0 ? sections[index - 1] : null;\n        const nextId = index < sections.length - 1 ? sections[index + 1] : null;\n\n        const previous = previousId && sectionsMap.has(previousId) ? sectionsMap.get(previousId) : null;\n        const next = nextId && sectionsMap.has(nextId) ? sectionsMap.get(nextId) : null;\n\n        return { previous, next };\n    }\n\n    /**\n     * Renders navigation buttons based on the current navigation state.\n     * Updates button attributes, section numbers, and titles.\n     * Buttons are always present in the DOM but toggled via the \"disabled\" class.\n     *\n     * @private\n     */\n    renderNavigationButtons() {\n        const { previous, next } = this.navigationButtons;\n\n        const renderButton = (btnElement, data) => {\n            if (!btnElement) {\n                return;\n            }\n\n            const titleEl = btnElement.querySelector(this.selectors.TITLE);\n            const iconEl = btnElement.querySelector(this.selectors.ICON);\n\n            if (data) {\n                btnElement.classList.remove(this.classes.DISABLED);\n                btnElement.setAttribute(this.attributes.SECTION_NUMBER, data.number);\n                btnElement.setAttribute('href', data.sectionurl || '#');\n\n                if (iconEl) {\n                    iconEl.setAttribute(this.attributes.SECTION_NUMBER, data.number);\n                }\n                if (titleEl) {\n                    titleEl.textContent = data.title || '';\n                    titleEl.setAttribute('aria-label', data.title || '');\n                    titleEl.setAttribute('title', data.title || '');\n                }\n            } else {\n                btnElement.classList.add(this.classes.DISABLED);\n                btnElement.removeAttribute('href');\n                btnElement.setAttribute(this.attributes.SECTION_NUMBER, '');\n                if (titleEl) {\n                    titleEl.textContent = '';\n                    titleEl.removeAttribute('aria-label');\n                    titleEl.removeAttribute('title');\n                }\n            }\n        };\n\n        renderButton(this.element.querySelector(this.selectors.PREVIOUS), previous);\n        renderButton(this.element.querySelector(this.selectors.NEXT), next);\n\n        const sectionEl = document.querySelector(this.selectors.SECTION);\n        if (sectionEl) {\n            // The code that displays the sections already loaded does so based on the section number.\n            // When sections are moved, this number changes, so this ID must be updated.\n            sectionEl.setAttribute('id', `section-${this.section.number}`);\n        }\n    }\n\n    /**\n     * Returns a Map of cmid and subsectionid for a given section.\n     *\n     * @param {Object} section - The parent section.\n     * @returns {Map<string, string>} A Map where keys are cmids and values are subsection ids.\n     */\n    _getCmToSubsectionMapBySectionId(section) {\n        const result = new Map();\n        const cmIds = section.cmlist;\n        const cmState = this.reactive.state.cm;\n\n        if (!cmIds || !Array.isArray(cmIds)) {\n            return result;\n        }\n\n        for (const cmid of cmIds) {\n            const cm = cmState.get(cmid);\n\n            if (!cm) {\n                continue;\n            }\n            if (cm.delegatesectionid === undefined || cm.delegatesectionid === null) {\n                continue;\n            }\n\n            result.set(cmid, cm.delegatesectionid);\n        }\n        return result;\n    }\n}\n"],"names":["SectionNavigation","BaseComponent","create","descriptor","sectionId","navigationButtons","previous","next","selectors","SECTION","this","PREVIOUS","NEXT","TITLE","ICON","classes","DISABLED","attributes","SECTION_NUMBER","stateReady","state","section","get","target","element","document","querySelector","instance","instances","has","reactive","set","getWatchers","watch","handler","_sectionNavigationUpdate","_subsectionNavigationUpdate","isEditing","currentSectionId","parentsectionid","sectionsMap","Map","filter","_ref2","value","component","subsectionMap","_getCmToSubsectionMapBySectionId","sections","cmlist","cmid","map","_updateNavigation","_ref4","sectionlist","_getNextAndPrevious","renderNavigationButtons","currentSection","index","indexOf","String","previousId","nextId","length","renderButton","btnElement","data","titleEl","iconEl","classList","remove","setAttribute","number","sectionurl","textContent","title","add","removeAttribute","sectionEl","result","cmIds","cmState","cm","Array","isArray","undefined","delegatesectionid"],"mappings":"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"}