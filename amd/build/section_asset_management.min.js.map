{"version":3,"file":"section_asset_management.min.js","sources":["../src/section_asset_management.js"],"sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package\n * @copyright Copyright (c) 2015 Open LMS (https://www.openlms.net)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(\n    [\n        'jquery',\n        'core/log',\n        'core/ajax',\n        'core/str',\n        'core/templates',\n        'core/notification',\n        'theme_snap/util',\n        'theme_snap/ajax_notification',\n        'core_filters/events',\n        'core/fragment',\n        'core_courseformat/local/content/actions',\n        'core_courseformat/courseeditor',\n    ],\n    function(\n        $,\n        log,\n        ajax,\n        str,\n        templates,\n        notification,\n        util, ajaxNotify,\n        Event,\n        fragment,\n        Actions,\n        CourseEditor,\n    ) {\n\n        var self = this;\n\n\n        /**\n         * Sections that are being retrieved by the API.\n         * @type {Array}\n         */\n        var sectionsProcess = [];\n\n        /**\n         * Sets observers for the TOC drawer elements.\n         */\n        var setTocObservers = function() {\n            if (self.courseConfig.format == 'weeks' || self.courseConfig.format == 'topics') {\n                $('#toc-searchables li a').click(function(e) {\n                    var link = $(e.target);\n                    var urlParams = link.attr('href').split(\"&\"),\n                        section = urlParams[0],\n                        mod = urlParams[1] || null;\n                    section = section.split('#section-')[1];\n                    getSection(section, mod);\n                });\n            }\n        };\n\n        /**\n         * Sets observers for the TOC and Footer navigation trough sections.\n         */\n        var setNavigationObservers = function() {\n            if (self.courseConfig.format == 'weeks' || self.courseConfig.format == 'topics') {\n                var selectors = [\n                    '.section_footer a.next_section',\n                    '.section_footer a.previous_section',\n                    '#courseindex-content .courseindex-section-title a.courseindex-link' // For course index links.\n                ];\n                $(selectors.join(', ')).click(function(e) {\n                    var link = $(this);\n                    var section = link.attr('section-number');\n                    // For TOC, section number resides on parent div.\n                    if (!section) {\n                        // Avoid running Behat, as it behaves randomly in Gitlab.\n                        if (M.cfg.behatsiterunning) {\n                            return;\n                        }\n                        section = link.closest('.courseindex-section').attr('data-number');\n                    }\n                    if (typeof section !== 'undefined' && section.length > 0) {\n                        e.preventDefault();\n                        self.courseConfig.sectionnum = parseInt(section);\n                        getSection(section, 0);\n                    }\n                });\n            }\n        };\n        const setCmActionsObservers = function() {\n            const selector = '.action-menu a[data-action],' +\n                '.section-actions a[data-action],' +\n                '[data-action=\"newModule\"].section-modchooser-link';\n\n            const sections = document.querySelector('ul.sections');\n            if (sections) {\n                sections.addEventListener('click', function(e) {\n                    const actionLink = e.target.closest(selector);\n                    if (!actionLink) {\n                        return; // Do nothing.\n                    }\n                    let actionName = actionLink.dataset.action;\n\n                    // Check if we are clicking on action button, permalink & update had another observers.\n                    if (actionName === 'permalink' || actionName === 'update') {\n                        return; // Do nothing.\n                    }\n                    e.preventDefault();\n                    e.stopPropagation();\n\n                    const reactiveCourseEditor = CourseEditor.getCurrentCourseEditor();\n                    // In topics format we need to initialize the reactive component for highlight sections.\n                    if (self.courseConfig.format == 'topics') {\n                        require(\n                            ['format_topics/section',], function(SectionModule) {\n                                let editMode = reactiveCourseEditor.isEditing;\n                                // We need editing mode On, so topics module is initialized properly.\n                                reactiveCourseEditor._editing = true;\n                                SectionModule.init();\n                                reactiveCourseEditor._editing = editMode;\n                            }\n                        );\n                    }\n                    // Init observers for other section and modules actions.\n                    const actions = new Actions.prototype.constructor({\n                        element: actionLink,\n                        reactive: reactiveCourseEditor\n                    });\n                    // Handle the action.\n                    if (typeof actions._dispatchClick === 'function') {\n                        actions._dispatchClick(e);\n                    }\n                }, {capture: true});\n            }\n        };\n\n        /**\n         * Scroll to a mod via search.\n         * @param {string} modid\n         */\n        var scrollToModule = function(modid) {\n            // Sometimes we have a hash, sometimes we don't.\n            // Strip hash then add just in case.\n            $('#toc-search-results').html('');\n            var targmod = $(\"#\" + modid.replace('#', ''));\n            // http://stackoverflow.com/questions/6677035/jquery-scroll-to-element\n            util.scrollToElement(targmod);\n\n            var searchpin = $(\"#searchpin\");\n            if (!searchpin.length) {\n                searchpin = $('<i id=\"searchpin\"></i>');\n            }\n\n            $(targmod).find('.instancename').prepend(searchpin);\n            $(targmod).attr('tabindex', '-1').focus();\n        };\n\n        /**\n         * Gets a specific section for the current course and if an activity module is passed sets focus on it.\n         * @param {string} section\n         * @param {string} mod\n         */\n        var getSection = function(section, mod) {\n            var node = $('ul.sections > #section-' + section);\n            if (node.length == 0 && sectionsProcess.indexOf(section) == -1) {\n                sectionsProcess.push(section);\n                var params = {courseid: self.courseConfig.id, section: section};\n                $('.sk-fading-circle').show();\n                // We need to prevent the DOM to show the default section.\n                $('.course-content .' + self.courseConfig.format + 'ul.sections > li[id^=\"section-\"]').hide();\n                fragment.loadFragment('theme_snap', 'section', self.courseConfig.contextid, params).done(function(html, js) {\n                    var node = $(html);\n                    renderSection(section, node, mod, js);\n\n                    var folders = node.find('li.snap-activity.modtype_folder');\n                    $.each(folders, function (index, folder) {\n                        var content = $(folder).find('div.contentwithoutlink div.snap-assettype');\n                        if (content.length > 0) {\n                            if ($(folder).find('div.activityinstance div.snap-header-card .asset-type').length == 0) {\n                                var folderAssetTypeHeader = $(folder).find('div.activityinstance div.snap-header-card');\n                                content.prependTo(folderAssetTypeHeader);\n                            }\n                        }\n                    });\n                });\n            } else {\n                $(window).trigger('hashchange');\n            }\n        };\n\n        /**\n         * This functions inserts a section node to the DOM.\n         * @param {string} section\n         * @param {node} html\n         * @param {string} mod\n         * @param {string} js\n         */\n        var renderSection = function(section, html, mod, js) {\n            var anchor = $('.course-content');\n            var existingSections = [];\n            anchor.find('ul.sections>li[id^=section-]').each(function() {\n                existingSections.push(parseInt($(this).attr('id').split('section-')[1]));\n            });\n            var tempnode = $('<div></div>');\n            templates.replaceNodeContents(tempnode, html, '');\n\n            if (existingSections.length > 0) {\n                var closest = existingSections.reduce(function(prev, curr) {\n                    return (Math.abs(curr - section) < Math.abs(prev - section) ? curr : prev);\n                });\n\n                if (closest > section) {\n                    anchor.find('ul.sections > #section-' + closest).before(tempnode.contents());\n\n                } else {\n                    anchor.find('ul.sections > #section-' + closest).after(tempnode.contents());\n\n                }\n            } else {\n                $('.sk-fading-circle').after(tempnode);\n            }\n            templates.runTemplateJS(js);\n\n            // Hide loading animation.\n            $('.sk-fading-circle').hide();\n            // Notify filters about the new section.\n            Event.notifyFilterContentUpdated($('.course-content .' + self.courseConfig.format));\n            var sections = anchor.find('ul.sections>li[id^=\"section-\"]');\n            // When not present the section, the first one will be shown as default, remove all classes to prevent that.\n            sections.removeClass('state-visible');\n            var id = 'ul.sections>#section-' + section;\n            $(id).addClass('state-visible');\n            // Leave all course sections as they were.\n            sections.show();\n            setNavigationObservers();\n\n            // Set observer for mod chooser.\n            $(id + ' .section-modchooser-link').click(function() {\n                // Grab the section number from the button.\n                var sectionNum = $(this).attr('data-sectionid');\n                $('.snap-modchooser-addlink').each(function() {\n                    // Update section in mod link to current section.\n                    var newLink = this.href.replace(/(section=)[0-9]+/ig, '$1' + sectionNum);\n                    $(this).attr('href', newLink);\n                });\n            });\n\n            // If a module id has been passed as parameter, set focus.\n            if (mod != 0 && typeof mod !== 'undefined') {\n                scrollToModule(mod);\n            }\n        };\n\n    return {\n        init: function(courseLib) {\n\n            self.courseConfig = courseLib.courseConfig;\n\n            /**\n             * Set observers for TOC and navigation buttons in the footer.\n             */\n            var setCourseSectionObservers = function() {\n                setTocObservers();\n                setNavigationObservers();\n                // Check user is logged in, in order to use CourseEditor.\n                const isLoggedIn = document.querySelector('#snap-header  .usermenu');\n                // Only on course page.\n                const onCoursePage = document.body.classList.contains('path-course-view');\n                if (!isLoggedIn || !onCoursePage) {\n                    return; // If not, do nothing.\n                }\n                // Event listeners for Course modules actions, when editing is off.\n                const reactiveCourseEditor = CourseEditor.getCurrentCourseEditor();\n                if (!reactiveCourseEditor.isEditing) {\n                    setCmActionsObservers();\n                }\n            };\n\n            /**\n             * Add listeners.\n             */\n            var addListeners = function() {\n                setCourseSectionObservers();\n                $('body').addClass('snap-course-listening');\n            };\n\n            /**\n             * Override core functions.\n             */\n            var overrideCore = function() {\n                // Check M.course exists (doesn't exist in social format).\n                if (M.course && M.course.resource_toolbox) {\n                    /* eslint-disable camelcase */\n                    M.course.resource_toolbox.handle_resource_dim = function(button, activity, action) {\n                        return (action === 'hide') ? 0 : 1;\n                    };\n                    /* eslint-enable camelcase */\n                }\n            };\n\n            /**\n             * Initialise script.\n             */\n            var initialise = function() {\n                // Add listeners.\n                addListeners();\n\n                // Override core functions\n                util.whenTrue(function() {\n                    return M.course && M.course.init_section_toolbox;\n                }, function() {\n                    overrideCore();\n                    }, true);\n\n            };\n            initialise();\n        },\n\n        /**\n         * Exposed function that renders a specific course section and sets focus on an activity module.\n         * @param {string} section\n         * @param {string} mod\n         */\n        renderAndFocusSection: function(section, mod) {\n            getSection(section, mod);\n        },\n\n        /**\n         * Exposed function so observers can be set on TOC.\n         */\n        setNavigationObservers: function() {\n            setNavigationObservers();\n        }\n    };\n\n});\n"],"names":["define","$","log","ajax","str","templates","notification","util","ajaxNotify","Event","fragment","Actions","CourseEditor","self","this","sectionsProcess","setNavigationObservers","courseConfig","format","join","click","e","link","section","attr","M","cfg","behatsiterunning","closest","length","preventDefault","sectionnum","parseInt","getSection","mod","indexOf","push","params","courseid","id","show","hide","loadFragment","contextid","done","html","js","node","renderSection","folders","find","each","index","folder","content","folderAssetTypeHeader","prependTo","window","trigger","anchor","existingSections","split","tempnode","replaceNodeContents","reduce","prev","curr","Math","abs","before","contents","after","runTemplateJS","notifyFilterContentUpdated","sections","removeClass","addClass","sectionNum","newLink","href","replace","modid","targmod","scrollToElement","searchpin","prepend","focus","scrollToModule","init","courseLib","setCourseSectionObservers","urlParams","target","isLoggedIn","document","querySelector","onCoursePage","body","classList","contains","getCurrentCourseEditor","isEditing","addEventListener","actionLink","actionName","dataset","action","stopPropagation","reactiveCourseEditor","require","SectionModule","editMode","_editing","actions","prototype","constructor","element","reactive","_dispatchClick","capture","setCmActionsObservers","whenTrue","course","init_section_toolbox","resource_toolbox","handle_resource_dim","button","activity","renderAndFocusSection"],"mappings":"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"}