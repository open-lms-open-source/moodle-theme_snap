{"version":3,"sources":["../src/section_asset_management.js"],"names":["define","$","log","ajax","str","templates","notification","util","ajaxNotify","footerAlert","Event","fragment","self","movingObjects","movingObject","ajaxing","ajaxTracker","sectionsProcess","moduleCache","progressCache","setTocObservers","courseConfig","format","click","e","link","target","section","attr","length","getSection","split","urlParams","mod","setNavigationFooterObservers","node","find","scrollToModule","modid","html","targmod","replace","scrollToElement","searchpin","prepend","focus","removeClass","updateMovingMessage","title","assetname","M","get_string","setTitle","updateSectionDropMsg","sectionName","each","sectionDropMsg","moving","before","data","setSrNotice","indexOf","push","params","courseid","id","show","hide","loadFragment","contextid","done","js","renderSection","folders","index","folder","content","folderAssetTypeHeader","prependTo","replaceWith","text","anchor","existingSections","parseInt","tempnode","replaceNodeContents","appendTo","prevAll","remove","closest","reduce","prev","curr","Math","abs","after","runTemplateJS","notifyFilterContentUpdated","sections","addClass","toctype","elements","tmpid","key","element","sectionNum","newLink","href","movingId","parent","append","init","courseLib","AjaxTracker","triggersByKey","start","jsPendingKey","trigger","subSelector","debug","js_pending","pending_js","complete","js_complete","sectionNumber","el","partialrender","parentSectionNumber","parents","stopMoving","hideAndReset","removeAttr","moveFailed","actname","removeAjaxLoading","window","setTimeout","removeMovingObject","obj","splice","ajaxReqMoveGeneral","onSuccess","finalItem","addAjaxLoading","sesskey","cfg","courseId","field","req","type","async","url","wwwroot","ajaxurl","ifErrorShowBestMsg","errorShown","class","fail","always","getSectionTitle","updateSectionNavigation","selector","dfd","Deferred","totalSectionCount","allSections","completed","idx","previousSection","nextSection","previous","next","hidden","extraclasses","hasClass","classes","navigation","render","result","resolve","promise","calculateSections","oldIndex","newIndex","k","updateSections","current","predeleteSections","deletedSection","loadedSections","newOrder","value","chapterTitle","fullTitle","setCourseSectionObervers","sectionDelete","preventDefault","doDelete","delProgress","courseshortname","shortname","action","sectionnumber","loadmodules","ajaxPromises","call","methodname","args","response","toc","document","chapters","ids","location","hash","showSection","delTitle","delConf","ok","cancel","confirm","assetAction","triggerEl","assetEl","cmid","instanceName","trim","errActionKey","errMessageKey","errAction","errMessage","actionAJAX","getErrorStrings","get_strings","component","then","strings","plugindata","match","name","ajaxReqMoveAsset","shift","beforeId","body","sectionId","ajaxReqMoveSection","dropzone","domTargetSection","currentSection","targetSection","assetEditListeners","actionSelectors","on","sectionActionListener","onComplete","stopPropagation","InvalidActionException","message","toggle","loadModules","actionSelector","actionmodel","modules","progressCacheCopy","slice","progress","completion","highlightSectionListener","toggleClass","$notCurrent","not","highlighter","deleteSectionListener","toggleSectionListener","manageHiddenClass","join","footerAlertShowMove","moveSectionListener","addAfterDrops","assetMoveListener","asset","afterdrop","regex","assetclasses","exec","prop","movePlaceListener","addListeners","overrideCore","course","resource_toolbox","handle_resource_dim","button","activity","cacheTOC","initialise","whenTrue","init_section_toolbox","renderAndFocusSection","setTocObserver"],"mappings":"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","sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package   theme_snap\n * @copyright Copyright (c) 2015 Blackboard Inc. (http://www.blackboard.com)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/log', 'core/ajax', 'core/str', 'core/templates', 'core/notification',\n    'theme_snap/util', 'theme_snap/ajax_notification', 'theme_snap/footer_alert',\n    'core/event', 'core/fragment'],\n    function($, log, ajax, str, templates, notification, util, ajaxNotify, footerAlert, Event, fragment) {\n\n        var self = this;\n\n        /**\n         * Items being moved - actual dom elements.\n         * @type {array}\n         */\n        var movingObjects = [];\n\n        /**\n         * Item being moved - actual dom element.\n         * @type {object}\n         */\n        var movingObject;\n\n        /**\n         * @type {boolean}\n         */\n        var ajaxing = false;\n\n        var ajaxTracker;\n\n        /**\n         * Sections that are being retrieved by the API.\n         * @type {Array}\n         */\n        var sectionsProcess = [];\n\n        /**\n         * Module html caching.\n         * @type {object|null}\n         */\n        var moduleCache = null;\n\n        /**\n         * Progress caching.\n         * @type {Array|null}\n         */\n        var progressCache = null;\n\n        /**\n         * Sets observers for the TOC elements.\n         */\n        var setTocObservers = function () {\n            if (self.courseConfig.format == 'weeks' || self.courseConfig.format == 'topics') {\n                $('#course-toc .chapter-title').click(function(e) {\n                    var link = $(e.target);\n                    var section = link.attr('href');\n                    if (typeof section != 'undefined' && section.length > 0) {\n                        getSection(section.split('#section-')[1], 0);\n                    }\n                });\n\n                $('#toc-searchables li a').click(function(e) {\n                    var link = $(e.target);\n                    var urlParams = link.attr('href').split(\"&\"),\n                        section = urlParams[0],\n                        mod = urlParams[1] || null;\n                    section = section.split('#section-')[1];\n                    getSection(section, mod);\n                });\n            }\n        };\n\n        /**\n         * Sets observers for the navigation arrows.\n         */\n        var setNavigationFooterObservers = function () {\n            if (self.courseConfig.format == 'weeks' || self.courseConfig.format == 'topics') {\n                $('.section_footer .next_section, .section_footer .icon-arrow-right, ' +\n                    '.section_footer .previous_section, .section_footer .icon-arrow-left').click(function(e) {\n                    var link = $(e.target);\n                    var section = link.attr('section-number');\n                    if(typeof section !== 'undefined' && section.length > 0) {\n                        getSection(section, 0);\n                    }\n                });\n\n                $('.section_footer .text').click(function (e) {\n                    var node = $(e.target);\n                    var section = node.find('.nav_guide').attr('section-number');\n                    if(typeof section !== 'undefined' && section.length > 0) {\n                        getSection(section, 0);\n                    }\n                });\n            }\n        };\n\n        /**\n         * Scroll to a mod via search.\n         * @param {string} modid\n         */\n        var scrollToModule = function(modid) {\n            // Sometimes we have a hash, sometimes we don't.\n            // Strip hash then add just in case.\n            $('#toc-search-results').html('');\n            var targmod = $(\"#\" + modid.replace('#', ''));\n            // http://stackoverflow.com/questions/6677035/jquery-scroll-to-element\n            util.scrollToElement(targmod);\n\n            var searchpin = $(\"#searchpin\");\n            if (!searchpin.length) {\n                searchpin = $('<i id=\"searchpin\"></i>');\n            }\n\n            $(targmod).find('.instancename').prepend(searchpin);\n            $(targmod).attr('tabindex', '-1').focus();\n            $('#course-toc').removeClass('state-visible');\n        };\n\n        /**\n         * Update moving message.\n         */\n        var updateMovingMessage = function() {\n            var title;\n            if (movingObjects.length === 1) {\n                var assetname = $(movingObjects[0]).find('.snap-asset-link .instancename').html();\n                assetname = assetname || M.util.get_string('pluginname', 'label', assetname);\n                title = M.util.get_string('moving', 'theme_snap', assetname);\n            } else {\n                title = M.util.get_string('movingcount', 'theme_snap', movingObjects.length);\n            }\n            footerAlert.setTitle(title);\n        };\n\n        /**\n         * Updates the drop zone with a descriptive text.\n         * @param sectionName\n         */\n        var updateSectionDropMsg = function (sectionName) {\n            if (typeof movingObjects !== 'undefined' && movingObjects.length > 0) {\n                $('.section-drop').each(function() {\n                    var sectionDropMsg = M.util.get_string('movingdropsectionhelp', 'theme_snap',\n                        {moving: sectionName, before: $(this).data('title')}\n                    );\n                    $(this).html(sectionDropMsg);\n                });\n                footerAlert.setSrNotice(M.util.get_string('movingstartedhelp', 'theme_snap', sectionName));\n\n            }\n        };\n\n        /**\n         * Gets a specific section for the current course and if an activity module is passed sets focus on it.\n         * @param section\n         * @param mod\n         */\n        var getSection = function (section, mod) {\n            var node = $('#section-' + section);\n            if (node.length == 0 && sectionsProcess.indexOf(section) == -1) {\n                sectionsProcess.push(section);\n                var params = {courseid: self.courseConfig.id, section: section};\n                $('.sk-fading-circle').show();\n                // We need to prevent the DOM to show the default section.\n                $('.course-content .' + self.courseConfig.format + ' li[id^=\"section-\"]').hide();\n                fragment.loadFragment('theme_snap', 'section', self.courseConfig.contextid, params).done(function(html, js) {\n                    var node = $(html);\n                    renderSection(section, node, mod, js);\n\n                    var folders = node.find('li.snap-activity.modtype_folder');\n                    $.each(folders, function (index, folder) {\n                        var content = $(folder).find('div.contentwithoutlink div.snap-assettype');\n                        if (content.length > 0) {\n                            if ($(folder).find('div.activityinstance div.snap-header-card .asset-type').length == 0) {\n                                var folderAssetTypeHeader = $(folder).find('div.activityinstance div.snap-header-card');\n                                content.prependTo(folderAssetTypeHeader);\n                            }\n                        }\n                    });\n                    // Modify Folder tree activity with inline content to have a H3 tag and have the same behavior that the\n                    // folder with content in a separate page has.\n                    $('#section-' + section + ' li.snap-activity.modtype_folder div[id^=\"folder_tree\"] ' +\n                        '> ul > li > div > span.fp-filename').each(function () {\n                        $(this).replaceWith(\"<h3>\"+$(this).text()+\"</h3>\");\n                    });\n                });\n            }\n        };\n\n        /**\n         * This functions inserts a section node to the DOM.\n         * @param section\n         * @param html\n         * @param mod\n         */\n        var renderSection = function(section, html, mod, js) {\n            var anchor = $('.course-content .' + self.courseConfig.format);\n            var existingSections = [];\n            anchor.find('li[id^=section-]').each(function() {\n                existingSections.push(parseInt($(this).attr('id').split('section-')[1]));\n            });\n            var tempnode = $('<div></div>');\n            templates.replaceNodeContents(tempnode, html, '');\n            // Append resource card fadeout to content resource card.\n            tempnode.find('.snap-resource-long .contentafterlink .snap-resource-card-fadeout').each(function() {\n                $(this).appendTo($(this).prevAll('.snap-resource-long .contentafterlink .no-overflow'));\n            });\n            // Remove from Dom the completion tracking when it is disabled for an activity.\n            tempnode.find('.snap-header-card .snap-header-card-icons .disabled-snap-asset-completion-tracking').remove();\n            if (existingSections.length > 0) {\n                var closest = existingSections.reduce(function(prev, curr) {\n                    return (Math.abs(curr - section) < Math.abs(prev - section) ? curr : prev);\n                });\n\n                if (closest > section) {\n                    anchor.find('#section-' + closest).before(tempnode.find('li[id^=\"section-\"]'));\n\n                } else {\n                    anchor.find('#section-' + closest).after(tempnode.find('li[id^=\"section-\"]'));\n\n                }\n            } else {\n                $('.sk-fading-circle').after(tempnode);\n            }\n            templates.runTemplateJS(js);\n\n            // Hide loading animation.\n            $('.sk-fading-circle').hide();\n            // Notify filters about the new section.\n            Event.notifyFilterContentUpdated($('.course-content .' + self.courseConfig.format));\n            var sections = anchor.find('li[id^=\"section-\"]');\n            // When not present the section, the first one will be shown as default, remove all classes to prevent that.\n            sections.removeClass('state-visible');\n            var id = '#section-' + section;\n            $(id).addClass('state-visible');\n            if (self.courseConfig.toctype == 'top' && self.courseConfig.format == 'topics' && section > 0) {\n                var title = $(id).find('.sectionname').html();\n                var elements = $('.chapter-title');\n                var tmpid = 0;\n                // Find the right toc element.\n                $.each(elements, function(key, element) {\n                    if ($(element).attr('href').split('#section-')[1] == section) {\n                        tmpid = key;\n                    }\n                });\n                $(id).find('.sectionname').html(title);\n                $(id).find('.sectionnumber').html(tmpid + '.');\n            }\n            // Leave all course sections as they were.\n            sections.show();\n            $(id).find('.section_footer .next_section, .section_footer .icon-arrow-right, ' +\n                '.section_footer .previous_section, .section_footer .icon-arrow-left').click(function(e) {\n                var link = $(e.target);\n                var section = link.attr('section-number');\n                if(typeof section !== 'undefined' && section.length > 0) {\n                    getSection(section, 0);\n                }\n            });\n\n            $(id).find('.section_footer .text').click(function (e) {\n                var node = $(e.target);\n                var section = node.find('.nav_guide').attr('section-number');\n                if(typeof section !== 'undefined' && section.length > 0) {\n                    getSection(section, 0);\n                }\n            });\n\n            // Set observer for mod chooser.\n            $(id + ' .section-modchooser-link').click(function() {\n                // Grab the section number from the button.\n                var sectionNum = $(this).attr('data-section');\n                $('.snap-modchooser-addlink').each(function() {\n                    // Update section in mod link to current section.\n                    var newLink = this.href.replace(/(section=)[0-9]+/ig, '$1' + sectionNum);\n                    $(this).attr('href', newLink);\n                });\n            });\n\n            // If a module id has been passed as parameter, set focus.\n            if (mod != 0 && typeof mod !== 'undefined') {\n                scrollToModule(mod);\n            }\n            var sectionName = $('#region-main .section-moving').find('.sectionname').text();\n            if (typeof sectionName !== 'undefined' && sectionName.length > 0) {\n                updateSectionDropMsg(sectionName);\n            }\n\n            var movingId = $('#region-main .section-moving').attr('id');\n            if (typeof movingId !== 'undefined' && movingId.length > 0) {\n                $('#section-' + (parseInt(movingId.split('section-')[1]) + 1) +\n                    ' .snap-drop.section-drop').removeClass('partial-render');\n            }\n\n            $('#course-toc #chapters li').removeClass('snap-visible-section');\n            // Set link as current.\n            $('#course-toc .chapter-title[href=\"#section-'+ section +'\"]').parent('li').addClass('snap-visible-section');\n            $(id).find('ul.section').append(\n                '<li class=\"snap-drop asset-drop\">' +\n                '<div class=\"asset-wrapper\">' +\n                '<a href=\"#\">' +\n                M.util.get_string('movehere', 'theme_snap') +\n                '</a>' +\n                '</div>' +\n                '</li>');\n        };\n\n\n\n    return {\n        init: function(courseLib) {\n\n            self.courseConfig = courseLib.courseConfig;\n\n            /**\n             * AJAX tracker class - for tracking chained AJAX requests (prevents behat intermittent faults).\n             * Also, sets and unsets ajax classes on trigger element / child of trigger if specified.\n             */\n            var AjaxTracker = function() {\n\n                var triggersByKey = {};\n\n                /**\n                 * Starts tracking.\n                 * @param {string} jsPendingKey\n                 * @param {domElement} trigger\n                 * @param {string} subSelector\n                 * @returns {boolean}\n                 */\n                this.start = function(jsPendingKey, trigger, subSelector) {\n                    if (this.ajaxing(jsPendingKey)) {\n                        log.debug('Skipping ajax request for ' + jsPendingKey + ', AJAX already in progress');\n                        return false;\n                    }\n                    M.util.js_pending(jsPendingKey);\n                    triggersByKey[jsPendingKey] = {trigger: trigger, subSelector: subSelector};\n                    if (trigger) {\n                        if (subSelector) {\n                            $(trigger).find(subSelector).addClass('ajaxing');\n                        } else {\n                            $(trigger).addClass('ajaxing');\n                        }\n                    }\n                    return true;\n                };\n\n                /**\n                 * Is there an AJAX request in progress.\n                 * @param {string} jsPendingKey\n                 * @returns {boolean}\n                 */\n                this.ajaxing = function(jsPendingKey) {\n                    return M.util.pending_js.indexOf(jsPendingKey) > -1;\n                };\n\n                /**\n                 * Completes tracking.\n                 * @param {string} jsPendingKey\n                 */\n                this.complete = function(jsPendingKey) {\n                    var trigger, subSelector;\n                    if (triggersByKey[jsPendingKey]) {\n                        trigger = triggersByKey[jsPendingKey].trigger;\n                        subSelector = triggersByKey[jsPendingKey].subSelector;\n                    }\n                    if (trigger) {\n                        if (subSelector) {\n                            $(trigger).find(subSelector).removeClass('ajaxing');\n                        } else {\n                            $(trigger).removeClass('ajaxing');\n                        }\n                    }\n                    delete triggersByKey[jsPendingKey];\n                    M.util.js_complete(jsPendingKey);\n                };\n            };\n\n            ajaxTracker = new AjaxTracker();\n\n            /**\n             * Get the section number from a section element.\n             * @param {jQuery|object} el\n             * @returns {number}\n             */\n            var sectionNumber = function(el) {\n                if (self.courseConfig.partialrender) {\n                    return (parseInt($(el).attr('id').split('section-')[1]));\n                } else {\n                    return (parseInt($(el).attr('id').replace('section-', '')));\n                }\n            };\n\n            /**\n             * Get the section number for an element within a section.\n             * @param {object} el\n             * @returns {number}\n             */\n            var parentSectionNumber = function(el) {\n                return sectionNumber($(el).parents('li.section.main')[0]);\n            };\n\n            /**\n             * Moving has stopped, clean up.\n             */\n            var stopMoving = function() {\n                $('body').removeClass('snap-move-inprogress');\n                $('body').removeClass('snap-move-section');\n                $('body').removeClass('snap-move-asset');\n                footerAlert.hideAndReset();\n                $('.section-moving').removeClass('section-moving');\n                $('.asset-moving').removeClass('asset-moving');\n                $('.snap-asset a').removeAttr('tabindex');\n                $('.snap-asset button').removeAttr('disabled');\n                $('.js-snap-asset-move').removeAttr('checked');\n                movingObjects = [];\n                if (self.courseConfig.partialrender) {\n                    $('.snap-drop.section-drop').addClass('partial-render');\n                }\n            };\n\n            /**\n             * Move fail - sad face :(.\n             */\n            var moveFailed = function() {\n                var actname = $(movingObject).find('.instancename').html();\n\n                footerAlert.removeAjaxLoading();\n                footerAlert.setTitle(M.util.get_string('movefailed', 'theme_snap', actname));\n                // Stop moving in 2 seconds so that the user has time to see the failed moving notice.\n                window.setTimeout(function() {\n                    // Don't pass in target, we want to abort the move!\n                    stopMoving(false);\n                }, 2000);\n            };\n\n            /**\n             * Remove moving object from moving objects array.\n             * @param {object} obj\n             */\n            var removeMovingObject = function(obj) {\n                var index = movingObjects.indexOf(obj);\n                if (index > -1) {\n                    movingObjects.splice(index, 1);\n                }\n                updateMovingMessage();\n            };\n\n            /**\n             * General move request\n             *\n             * @param {object}   params\n             * @param {function} onSuccess\n             * @param {bool}     finalItem\n             */\n            var ajaxReqMoveGeneral = function(params, onSuccess, finalItem) {\n                if (ajaxing) {\n                    // Request already made.\n                    log.debug('Skipping ajax request, one already in progress');\n                    return;\n                }\n\n                // Add spinner.\n                footerAlert.addAjaxLoading();\n\n                // Set common params.\n                params.sesskey = M.cfg.sesskey;\n                params.courseId = courseLib.courseConfig.id;\n                params.field = 'move';\n\n                log.debug('Making course/rest.php request', params);\n                var req = $.ajax({\n                    type: \"POST\",\n                    async: true,\n                    data: params,\n                    url: M.cfg.wwwroot + courseLib.courseConfig.ajaxurl\n                });\n                req.done(function(data) {\n                    ajaxNotify.ifErrorShowBestMsg(data).done(function(errorShown) {\n                        if (errorShown) {\n                            log.debug('Ajax request fail');\n                            moveFailed();\n                            return;\n                        } else {\n                            // No errors, call success callback and stop moving if necessary.\n                            log.debug('Ajax request successful');\n                            if (onSuccess) {\n                                onSuccess();\n                            }\n                            if (finalItem) {\n                                if (params.class === 'resource') {\n                                    // Only stop moving for resources, sections handle this later once the TOC is reloaded.\n                                    stopMoving();\n                                }\n                            }\n                        }\n                    });\n                });\n                req.fail(function() {\n                    moveFailed();\n                });\n\n                if (finalItem) {\n                    req.always(function() {\n                        ajaxing = false;\n                        footerAlert.removeAjaxLoading();\n                    });\n                }\n            };\n\n            /**\n             * Get section title.\n             * @param {integer} section\n             * @returns {*|jQuery}\n             */\n            var getSectionTitle = function(section) {\n                // Get title from TOC.\n                if (self.courseConfig.partialrender) {\n                    return  $('#course-toc #chapters > li a[href=\"#section-' + section + '\"]').text();\n                } else {\n                    return $('#chapters li:nth-of-type(' + (section + 1) + ') .chapter-title').html();\n                }\n            };\n\n            /**\n             * Update next / previous links.\n             * @param {string} selector\n             * @return {promise}\n             */\n            var updateSectionNavigation = function(selector) {\n                var dfd = $.Deferred();\n                var sections, totalSectionCount;\n                if (!selector) {\n                    if (self.courseConfig.partialrender) {\n                        selector = '#course-toc #chapters > li a';\n                    } else {\n                        selector = '#region-main .course-content > ul li.section';\n                    }\n                    sections = $(selector);\n                    totalSectionCount = sections.length;\n                } else {\n                    sections = $(selector);\n                    if (self.courseConfig.partialrender) {\n                        var allSections = $('#course-toc #chapters > li a');\n                    } else {\n                        var allSections = $('#region-main .course-content > ul li.section');\n                    }\n                    totalSectionCount = allSections.length;\n                }\n\n                var completed = 0;\n                $.each(sections, function(idx, el) {\n                    if (self.courseConfig.partialrender) {\n                        var href = $(el).attr('href');\n                        var sectionNum;\n                        if (typeof href !== typeof undefined && href !== false) {\n                            sectionNum = parseInt($(el).attr('href').split('#section-')[1]);\n                        } else {\n                            sectionNum = parseInt($(el).attr('id').split('section-')[1]);\n                        }\n                    } else {\n                        var sectionNum = sectionNumber(el);\n                    }\n                    var previousSection = sectionNum - 1;\n                    var nextSection = sectionNum + 1;\n                    var previous = false;\n                    var next = false;\n                    var hidden, extraclasses;\n                    if (previousSection > -1) {\n                        if (self.courseConfig.partialrender) {\n                            hidden = $('#section-' + previousSection).hasClass('draft');\n                        } else {\n                            hidden = $('#section-' + previousSection).hasClass('hidden');\n                        }\n                        extraclasses = hidden ? ' dimmed_text' : '';\n                        previous = {\n                            section: previousSection,\n                            title: getSectionTitle(previousSection),\n                            classes: extraclasses\n                        };\n                    }\n                    if (nextSection < totalSectionCount) {\n                        if (self.courseConfig.partialrender) {\n                            hidden = $('#section-' + nextSection).hasClass('draft');\n                        } else {\n                            hidden = $('#section-' + nextSection).hasClass('hidden');\n                        }\n                        extraclasses = hidden ? ' dimmed_text' : '';\n                        next = {\n                            section: nextSection,\n                            title: getSectionTitle(nextSection),\n                            classes: extraclasses\n                        };\n                    }\n                    var navigation = {\n                        previous: previous,\n                        next: next\n                    };\n                    templates.render('theme_snap/course_section_navigation', navigation)\n                        .done(function(result) {\n                            var target = $('#section-' + sectionNum + ' .section_footer');\n                            if (target.length > 0) {\n                                target.replaceWith(result);\n                            }\n                            completed++;\n                            if (completed === sections.length) {\n                                dfd.resolve();\n                            }\n                        });\n\n                });\n                return dfd.promise();\n            };\n\n            /**\n             * Calculates how the sections are ordered after moving.\n             * @param sections\n             * @param oldIndex\n             * @param newIndex\n             * @returns {array}\n             */\n            var calculateSections = function (sections, oldIndex, newIndex) {\n                if (newIndex >= sections.length) {\n                    var k = newIndex - sections.length + 1;\n                    while (k--) {\n                        sections.push(undefined);\n                    }\n                }\n                sections.splice(newIndex, 0, sections.splice(oldIndex, 1)[0]);\n                return sections;\n            };\n\n            /**\n             * Update sections.\n             */\n            var updateSections = function(current, target, predeleteSections, deletedSection) {\n                if (courseLib.courseConfig.partialrender) {\n                    var loadedSections = [];\n                    var sections = [];\n                    if (current != 0 && target != 0) {\n                        $.each($('#course-toc #chapters > li a'), function (idx, obj) {\n                            sections.push($(obj).attr('href').split('#section-')[1]);\n                        });\n                        var newOrder = calculateSections(sections, current, target);\n                    } else {\n                        sections = predeleteSections;\n                        predeleteSections.splice(deletedSection, 1);\n                        var newOrder = predeleteSections;\n                    }\n                    $.each($('#region-main .course-content > ul li.section'), function(idx, obj) {\n                        var value = $(obj).attr('id').split('section-')[1];\n                        var key = newOrder.indexOf(value);\n                        var chapterTitle = getSectionTitle(key);\n                        var fullTitle = chapterTitle;\n                        $(obj).attr('id', 'section-' + key);\n                        if (self.courseConfig.toctype == 'top' && self.courseConfig.format == 'topics' && key > 0) {\n                            fullTitle = `<span class='sectionnumber'> ${key}.</span>${chapterTitle}`;\n                        }\n                        $('#section-' + key + ' .content .sectionname').html(fullTitle);\n                        loadedSections.push(key);\n                        // Uodate the attribute.\n                        $(obj).find('a.section-modchooser-link').attr('data-section', key);\n                    });\n                    sectionsProcess = loadedSections;\n                } else {\n                    // Renumber section ids, rename section titles.\n                    $.each($('#region-main .course-content > ul li.section'), function(idx, obj) {\n                        $(obj).attr('id', 'section-' + idx);\n                        // Get title from TOC (note that its idx + 1 because first entry is\n                        // introduction.\n                        var chapterTitle = getSectionTitle(idx);\n                        // Update section title with corresponding TOC title - this is necessary\n                        // for weekly topic courses where the section title needs to stay the\n                        // same as the TOC.\n                        var fullTitle = chapterTitle;\n                        if (self.courseConfig.toctype == 'top' && self.courseConfig.format == 'topics' && idx > 0) {\n                            fullTitle = `<span class='sectionnumber'></span>${chapterTitle}`;\n                        }\n                        $('#section-' + idx + ' .content .sectionname').html(fullTitle);\n                        // Update section data attribute to reflect new section idx.\n                        $(this).find('a.section-modchooser-link').attr('data-section', idx);\n                    });\n                }\n\n                updateSectionNavigation().done(function() {\n                    if (courseLib.courseConfig.partialrender) {\n                        setCourseSectionObervers();\n                    }\n                });\n            };\n\n            /**\n             * Delete section dialog and confirm function.\n             * @param {object} e\n             * @param {object} el\n             */\n            var sectionDelete = function(e, el) {\n                e.preventDefault();\n                var sectionNum = parentSectionNumber(el);\n                var section = $('#section-' + sectionNum);\n                var sectionName = section.find('.sectionname').text();\n\n                /**\n                 * Delete section.\n                 */\n                var doDelete = function() {\n\n                    if (!ajaxTracker.start('section_delete', el)) {\n                        // Already in progress.\n                        return;\n                    }\n\n                    var delProgress = M.util.get_string('deletingsection', 'theme_snap', sectionName);\n\n                    footerAlert.addAjaxLoading('');\n                    footerAlert.show();\n                    footerAlert.setTitle(delProgress);\n\n                    var params = {\n                        courseshortname: courseLib.courseConfig.shortname,\n                        action: 'delete',\n                        sectionnumber: sectionNum,\n                        value: 1,\n                        loadmodules: true,\n                    };\n\n                    log.debug('Making course/rest.php section delete request', params);\n\n                    // Make ajax call.\n                    var ajaxPromises = ajax.call([\n                        {\n                            methodname: 'theme_snap_course_sections',\n                            args: params\n                        }\n                    ], true, true);\n                    var sections = [];\n                    $.each($('#course-toc #chapters > li a'), function (idx, obj) {\n                        sections.push($(obj).attr('href').split('#section-')[1]);\n                    });\n                    // Handle ajax promises.\n                    ajaxPromises[0]\n                        .done(function(response) {\n                            // Update TOC.\n                            templates.render('theme_snap/course_toc', response.toc)\n                                .done(function(result) {\n                                    $('#course-toc').html($(result).html());\n                                    $(document).trigger('snapTOCReplaced');\n                                    // Remove section from DOM.\n                                    section.remove();\n                                    updateSections(0, 0, sections, sectionNum);\n                                    // Current section no longer exists so change location to previous section.\n                                    if (self.courseConfig.partialrender) {\n                                        var chapters = $('.chapter-title');\n                                        var ids = [];\n                                        $.each(chapters, function (key, element) {\n                                            ids.push($(element).attr('href').split('#section-')[1]);\n                                        });\n                                        var closest = ids.reduce(function(prev, curr) {\n                                            return (Math.abs(curr - sectionNum) < Math.abs(prev - sectionNum) ? curr : prev);\n                                        });\n                                        location.hash = 'section-' + closest;\n                                        if ($('li#section-' + closest).length == 1) {\n                                            courseLib.showSection();\n                                        } else {\n                                            getSection(closest, 0);\n                                        }\n                                    } else {\n                                        if (sectionNum >= $('.course-content > ul li.section').length) {\n                                            location.hash = 'section-' + (sectionNum - 1);\n                                        }\n                                        courseLib.showSection();\n                                    }\n                                    // We can't complete the action in the 'always' section because we want it to\n                                    // definitely be called after the section is removed from the DOM.\n                                    ajaxTracker.complete('section_delete');\n                                })\n                                .always(function() {\n                                    // Allow another request now this has finished.\n                                    footerAlert.hideAndReset();\n                                })\n                                .fail(function() {\n                                    ajaxTracker.complete('section_delete');\n                                });\n                        })\n                        .fail(function(response) {\n                            ajaxNotify.ifErrorShowBestMsg(response);\n                            footerAlert.hideAndReset();\n                            // Allow another request now this has finished.\n                            ajaxTracker.complete('section_delete');\n                        });\n                };\n\n                var delTitle = M.util.get_string('confirm', 'moodle');\n                var delConf = M.util.get_string('confirmdeletesection', 'moodle', sectionName);\n                var ok = M.util.get_string('deletesectionconfirm', 'theme_snap');\n                var cancel = M.util.get_string('cancel', 'moodle');\n                notification.confirm(delTitle, delConf, ok, cancel, doDelete);\n            };\n\n            /**\n             * Generic action handler for all asset actions.\n             * @param {event} e\n             * @param {domNode} triggerEl\n             */\n            var assetAction = function(e, triggerEl) {\n                e.preventDefault();\n\n                var assetEl = $($(triggerEl).parents('.snap-asset')[0]),\n                    cmid = Number(assetEl[0].id.replace('module-', '')),\n                    instanceName = assetEl.find('.instancename').text().trim(),\n                    action = $(triggerEl).data('action'),\n                    errActionKey = '',\n                    errMessageKey = '',\n                    errAction = '',\n                    errMessage = '',\n                    jsPendingKey = 'asset_' + action;\n\n                if (ajaxTracker.ajaxing(jsPendingKey)) {\n                    // Already in progress.\n                    // We check this because we don't want to show the confirmation dialog when in progress.\n                    return;\n                }\n\n                var actionAJAX = function() {\n                    if (!ajaxTracker.start(jsPendingKey, assetEl, '.snap-edit-asset-more')) {\n                        // Request already made.\n                        return;\n                    }\n\n                    var params = {\n                        'action': action,\n                        'sectionreturn': 0,\n                        'id': cmid\n                    };\n\n                    ajax.call([\n                        {\n                            methodname: 'core_course_edit_module',\n                            args: params\n                        }\n                    ], true, true)[0]\n                        .done(function(response) {\n                            ajaxNotify.ifErrorShowBestMsg(response, errAction, errMessage).done(function(errorShown) {\n                                ajaxTracker.complete(jsPendingKey);\n                                if (errorShown) {\n                                    log.debug('Ajax request fail');\n                                    return;\n                                } else {\n                                    log.debug('Ajax request successful');\n\n                                    // Reset module cache.\n                                    moduleCache = null;\n                                    progressCache = null;\n                                    if (action === 'delete') {\n                                        // Remove asset from DOM.\n                                        assetEl.remove();\n                                        // Remove asset searchable.\n                                        $('#toc-searchables li[data-id=\"' + cmid + '\"]').remove();\n                                    } else if (action === 'show') {\n                                        assetEl.removeClass('draft');\n                                    } else if (action === 'hide') {\n                                        assetEl.addClass('draft');\n                                    } else if (action === 'duplicate') {\n                                        assetEl.replaceWith(response);\n                                    }\n                                }\n                            });\n                        })\n                        .fail(function(response) {\n                            ajaxNotify.ifErrorShowBestMsg(response, errAction, errMessage).done(function() {\n                                ajaxTracker.complete(jsPendingKey);\n                            });\n                        })\n                        .always(function() {\n                            footerAlert.hideAndReset();\n                        });\n                };\n\n                /**\n                 * Get error strings incase of AJAX failure.\n                 * @returns {*|Promise}\n                 */\n                var getErrorStrings = function() {\n                    if (action === 'duplicate') {\n                        errActionKey = 'action:duplicateasset';\n                        errMessageKey = 'error:failedtoduplicateasset';\n                    } else if (action === 'show' || action === 'hide') {\n                        errActionKey = 'action:changeassetvisibility';\n                        errMessageKey = 'error:failedtochangeassetvisibility';\n                    } else if (action === 'delete') {\n                        errActionKey = 'action:deleteasset';\n                        errMessageKey = 'error:failedtodeleteasset';\n                    }\n                    return str.get_strings([\n                        {key: errActionKey, component: 'theme_snap'},\n                        {key: errMessageKey, component: 'theme_snap'}\n                    ]);\n                };\n\n                getErrorStrings().then(function(strings) {\n                    errAction = strings[0];\n                    errMessage = strings[0];\n                    if (action === 'delete') {\n                        // Create confirmation strings.\n                        var delConf = '',\n                            plugindata = {\n                                type: M.util.get_string('pluginname', assetEl.attr('class').match(/modtype_([^\\s]*)/)[1])\n                            };\n                        if (instanceName !== '') {\n                            plugindata.name = instanceName;\n                            delConf = M.util.get_string('deletechecktypename', 'moodle', plugindata);\n                        } else {\n                            delConf = M.util.get_string('deletechecktype', 'moodle', plugindata);\n                        }\n\n                        var delTitle = M.util.get_string('confirm', 'moodle');\n                        var ok = M.util.get_string('deleteassetconfirm', 'theme_snap', plugindata.type);\n                        var cancel = M.util.get_string('cancel', 'moodle');\n                        notification.confirm(delTitle, delConf, ok, cancel, actionAJAX);\n                    } else {\n                        actionAJAX();\n                    }\n                });\n            };\n\n            /**\n             * Ajax request to move asset to target.\n             * @param {object} target\n             */\n            var ajaxReqMoveAsset = function(target) {\n                var params = {};\n\n                log.debug('Move objects', movingObjects);\n\n                // Prepare request parameters\n                params.class = 'resource';\n\n                updateMovingMessage();\n\n                movingObject = movingObjects.shift();\n\n                params.id = Number(movingObject.id.replace('module-', ''));\n\n                if (target && !$(target).hasClass('snap-drop')) {\n                    params.beforeId = Number($(target)[0].id.replace('module-', ''));\n                } else {\n                    params.beforeId = 0;\n                }\n\n                if (document.body.id === \"page-site-index\") {\n                    params.sectionId = 1;\n                } else {\n                    if (target) {\n                        params.sectionId = parentSectionNumber(target);\n                    } else {\n                        params.sectionId = parentSectionNumber(movingObject);\n                    }\n                }\n\n                if (movingObjects.length > 0) {\n                    ajaxReqMoveGeneral(params, function() {\n                        $(target).before($(movingObject));\n                        // recurse\n                        ajaxReqMoveAsset(target);\n                    }, false);\n                } else {\n                    ajaxReqMoveGeneral(params, function() {\n                        $(target).before($(movingObject));\n                    }, true);\n                }\n\n            };\n\n            /**\n             * Ajax request to move section to target.\n             * @param {str|object} dropzone\n             */\n            var ajaxReqMoveSection = function(dropzone) {\n                var domTargetSection = parentSectionNumber(dropzone);\n                var currentSection = sectionNumber(movingObjects[0]);\n                var targetSection = currentSection < domTargetSection ?\n                        domTargetSection - 1 :\n                        domTargetSection;\n\n                var params = {\n                    \"class\": 'section',\n                    id: currentSection,\n                    value: targetSection\n                };\n\n                ajaxReqMoveGeneral(params, function() {\n\n                    // Update TOC chapters.\n                    ajax.call([\n                        {\n                            methodname: 'theme_snap_course_toc_chapters',\n                            args: {\n                                courseshortname: courseLib.courseConfig.shortname\n                            },\n                            done: function(response) {\n                                // Update TOC.\n                                templates.render('theme_snap/course_toc_chapters', response.chapters)\n                                    .done(function(result) {\n                                        // Update chapters.\n                                        $('#chapters').replaceWith(result);\n\n                                        // Move current section before target section.\n                                        $('#section-' + domTargetSection).before($('#section-' + currentSection));\n\n                                        // Update section ids, next previous links, etc.\n                                        updateSections(currentSection, targetSection, [], null);\n\n                                        // Navigate to section in its new location.\n                                        location.hash = 'section-' + targetSection;\n                                        courseLib.showSection();\n\n                                        // Finally, we have finished moving the section!\n                                        stopMoving();\n                                    });\n                            },\n                            fail: function(response) {\n                                ajaxNotify.ifErrorShowBestMsg(response);\n                                stopMoving();\n                            }\n                        }\n                    ], true, true);\n\n                }, true);\n            };\n\n            /**\n             * Listen for edit action clicks, hide, show, duplicate, etc..\n             */\n            var assetEditListeners = function() {\n                var actionSelectors = '.snap-asset-actions .js_snap_hide, ';\n                actionSelectors += '.snap-asset-actions .js_snap_show, ';\n                actionSelectors += '.snap-asset-actions .js_snap_delete, ';\n                actionSelectors += '.snap-asset-actions .js_snap_duplicate';\n\n                $(document).on('click', actionSelectors, function(e) {\n                    assetAction(e, this);\n                });\n            };\n\n            /**\n             * Generic section action handler.\n             *\n             * @param {string} action visibility, highlight\n             * @param {null|function} onComplete for when completed.\n             */\n            var sectionActionListener = function(action, onComplete) {\n\n                $('#region-main').on('click', '.snap-section-editing.actions .snap-' + action, function(e) {\n\n                    e.stopPropagation();\n                    e.preventDefault();\n\n                    var trigger = this;\n\n                    /**\n                     * Invalid section action exception.\n                     *\n                     * @param {string} action\n                     */\n                    var InvalidActionException = function(action) {\n                        this.message = 'Invalid section action: ' + action;\n                        this.name = 'invalidActionException';\n                    };\n\n                    // Check action is valid.\n                    var validactions = ['visibility', 'highlight'];\n                    if (validactions.indexOf(action) === -1) {\n                        throw new InvalidActionException(action);\n                    }\n\n                    if (!ajaxTracker.start('section_' + action, trigger)) {\n                        // Request already in progress.\n                        return;\n                    }\n\n                    // For toggling visibility.\n                    var toggle, loadModules = true;\n                    if (action === 'visibility') {\n                        toggle = $(this).hasClass('snap-hide') ? 0 : 1;\n                        if (moduleCache && moduleCache.length > 0 && progressCache && progressCache.length > 0) {\n                            loadModules = false;\n                        }\n                    } else {\n                        // For toggling highlight/mark as current.\n                        toggle = $(this).attr('aria-pressed') === 'true' ? 0 : 1;\n                    }\n                    var sectionNumber = parentSectionNumber(this);\n                    var sectionActionsSelector = '#section-' + sectionNumber + ' .snap-section-editing';\n                    var actionSelector = sectionActionsSelector + ' .snap-' + action;\n\n                    // Make ajax call.\n                    var ajaxPromises = ajax.call([\n                        {\n                            methodname: 'theme_snap_course_sections',\n                            args : {\n                                courseshortname: courseLib.courseConfig.shortname,\n                                action: action,\n                                sectionnumber: sectionNumber,\n                                value: toggle,\n                                loadmodules: loadModules,\n                            }\n                        }\n                    ], true, true);\n\n                    // Handle ajax promises.\n                    ajaxPromises[0]\n                    .fail(function(response) {\n                        var errMessage, errAction;\n                        if (action === 'visibility') {\n                            errMessage = M.util.get_string('error:failedtochangesectionvisibility', 'theme_snap');\n                            errAction = M.util.get_string('action:changesectionvisibility', 'theme_snap');\n                        } else {\n                            errMessage = M.util.get_string('error:failedtohighlightsection', 'theme_snap');\n                            errAction = M.util.get_string('action:highlightsectionvisibility', 'theme_snap');\n                        }\n                        ajaxNotify.ifErrorShowBestMsg(response, errAction, errMessage).done(function() {\n                            // Allow another request now this has finished.\n                            ajaxTracker.complete('section_' + action);\n                        });\n                    }).always(function() {\n                        $(trigger).removeClass('ajaxing');\n                    }).done(function(response) {\n                        // Update section action and then reload TOC.\n                        return templates.render('theme_snap/course_action_section', response.actionmodel)\n                        .then(function(result) {\n                            $(actionSelector).replaceWith(result);\n                            $(actionSelector).focus();\n                            // Update TOC.\n                            if (!loadModules) {\n                                if (moduleCache && moduleCache.length > 0 && response.toc.modules.length === 0) {\n                                    // Modules not loaded on request. Replacing them on the toc.\n                                    response.toc.modules = moduleCache;\n                                }\n\n                                if (progressCache && progressCache.length > 0) {\n                                    var progressCacheCopy = progressCache.slice(0);\n                                    $.each(response.toc.chapters.chapters, function(index) {\n                                        response.toc.chapters.chapters[index].progress = progressCacheCopy.shift();\n                                    });\n                                }\n                            }\n\n                            if (loadModules) {\n                                // Caching modules for future use.\n                                moduleCache = response.toc.modules;\n\n                                // Caching progress for future use.\n                                progressCache = [];\n                                $.each(response.toc.chapters.chapters, function(index, value) {\n                                    progressCache.push(value.progress);\n                                });\n                            }\n\n                            return templates.render('theme_snap/course_toc', response.toc);\n                        }).then(function(result) {\n                            $('#course-toc').html($(result).html());\n                            $(document).trigger('snapTOCReplaced');\n                            if (onComplete && typeof (onComplete) === 'function') {\n                                var completion = onComplete(sectionNumber, toggle);\n                                if (self.courseConfig.partialrender) {\n                                    if (typeof onComplete === 'function') {\n                                        ajaxTracker.complete('section_' + action);\n                                    }\n                                } else {\n                                    if (completion && typeof (completion.always) === 'function') {\n                                        // Callback returns a promise, js no longer running.\n                                        completion.always(\n                                            function() {\n                                                // Allow another request now this has finished.\n                                                ajaxTracker.complete('section_' + action);\n                                            }\n                                        );\n                                    } else {\n                                        // Callback does not return a promise, js no longer running.\n                                        // Allow another request now this has finished.\n                                        ajaxTracker.complete('section_' + action);\n                                    }\n                                }\n                            } else {\n                                // Allow another request now this has finished.\n                                ajaxTracker.complete('section_' + action);\n                            }\n                        });\n                    });\n                });\n            };\n\n            /**\n             * Highlight section on click.\n             */\n            var highlightSectionListener = function() {\n                sectionActionListener('highlight', function(sectionNumber) {\n                    $('#section-' + sectionNumber).toggleClass('current');\n\n                    // Reset sections which are not highlighted.\n                    var $notCurrent = $('li.section.main')\n                    .not('#section-' + sectionNumber)\n                    .not('#section-0').removeClass(\"current\");\n\n                    $notCurrent.each(function() {\n                        var highlighter = $(this).find('.snap-highlight');\n                        var sectionNumber = parentSectionNumber(highlighter);\n                        var newLink = $(highlighter).attr('href').replace(/(marker=)[0-9]+/ig, '$1' + sectionNumber);\n                        $(highlighter).attr('href', newLink).attr('aria-pressed', 'false');\n                    });\n                });\n            };\n\n            /**\n             * Delete section on click.\n             */\n            var deleteSectionListener = function() {\n                $(document).on('click', '.snap-section-editing.actions .snap-delete', function(e) {\n                    sectionDelete(e, this);\n                });\n            };\n\n            /**\n             * Toggle section visibility on click.\n             */\n            var toggleSectionListener = function() {\n                /**\n                 * Toggle hidden class and update section navigation.\n                 * @param {number} sectionNumber\n                 * @param {boolean} toggle\n                 * @returns {Promise}\n                 */\n                var manageHiddenClass = function(sectionNumber, toggle) {\n                    if (toggle === 0) {\n                        $('#section-' + sectionNumber).addClass('hidden');\n                    } else {\n                        $('#section-' + sectionNumber).removeClass('hidden');\n                        $('#section-' + sectionNumber + ' .snap-activity .snap-stealth-tag').remove();\n                        $('#section-' + sectionNumber + ' .snap-activity').removeClass('stealth');\n                    }\n\n                    // Update the section navigation either side of the current section.\n                    var selectors = [\n                        '#section-' + (sectionNumber - 1),\n                        '#section-' + (sectionNumber + 1)\n                    ];\n                    var selector = selectors.join(',');\n                    return updateSectionNavigation(selector);\n                };\n                sectionActionListener('visibility', manageHiddenClass);\n            };\n\n            /**\n             * Show footer alert for moving.\n             */\n            var footerAlertShowMove = function() {\n                footerAlert.show(function(e) {\n                    e.preventDefault();\n                    stopMoving();\n                });\n            };\n\n            /**\n             * When section move link is clicked, get the data we need and start the move.\n             */\n            var moveSectionListener = function() {\n                // Listen clicks on move links.\n                $(\"#region-main\").on('click', '.snap-section-editing.actions .snap-move', function(e) {\n                    e.stopPropagation();\n                    e.preventDefault();\n\n                    $('body').addClass('snap-move-inprogress');\n                    footerAlertShowMove();\n\n                    // Moving a section.\n                    var sectionNumber = parentSectionNumber(this);\n                    log.debug('Section is', sectionNumber);\n                    var section = $('#section-' + sectionNumber);\n                    var sectionName = section.find('.sectionname').text();\n\n                    log.debug('Moving this section', sectionName);\n                    movingObjects = [section];\n                    // This should never happen, but just in case...\n                    $('.section-moving').removeClass('section-moving');\n                    section.addClass('section-moving');\n                    $('a[href=\"#section-' + sectionNumber + '\"]').parent('li').addClass('section-moving');\n                    $('body').addClass('snap-move-section');\n                    if (self.courseConfig.partialrender) {\n                        $('#section-' + (sectionNumber + 1) + ' .snap-drop.section-drop').removeClass('partial-render');\n                    }\n                    var title = M.util.get_string('moving', 'theme_snap', sectionName);\n                    footerAlert.setTitle(title);\n                    updateSectionDropMsg(sectionName);\n                });\n            };\n\n            /**\n             * Add drop zones at the end of sections.\n             */\n            var addAfterDrops = function() {\n                if (document.body.id === \"page-site-index\") {\n                    $('#region-main .sitetopic ul.section').append(\n                        '<li class=\"snap-drop asset-drop\">' +\n                        '<div class=\"asset-wrapper\">' +\n                        '<a href=\"#\">' +\n                        M.util.get_string('movehere', 'theme_snap') +\n                        '</a>' +\n                        '</div>' +\n                        '</li>');\n                } else {\n                    $('li.section .content ul.section').append(\n                        '<li class=\"snap-drop asset-drop\">' +\n                        '<div class=\"asset-wrapper\">' +\n                        '<a href=\"#\">' +\n                        M.util.get_string('movehere', 'theme_snap') +\n                        '</a>' +\n                        '</div>' +\n                        '</li>');\n                }\n            };\n\n            /**\n             * Add listener for move checkbox.\n             */\n            var assetMoveListener = function() {\n                $(\"#region-main\").on('change', '.js-snap-asset-move', function(e) {\n                    e.stopPropagation();\n\n                    var asset = $(this).parents('.snap-asset')[0];\n\n                    // Make sure after drop is at the end of section.\n                    var section = $(asset).parents('ul.section')[0];\n                    var afterdrop = $(section).find('li.snap-drop.asset-drop');\n                    $(section).append(afterdrop);\n\n                    if (movingObjects.length === 0) {\n                        // Moving asset - activity or resource.\n                        // Initiate move.\n                        var assetname = $(asset).find('.snap-asset-link .instancename').html();\n\n                        log.debug('Moving this asset', assetname);\n\n                        var classes = $(asset).attr('class'),\n                            regex = /(?=snap-mime)([a-z0-9\\-]*)/;\n                        var assetclasses = regex.exec(classes);\n                        classes = '';\n                        if (assetclasses) {\n                            classes = assetclasses.join(' ');\n                        }\n                        log.debug('Moving this class', classes);\n                        $(asset).addClass('asset-moving');\n                        $('.snap-asset button').attr('disabled','disabled');\n                        $(asset).find('button').removeAttr('disabled');\n                        $('.snap-asset .snap-asset-content a').attr('tabindex','-1');\n                        $(asset).find('a').removeAttr('tabindex');\n\n                        $(asset).find('.js-snap-asset-move').prop('checked', 'checked');\n\n                        $('body').addClass('snap-move-inprogress');\n                        $('body').addClass('snap-move-asset');\n\n                    }\n\n                    if ($(this).prop('checked')) {\n                        // Add asset to moving array.\n                        movingObjects.push(asset);\n                        $(asset).find('a').removeAttr('tabindex');\n                        $(asset).find('button').removeAttr('disabled');\n                        $(asset).addClass('asset-moving');\n                    } else {\n                        // Remove from moving array.\n                        removeMovingObject(asset);\n                        // Remove moving class\n                        $(asset).find('.snap-asset-content a').attr('tabindex','-1');\n                        $(asset).find('button').attr('disabled','disabled');\n                        $(asset).removeClass('asset-moving');\n                        if (movingObjects.length === 0) {\n                            // Nothing is ticked for moving, cancel the move.\n                            stopMoving();\n                        }\n                    }\n                    footerAlertShowMove();\n                    updateMovingMessage();\n                });\n            };\n\n            /**\n             * When an asset or drop zone is clicked, execute move.\n             */\n            var movePlaceListener = function() {\n                $(document).on('click', '.snap-move-note, .snap-drop', function(e) {\n                    log.debug('Snap drop clicked', e);\n                    if (movingObjects) {\n                        e.stopPropagation();\n                        e.preventDefault();\n                        if ($('body').hasClass('snap-move-section')) {\n                            ajaxReqMoveSection(this);\n                        } else {\n                            var target;\n                            if ($(this).hasClass('snap-drop')) {\n                                target = this;\n                            } else {\n                                target = $(this).closest('.snap-asset');\n                            }\n                            ajaxReqMoveAsset(target);\n                        }\n                    }\n                });\n            };\n\n            /**\n             * Set observers for TOC and navigation buttons in the footer.\n             */\n            var setCourseSectionObervers = function () {\n                setTocObservers();\n                setNavigationFooterObservers();\n            };\n\n            /**\n             * Add listeners.\n             */\n            var addListeners = function() {\n                moveSectionListener();\n                toggleSectionListener();\n                highlightSectionListener();\n                deleteSectionListener();\n                assetMoveListener();\n                movePlaceListener();\n                assetEditListeners();\n                addAfterDrops();\n                if (courseLib.courseConfig.partialrender) {\n                    setCourseSectionObervers();\n                }\n                $('body').addClass('snap-course-listening');\n            };\n\n            /**\n             * Override core functions.\n             */\n            var overrideCore = function() {\n                // Check M.course exists (doesn't exist in social format).\n                if (M.course && M.course.resource_toolbox) {\n                    /* eslint-disable camelcase */\n                    M.course.resource_toolbox.handle_resource_dim = function(button, activity, action) {\n                        return (action === 'hide') ? 0 : 1;\n                    };\n                    /* eslint-enable camelcase */\n                }\n            };\n\n            /**\n             * Make an Ajax request for caching the TOC so it's not so expensive to hide and show sections.\n             */\n            var cacheTOC = function() {\n                if ($('.snap-section-editing.actions').length === 0) {\n                    // Only cache the TOC if there are sections.\n                    return;\n                }\n\n                var action = 'toc';\n\n                var trigger = $('#region-main');\n\n                if (!ajaxTracker.start('section_' + action, trigger)) {\n                    // Request already in progress.\n                    return;\n                }\n\n                // Make ajax call.\n                var ajaxPromises = ajax.call([\n                    {\n                        methodname: 'theme_snap_course_sections',\n                        args : {\n                            courseshortname: courseLib.courseConfig.shortname,\n                            action: action,\n                            sectionnumber: 0,\n                            value: 0,\n                            loadmodules: 0,\n                        }\n                    }\n                ], true, true);\n\n                // Handle ajax promises.\n                ajaxPromises[0]\n                .fail(function(response) {\n                    var errMessage, errAction;\n                    errMessage = M.util.get_string('error:failedtotoc', 'theme_snap');\n                    errAction = M.util.get_string('action:sectiontoc', 'theme_snap');\n                    ajaxNotify.ifErrorShowBestMsg(response, errAction, errMessage).done(function() {\n                        // Allow another request now this has finished.\n                        ajaxTracker.complete('section_' + action);\n                    });\n                }).always(function() {\n                    $(trigger).removeClass('ajaxing');\n                }).done(function(response) {\n                    // Caching modules for future use.\n                    moduleCache = response.toc.modules;\n\n                    // Caching progress for future use.\n                    progressCache = [];\n                    $.each(response.toc.chapters.chapters, function(index, value) {\n                        progressCache.push(value.progress);\n                    });\n\n                    ajaxTracker.complete('section_' + action);\n                });\n            };\n\n            /**\n             * Initialise script.\n             */\n            var initialise = function() {\n                // Add listeners.\n                addListeners();\n\n                // Cache TOC.\n                cacheTOC();\n\n                // Override core functions\n                util.whenTrue(function() {\n                    return M.course && M.course.init_section_toolbox;\n                }, function() {\noverrideCore();\n}, true);\n\n            };\n            initialise();\n        },\n\n        /**\n         * Exposed function that renders a specific course section and sets focus on an activity module.\n         * @param section\n         * @param mod\n         */\n        renderAndFocusSection: function(section, mod) {\n            getSection(section, mod);\n        },\n\n        setTocObserver: function() {\n            setTocObservers();\n        }\n    };\n\n});\n"],"file":"section_asset_management.min.js"}