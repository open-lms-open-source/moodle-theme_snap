{"version":3,"file":"section_asset_management.min.js","sources":["../src/section_asset_management.js"],"sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package\n * @copyright Copyright (c) 2015 Open LMS (https://www.openlms.net)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(\n    [\n        'jquery',\n        'core/log',\n        'core/ajax',\n        'core/str',\n        'core/templates',\n        'core/notification',\n        'theme_snap/util',\n        'theme_snap/ajax_notification',\n        'theme_snap/footer_alert',\n        'core_filters/events',\n        'core/fragment',\n        'core/modal_copy_to_clipboard'\n    ],\n    function(\n        $,\n        log,\n        ajax,\n        str,\n        templates,\n        notification,\n        util, ajaxNotify,\n        footerAlert,\n        Event,\n        fragment,\n        ModalCopyToClipboard\n    ) {\n\n        var self = this;\n\n        /**\n         * Items being moved - actual dom elements.\n         * @type {array}\n         */\n        var movingObjects = [];\n\n        /**\n         * Item being moved - actual dom element.\n         * @type {object}\n         */\n        var movingObject;\n\n        /**\n         * @type {boolean}\n         */\n        var ajaxing = false;\n\n        var ajaxTracker;\n\n        /**\n         * Sections that are being retrieved by the API.\n         * @type {Array}\n         */\n        var sectionsProcess = [];\n\n        /**\n         * Module html caching.\n         * @type {object|null}\n         */\n        var moduleCache = null;\n\n        /**\n         * Progress caching.\n         * @type {Array|null}\n         */\n        var progressCache = null;\n\n        /**\n         * Sets observers for the TOC elements.\n         */\n        var setTocObservers = function () {\n            if (self.courseConfig.format == 'weeks' || self.courseConfig.format == 'topics') {\n                $('#course-toc .chapter-title').click(function(e) {\n                    var link = $(e.target);\n                    var section = link.attr('href');\n                    if (typeof section != 'undefined' && section.length > 0) {\n                        getSection(section.split('#section-')[1], 0);\n                    }\n                });\n\n                $('#toc-searchables li a').click(function(e) {\n                    var link = $(e.target);\n                    var urlParams = link.attr('href').split(\"&\"),\n                        section = urlParams[0],\n                        mod = urlParams[1] || null;\n                    section = section.split('#section-')[1];\n                    getSection(section, mod);\n                });\n            }\n        };\n\n        /**\n         * Sets observers for the navigation arrows.\n         */\n        var setNavigationFooterObservers = function () {\n            if (self.courseConfig.format == 'weeks' || self.courseConfig.format == 'topics') {\n                $('.section_footer .next_section, .section_footer .icon-arrow-right, ' +\n                    '.section_footer .previous_section, .section_footer .icon-arrow-left').click(function(e) {\n                    var link = $(e.target);\n                    var section = link.attr('section-number');\n                    if(typeof section !== 'undefined' && section.length > 0) {\n                        getSection(section, 0);\n                    }\n                });\n\n                $('.section_footer .text').click(function (e) {\n                    var node = $(e.target);\n                    var section = node.find('.nav_guide').attr('section-number');\n                    if(typeof section !== 'undefined' && section.length > 0) {\n                        getSection(section, 0);\n                    }\n                });\n            }\n        };\n\n        /**\n         * Scroll to a mod via search.\n         * @param {string} modid\n         */\n        var scrollToModule = function(modid) {\n            // Sometimes we have a hash, sometimes we don't.\n            // Strip hash then add just in case.\n            $('#toc-search-results').html('');\n            var targmod = $(\"#\" + modid.replace('#', ''));\n            // http://stackoverflow.com/questions/6677035/jquery-scroll-to-element\n            util.scrollToElement(targmod);\n\n            var searchpin = $(\"#searchpin\");\n            if (!searchpin.length) {\n                searchpin = $('<i id=\"searchpin\"></i>');\n            }\n\n            $(targmod).find('.instancename').prepend(searchpin);\n            $(targmod).attr('tabindex', '-1').focus();\n            $('#course-toc').removeClass('state-visible');\n        };\n\n        /**\n         * Update moving message.\n         */\n        var updateMovingMessage = function() {\n            var title;\n            if (movingObjects.length === 1) {\n                var assetname = $(movingObjects[0]).find('.snap-asset-link .instancename').html();\n                assetname = assetname || M.util.get_string('pluginname', 'label', assetname);\n                title = M.util.get_string('moving', 'theme_snap', assetname);\n            } else {\n                title = M.util.get_string('movingcount', 'theme_snap', movingObjects.length);\n            }\n            footerAlert.setTitle(title);\n        };\n\n        /**\n         * Updates the drop zone with a descriptive text.\n         * @param {string} sectionName\n         */\n        var updateSectionDropMsg = function (sectionName) {\n            if (typeof movingObjects !== 'undefined' && movingObjects.length > 0) {\n                $('.section-drop').each(function() {\n                    var sectionDropMsg = M.util.get_string('movingdropsectionhelp', 'theme_snap',\n                        {moving: sectionName, before: $(this).data('title')}\n                    );\n                    $(this).html(sectionDropMsg);\n                });\n                footerAlert.setSrNotice(M.util.get_string('movingstartedhelp', 'theme_snap', sectionName));\n\n            }\n        };\n\n        /**\n         * Gets a specific section for the current course and if an activity module is passed sets focus on it.\n         * @param {string} section\n         * @param {string} mod\n         */\n        var getSection = function (section, mod) {\n            var node = $('#section-' + section);\n            if (node.length == 0 && sectionsProcess.indexOf(section) == -1) {\n                sectionsProcess.push(section);\n                var params = {courseid: self.courseConfig.id, section: section};\n                $('.sk-fading-circle').show();\n                // We need to prevent the DOM to show the default section.\n                $('.course-content .' + self.courseConfig.format + ' li[id^=\"section-\"]').hide();\n                fragment.loadFragment('theme_snap', 'section', self.courseConfig.contextid, params).done(function(html, js) {\n                    var node = $(html);\n                    renderSection(section, node, mod, js);\n\n                    var folders = node.find('li.snap-activity.modtype_folder');\n                    $.each(folders, function (index, folder) {\n                        var content = $(folder).find('div.contentwithoutlink div.snap-assettype');\n                        if (content.length > 0) {\n                            if ($(folder).find('div.activityinstance div.snap-header-card .asset-type').length == 0) {\n                                var folderAssetTypeHeader = $(folder).find('div.activityinstance div.snap-header-card');\n                                content.prependTo(folderAssetTypeHeader);\n                            }\n                        }\n                    });\n                });\n            }\n        };\n\n        /**\n         * This functions inserts a section node to the DOM.\n         * @param {string} section\n         * @param {node} html\n         * @param {string} mod\n         * @param {string} js\n         */\n        var renderSection = function(section, html, mod, js) {\n            var anchor = $('.course-content');\n            var existingSections = [];\n            anchor.find('ul.sections>li[id^=section-]').each(function() {\n                existingSections.push(parseInt($(this).attr('id').split('section-')[1]));\n            });\n            var tempnode = $('<div></div>');\n            templates.replaceNodeContents(tempnode, html, '');\n\n            // Remove from Dom the completion tracking when it is disabled for an activity.\n            tempnode.find('.snap-header-card .snap-header-card-icons .disabled-snap-asset-completion-tracking').remove();\n            if (existingSections.length > 0) {\n                var closest = existingSections.reduce(function(prev, curr) {\n                    return (Math.abs(curr - section) < Math.abs(prev - section) ? curr : prev);\n                });\n\n                if (closest > section) {\n                    anchor.find('#section-' + closest).before(tempnode.contents());\n\n                } else {\n                    anchor.find('#section-' + closest).after(tempnode.contents());\n\n                }\n            } else {\n                $('.sk-fading-circle').after(tempnode);\n            }\n            templates.runTemplateJS(js);\n\n            // Hide loading animation.\n            $('.sk-fading-circle').hide();\n            // Notify filters about the new section.\n            Event.notifyFilterContentUpdated($('.course-content .' + self.courseConfig.format));\n            var sections = anchor.find('li[id^=\"section-\"]');\n            // When not present the section, the first one will be shown as default, remove all classes to prevent that.\n            sections.removeClass('state-visible');\n            var id = '#section-' + section;\n            $(id).addClass('state-visible');\n            if (self.courseConfig.toctype == 'top' && self.courseConfig.format == 'topics' && section > 0) {\n                var title = $(id).find('.sectionname').html();\n                var elements = $('.chapter-title');\n                var tmpid = 0;\n                // Find the right toc element.\n                $.each(elements, function(key, element) {\n                    if ($(element).attr('href').split('#section-')[1] == section) {\n                        tmpid = key;\n                    }\n                });\n                $(id).find('.sectionname').html(title);\n                $(id).find('.sectionnumber').html(tmpid + '.');\n            }\n            // Leave all course sections as they were.\n            sections.show();\n            $(id).find('.section_footer .next_section, .section_footer .icon-arrow-right, ' +\n                '.section_footer .previous_section, .section_footer .icon-arrow-left').click(function(e) {\n                var link = $(e.target);\n                var section = link.attr('section-number');\n                if(typeof section !== 'undefined' && section.length > 0) {\n                    getSection(section, 0);\n                }\n            });\n\n            $(id).find('.section_footer .text').click(function (e) {\n                var node = $(e.target);\n                var section = node.find('.nav_guide').attr('section-number');\n                if(typeof section !== 'undefined' && section.length > 0) {\n                    getSection(section, 0);\n                }\n            });\n\n            // Set observer for mod chooser.\n            $(id + ' .section-modchooser-link').click(function() {\n                // Grab the section number from the button.\n                var sectionNum = $(this).attr('data-sectionid');\n                $('.snap-modchooser-addlink').each(function() {\n                    // Update section in mod link to current section.\n                    var newLink = this.href.replace(/(section=)[0-9]+/ig, '$1' + sectionNum);\n                    $(this).attr('href', newLink);\n                });\n            });\n\n            // If a module id has been passed as parameter, set focus.\n            if (mod != 0 && typeof mod !== 'undefined') {\n                scrollToModule(mod);\n            }\n            var sectionName = $('#region-main .section-moving').find('.sectionname').text();\n            if (typeof sectionName !== 'undefined' && sectionName.length > 0) {\n                updateSectionDropMsg(sectionName);\n            }\n\n            var movingId = $('#region-main .section-moving').attr('id');\n            if (typeof movingId !== 'undefined' && movingId.length > 0) {\n                $('#section-' + (parseInt(movingId.split('section-')[1]) + 1) +\n                    ' .snap-drop.section-drop').removeClass('partial-render');\n            }\n\n            $('#course-toc #chapters li').removeClass('snap-visible-section');\n            $('#course-toc #chapters li a').attr(\"aria-current\", \"false\");\n            // Set link as current.\n            var visibleSectionLink = $('#course-toc .chapter-title[href=\"#section-' + section + '\"]');\n            visibleSectionLink.parent('li').addClass('snap-visible-section');\n            visibleSectionLink.attr('aria-current', 'true');\n\n            $(id).find('ul.section').append(\n                '<li class=\"snap-drop asset-drop\">' +\n                '<div class=\"asset-wrapper\">' +\n                '<a href=\"#\">' +\n                M.util.get_string('movehere', 'theme_snap') +\n                '</a>' +\n                '</div>' +\n                '</li>');\n\n            // Add the correct section return to the modchooser.\n            util.modchooserSectionReturn();\n        };\n\n\n\n    return {\n        init: function(courseLib) {\n\n            self.courseConfig = courseLib.courseConfig;\n\n            /**\n             * AJAX tracker class - for tracking chained AJAX requests (prevents behat intermittent faults).\n             * Also, sets and unsets ajax classes on trigger element / child of trigger if specified.\n             */\n            var AjaxTracker = function() {\n\n                var triggersByKey = {};\n\n                /**\n                 * Starts tracking.\n                 * @param {string} jsPendingKey\n                 * @param {domElement} trigger\n                 * @param {string} subSelector\n                 * @returns {boolean}\n                 */\n                this.start = function(jsPendingKey, trigger, subSelector) {\n                    if (this.ajaxing(jsPendingKey)) {\n                        log.debug('Skipping ajax request for ' + jsPendingKey + ', AJAX already in progress');\n                        return false;\n                    }\n                    M.util.js_pending(jsPendingKey);\n                    triggersByKey[jsPendingKey] = {trigger: trigger, subSelector: subSelector};\n                    if (trigger) {\n                        if (subSelector) {\n                            $(trigger).find(subSelector).addClass('ajaxing');\n                        } else {\n                            $(trigger).addClass('ajaxing');\n                        }\n                    }\n                    return true;\n                };\n\n                /**\n                 * Is there an AJAX request in progress.\n                 * @param {string} jsPendingKey\n                 * @returns {boolean}\n                 */\n                this.ajaxing = function(jsPendingKey) {\n                    return M.util.pending_js.indexOf(jsPendingKey) > -1;\n                };\n\n                /**\n                 * Completes tracking.\n                 * @param {string} jsPendingKey\n                 */\n                this.complete = function(jsPendingKey) {\n                    var trigger, subSelector;\n                    if (triggersByKey[jsPendingKey]) {\n                        trigger = triggersByKey[jsPendingKey].trigger;\n                        subSelector = triggersByKey[jsPendingKey].subSelector;\n                    }\n                    if (trigger) {\n                        if (subSelector) {\n                            $(trigger).find(subSelector).removeClass('ajaxing');\n                        } else {\n                            $(trigger).removeClass('ajaxing');\n                        }\n                    }\n                    delete triggersByKey[jsPendingKey];\n                    M.util.js_complete(jsPendingKey);\n                };\n            };\n\n            ajaxTracker = new AjaxTracker();\n\n            /**\n             * Get the section number from a section element.\n             * @param {jQuery|object} el\n             * @returns {number}\n             */\n            var sectionNumber = function(el) {\n                if (self.courseConfig.partialrender) {\n                    return (parseInt($(el).attr('id').split('section-')[1]));\n                } else {\n                    return (parseInt($(el).attr('id').replace('section-', '')));\n                }\n            };\n\n            /**\n             * Get the section number for an element within a section.\n             * @param {object} el\n             * @returns {number}\n             */\n            var parentSectionNumber = function(el) {\n                return sectionNumber($(el).parents('li.section.main')[0]);\n            };\n\n            /**\n             * Moving has stopped, clean up.\n             */\n            var stopMoving = function() {\n                $('body').removeClass('snap-move-inprogress');\n                $('body').removeClass('snap-move-section');\n                $('body').removeClass('snap-move-asset');\n                footerAlert.hideAndReset();\n                $('.section-moving').removeClass('section-moving');\n                $('.asset-moving').removeClass('asset-moving');\n                $('.snap-asset a').removeAttr('tabindex');\n                $('.snap-asset button').removeAttr('disabled');\n                $('.js-snap-asset-move').removeAttr('checked');\n                $('.snap-asset-move-input').prop('checked', false);\n                $('.readmore-container').removeAttr('hidden');\n                movingObjects = [];\n                if (self.courseConfig.partialrender) {\n                    $('.snap-drop.section-drop').addClass('partial-render');\n                }\n            };\n\n            /**\n             * Move fail - sad face :(.\n             */\n            var moveFailed = function() {\n                var actname = $(movingObject).find('.instancename').html();\n\n                footerAlert.removeAjaxLoading();\n                footerAlert.setTitle(M.util.get_string('movefailed', 'theme_snap', actname));\n                // Stop moving in 2 seconds so that the user has time to see the failed moving notice.\n                window.setTimeout(function() {\n                    // Don't pass in target, we want to abort the move!\n                    stopMoving(false);\n                }, 2000);\n            };\n\n            /**\n             * Remove moving object from moving objects array.\n             * @param {object} obj\n             */\n            var removeMovingObject = function(obj) {\n                var index = movingObjects.indexOf(obj);\n                if (index > -1) {\n                    movingObjects.splice(index, 1);\n                }\n                updateMovingMessage();\n            };\n\n            /**\n             * General move request\n             *\n             * @param {object}   params\n             * @param {function} onSuccess\n             * @param {bool}     finalItem\n             */\n            var ajaxReqMoveGeneral = function(params, onSuccess, finalItem) {\n                if (ajaxing) {\n                    // Request already made.\n                    log.debug('Skipping ajax request, one already in progress');\n                    return;\n                }\n\n                // Add spinner.\n                footerAlert.addAjaxLoading();\n\n                // Set common params.\n                params.sesskey = M.cfg.sesskey;\n                params.courseId = courseLib.courseConfig.id;\n                params.field = 'move';\n\n                log.debug('Making course/rest.php request', params);\n                var req = $.ajax({\n                    type: \"POST\",\n                    async: true,\n                    data: params,\n                    url: M.cfg.wwwroot + courseLib.courseConfig.ajaxurl\n                });\n                req.done(function(data) {\n                    ajaxNotify.ifErrorShowBestMsg(data).done(function(errorShown) {\n                        if (errorShown) {\n                            log.debug('Ajax request fail');\n                            moveFailed();\n                            return;\n                        } else {\n                            // No errors, call success callback and stop moving if necessary.\n                            log.debug('Ajax request successful');\n                            if (onSuccess) {\n                                onSuccess();\n                            }\n                            if (finalItem) {\n                                if (params.class === 'resource') {\n                                    // Only stop moving for resources, sections handle this later once the TOC is reloaded.\n                                    stopMoving();\n                                    $('.snap-asset-move-wrapper').attr('hidden', 'hidden');\n                                    $(movingObject).find('label.snap-asset-move-label > input.js-snap-asset-move').focus();\n                                }\n                            }\n                        }\n                    });\n                });\n                req.fail(function() {\n                    moveFailed();\n                });\n\n                if (finalItem) {\n                    req.always(function() {\n                        ajaxing = false;\n                        footerAlert.removeAjaxLoading();\n                    });\n                }\n            };\n\n            /**\n             * Get section title.\n             * @param {integer} section\n             * @returns {*|jQuery}\n             */\n            var getSectionTitle = function(section) {\n                // Get title from TOC.\n                if (self.courseConfig.partialrender) {\n                    return  $('#course-toc #chapters > h3 li a[href=\"#section-' + section + '\"]').text();\n                } else {\n                    return $('#chapters h3:nth-of-type(' + (section + 1) + ') .chapter-title').html();\n                }\n            };\n\n            /**\n             * Update next / previous links.\n             * @param {string} selector\n             * @return {promise}\n             */\n            var updateSectionNavigation = function(selector) {\n                var dfd = $.Deferred();\n                var sections, totalSectionCount;\n                if (!selector) {\n                    if (self.courseConfig.partialrender) {\n                        selector = '#course-toc #chapters > h3 li a';\n                    } else {\n                        selector = '#region-main .course-content > ul li.section';\n                    }\n                    sections = $(selector);\n                    totalSectionCount = sections.length;\n                } else {\n                    sections = $(selector);\n                    if (self.courseConfig.partialrender) {\n                        var allSections = $('#course-toc #chapters > h3 li a');\n                    } else {\n                        var allSections = $('#region-main .course-content > ul li.section');\n                    }\n                    totalSectionCount = allSections.length;\n                }\n\n                var completed = 0;\n                $.each(sections, function(idx, el) {\n                    if (self.courseConfig.partialrender) {\n                        var href = $(el).attr('href');\n                        var sectionNum;\n                        if (typeof href !== typeof undefined && href !== false) {\n                            sectionNum = parseInt($(el).attr('href').split('#section-')[1]);\n                        } else {\n                            sectionNum = parseInt($(el).attr('id').split('section-')[1]);\n                        }\n                    } else {\n                        var sectionNum = sectionNumber(el);\n                    }\n                    var previousSection = sectionNum - 1;\n                    var nextSection = sectionNum + 1;\n                    var previous = false;\n                    var next = false;\n                    var hidden, extraclasses;\n                    if (previousSection > -1) {\n                        if (self.courseConfig.partialrender) {\n                            hidden = $('#section-' + previousSection).hasClass('draft');\n                        } else {\n                            hidden = $('#section-' + previousSection).hasClass('hidden');\n                        }\n                        extraclasses = hidden ? ' dimmed_text' : '';\n                        previous = {\n                            section: previousSection,\n                            title: getSectionTitle(previousSection),\n                            classes: extraclasses\n                        };\n                    }\n                    if (nextSection < totalSectionCount) {\n                        if (self.courseConfig.partialrender) {\n                            hidden = $('#section-' + nextSection).hasClass('draft');\n                        } else {\n                            hidden = $('#section-' + nextSection).hasClass('hidden');\n                        }\n                        extraclasses = hidden ? ' dimmed_text' : '';\n                        next = {\n                            section: nextSection,\n                            title: getSectionTitle(nextSection),\n                            classes: extraclasses\n                        };\n                    }\n                    var navigation = {\n                        previous: previous,\n                        next: next\n                    };\n                    templates.render('theme_snap/course_section_navigation', navigation)\n                        .done(function(result) {\n                            var target = $('#section-' + sectionNum + ' .section_footer');\n                            if (target.length > 0) {\n                                target.replaceWith(result);\n                            }\n                            completed++;\n                            if (completed === sections.length) {\n                                dfd.resolve();\n                            }\n                        });\n\n                });\n                return dfd.promise();\n            };\n\n            /**\n             * Calculates how the sections are ordered after moving.\n             * @param {array} sections\n             * @param {int} oldIndex\n             * @param {int} newIndex\n             * @returns {array}\n             */\n            var calculateSections = function (sections, oldIndex, newIndex) {\n                if (newIndex >= sections.length) {\n                    var k = newIndex - sections.length + 1;\n                    while (k--) {\n                        sections.push(undefined);\n                    }\n                }\n                sections.splice(newIndex, 0, sections.splice(oldIndex, 1)[0]);\n                return sections;\n            };\n\n            /**\n             * Update sections.\n             * @param {int} current\n             * @param {int} target\n             * @param {array} predeleteSections\n             * @param {string} deletedSection\n             */\n            var updateSections = function(current, target, predeleteSections, deletedSection) {\n                if (courseLib.courseConfig.partialrender) {\n                    var loadedSections = [];\n                    var sections = [];\n                    if (current != 0 && target != 0) {\n                        $.each($('#course-toc #chapters li a'), function (idx, obj) {\n                            sections.push($(obj).attr('href').split('#section-')[1]);\n                        });\n                        var newOrder = calculateSections(sections, current, target);\n                    } else {\n                        sections = predeleteSections;\n                        predeleteSections.splice(deletedSection, 1);\n                        var newOrder = predeleteSections;\n                    }\n                    $.each($('#region-main .course-content > ul li.section'), function(idx, obj) {\n                        var value = $(obj).attr('id').split('section-')[1];\n                        var key = newOrder.indexOf(value);\n                        var chapterTitle = getSectionTitle(key);\n                        var fullTitle = chapterTitle;\n                        $(obj).attr('id', 'section-' + key);\n                        if (self.courseConfig.toctype == 'top' && self.courseConfig.format == 'topics' && key > 0) {\n                            fullTitle = `<span class='sectionnumber'> ${key}.</span>${chapterTitle}`;\n                        }\n                        $('#section-' + key + ' .content .sectionname').html(fullTitle);\n                        loadedSections.push(key);\n                        // Update the attribute.\n                        $(obj).find('.section-modchooser-link').attr('data-sectionid', key);\n                    });\n                    sectionsProcess = loadedSections;\n                } else {\n                    // Renumber section ids, rename section titles.\n                    $.each($('#region-main .course-content > ul li.section'), function(idx, obj) {\n                        $(obj).attr('id', 'section-' + idx);\n                        // Get title from TOC (note that its idx + 1 because first entry is\n                        // introduction.\n                        var chapterTitle = getSectionTitle(idx);\n                        // Update section title with corresponding TOC title - this is necessary\n                        // for weekly topic courses where the section title needs to stay the\n                        // same as the TOC.\n                        var fullTitle = chapterTitle;\n                        if (self.courseConfig.toctype == 'top' && self.courseConfig.format == 'topics' && idx > 0) {\n                            fullTitle = `<span class='sectionnumber'></span>${chapterTitle}`;\n                        }\n                        $('#section-' + idx + ' .content .sectionname').html(fullTitle);\n                        // Update section data attribute to reflect new section idx.\n                        $(this).find('.section-modchooser-link').attr('data-sectionid', idx);\n                    });\n                }\n\n                updateSectionNavigation().done(function() {\n                    if (courseLib.courseConfig.partialrender) {\n                        setCourseSectionObervers();\n                    }\n                });\n            };\n\n            /**\n             * Delete section dialog and confirm function.\n             * @param {object} e\n             * @param {object} el\n             */\n            var sectionDelete = function(e, el) {\n                e.preventDefault();\n                var sectionNum = parentSectionNumber(el);\n                var section = $('#section-' + sectionNum);\n                var sectionName = section.find('.sectionname').text();\n\n                /**\n                 * Delete section.\n                 */\n                var doDelete = function() {\n\n                    if (!ajaxTracker.start('section_delete', el)) {\n                        // Already in progress.\n                        return;\n                    }\n\n                    var delProgress = M.util.get_string('deletingsection', 'theme_snap', sectionName);\n\n                    footerAlert.addAjaxLoading('');\n                    footerAlert.show();\n                    footerAlert.setTitle(delProgress);\n\n                    var params = {\n                        courseshortname: courseLib.courseConfig.shortname,\n                        action: 'delete',\n                        sectionnumber: sectionNum,\n                        value: 1,\n                        loadmodules: true,\n                    };\n\n                    log.debug('Making course/rest.php section delete request', params);\n\n                    // Make ajax call.\n                    var ajaxPromises = ajax.call([\n                        {\n                            methodname: 'theme_snap_course_sections',\n                            args: params\n                        }\n                    ], true, true);\n                    var sections = [];\n                    $.each($('#course-toc #chapters > li a'), function (idx, obj) {\n                        sections.push($(obj).attr('href').split('#section-')[1]);\n                    });\n                    // Handle ajax promises.\n                    ajaxPromises[0]\n                        .done(function(response) {\n                            // Update TOC.\n                            templates.render('theme_snap/course_toc', response.toc)\n                                .done(function(result) {\n                                    $('#course-toc').html($(result).html());\n                                    $(document).trigger('snapTOCReplaced');\n                                    // Remove section from DOM.\n                                    section.remove();\n                                    updateSections(0, 0, sections, sectionNum);\n                                    // Current section no longer exists so change location to previous section.\n                                    if (self.courseConfig.partialrender) {\n                                        var chapters = $('.chapter-title');\n                                        var ids = [];\n                                        $.each(chapters, function (key, element) {\n                                            ids.push($(element).attr('href').split('#section-')[1]);\n                                        });\n                                        var closest = ids.reduce(function(prev, curr) {\n                                            return (Math.abs(curr - sectionNum) < Math.abs(prev - sectionNum) ? curr : prev);\n                                        });\n                                        location.hash = 'section-' + closest;\n                                        if ($('li#section-' + closest).length == 1) {\n                                            courseLib.showSection();\n                                        } else {\n                                            getSection(closest, 0);\n                                        }\n                                    } else {\n                                        if (sectionNum >= $('.course-content > ul li.section').length) {\n                                            location.hash = 'section-' + (sectionNum - 1);\n                                        }\n                                        courseLib.showSection();\n                                    }\n                                    // We can't complete the action in the 'always' section because we want it to\n                                    // definitely be called after the section is removed from the DOM.\n                                    ajaxTracker.complete('section_delete');\n                                })\n                                .always(function() {\n                                    // Allow another request now this has finished.\n                                    footerAlert.hideAndReset();\n                                })\n                                .fail(function() {\n                                    ajaxTracker.complete('section_delete');\n                                });\n                        })\n                        .fail(function(response) {\n                            ajaxNotify.ifErrorShowBestMsg(response);\n                            footerAlert.hideAndReset();\n                            // Allow another request now this has finished.\n                            ajaxTracker.complete('section_delete');\n                        });\n                };\n\n                var delTitle = M.util.get_string('confirm', 'moodle');\n                var delConf = M.util.get_string('confirmdeletesection', 'moodle', sectionName);\n                var ok = M.util.get_string('deletesectionconfirm', 'theme_snap');\n                var cancel = M.util.get_string('cancel', 'moodle');\n                notification.confirm(delTitle, delConf, ok, cancel, doDelete);\n            };\n\n            /**\n             * Generic action handler for all asset actions.\n             * @param {event} e\n             * @param {domNode} triggerEl\n             */\n            var assetAction = function(e, triggerEl) {\n                e.preventDefault();\n\n                var assetEl = $($(triggerEl).parents('.snap-asset')[0]),\n                    cmid = Number(assetEl[0].id.replace('module-', '')),\n                    instanceName = assetEl.find('.instancename').text().trim(),\n                    action = $(triggerEl).data('action'),\n                    errActionKey = '',\n                    errMessageKey = '',\n                    errAction = '',\n                    errMessage = '',\n                    jsPendingKey = 'asset_' + action;\n\n                if (ajaxTracker.ajaxing(jsPendingKey)) {\n                    // Already in progress.\n                    // We check this because we don't want to show the confirmation dialog when in progress.\n                    return;\n                }\n\n                var actionAJAX = function() {\n                    if (!ajaxTracker.start(jsPendingKey, assetEl, '.snap-edit-asset-more')) {\n                        // Request already made.\n                        return;\n                    }\n\n                    var params = {\n                        'action': action,\n                        'sectionreturn': null,\n                        'id': cmid\n                    };\n\n                    ajax.call([\n                        {\n                            methodname: 'core_course_edit_module',\n                            args: params\n                        }\n                    ], true, true)[0]\n                        .done(function(response) {\n                            ajaxNotify.ifErrorShowBestMsg(response, errAction, errMessage).done(function(errorShown) {\n                                ajaxTracker.complete(jsPendingKey);\n                                if (errorShown) {\n                                    log.debug('Ajax request fail');\n                                    return;\n                                } else {\n                                    log.debug('Ajax request successful');\n\n                                    // Reset module cache.\n                                    moduleCache = null;\n                                    progressCache = null;\n                                    if (action === 'delete') {\n                                        // Remove asset from DOM.\n                                        assetEl.remove();\n                                        // Remove asset searchable.\n                                        $('#toc-searchables li[data-id=\"' + cmid + '\"]').remove();\n                                    } else if (action === 'show') {\n                                        assetEl.removeClass('draft');\n                                        assetEl.removeClass('stealth');\n                                    } else if (action === 'hide') {\n                                        assetEl.removeClass('stealth');\n                                        assetEl.addClass('draft');\n                                    } else if (action === 'duplicate') {\n                                        assetEl.replaceWith(response);\n                                    } else if (action === 'stealth') {\n                                        assetEl.addClass('stealth');\n                                        assetEl.removeClass('draft');\n                                    }\n                                }\n                            });\n                        })\n                        .fail(function(response) {\n                            ajaxNotify.ifErrorShowBestMsg(response, errAction, errMessage).done(function() {\n                                ajaxTracker.complete(jsPendingKey);\n                            });\n                        })\n                        .always(function() {\n                            footerAlert.hideAndReset();\n                        });\n                };\n\n                /**\n                 * Get error strings incase of AJAX failure.\n                 * @returns {*|Promise}\n                 */\n                var getErrorStrings = function() {\n                    if (action === 'duplicate') {\n                        errActionKey = 'action:duplicateasset';\n                        errMessageKey = 'error:failedtoduplicateasset';\n                    } else if (action === 'show' || action === 'hide') {\n                        errActionKey = 'action:changeassetvisibility';\n                        errMessageKey = 'error:failedtochangeassetvisibility';\n                    } else if (action === 'delete') {\n                        errActionKey = 'action:deleteasset';\n                        errMessageKey = 'error:failedtodeleteasset';\n                    }\n                    return str.get_strings([\n                        {key: errActionKey, component: 'theme_snap'},\n                        {key: errMessageKey, component: 'theme_snap'}\n                    ]);\n                };\n\n                getErrorStrings().then(function(strings) {\n                    errAction = strings[0];\n                    errMessage = strings[0];\n                    if (action === 'delete') {\n                        // Create confirmation strings.\n                        var delConf = '',\n                            plugindata = {\n                                type: M.util.get_string('pluginname', assetEl.attr('class').match(/modtype_([^\\s]*)/)[1])\n                            };\n                        if (instanceName !== '') {\n                            plugindata.name = instanceName;\n                            delConf = M.util.get_string('deletechecktypename', 'moodle', plugindata);\n                        } else {\n                            delConf = M.util.get_string('deletechecktype', 'moodle', plugindata);\n                        }\n\n                        var delTitle = M.util.get_string('confirm', 'moodle');\n                        var ok = M.util.get_string('deleteassetconfirm', 'theme_snap', plugindata.type);\n                        var cancel = M.util.get_string('cancel', 'moodle');\n                        notification.confirm(delTitle, delConf, ok, cancel, actionAJAX);\n                    } else {\n                        actionAJAX();\n                    }\n                });\n            };\n\n            /**\n             * Ajax request to move asset to target.\n             * @param {object} target\n             */\n            var ajaxReqMoveAsset = function(target) {\n                var params = {};\n\n                log.debug('Move objects', movingObjects);\n\n                // Prepare request parameters\n                params.class = 'resource';\n\n                updateMovingMessage();\n\n                movingObject = movingObjects.shift();\n\n                params.id = Number(movingObject.id.replace('module-', ''));\n\n                if (target && !$(target).hasClass('snap-drop')) {\n                    params.beforeId = Number($(target)[0].id.replace('module-', ''));\n                } else {\n                    params.beforeId = 0;\n                }\n\n                if (document.body.id === \"page-site-index\") {\n                    params.sectionId = 1;\n                } else {\n                    if (target) {\n                        params.sectionId = parentSectionNumber(target);\n                    } else {\n                        params.sectionId = parentSectionNumber(movingObject);\n                    }\n                }\n\n                if (movingObjects.length > 0) {\n                    ajaxReqMoveGeneral(params, function() {\n                        $(target).before($(movingObject));\n                        // recurse\n                        ajaxReqMoveAsset(target);\n                    }, false);\n                } else {\n                    ajaxReqMoveGeneral(params, function() {\n                        $(target).before($(movingObject));\n                    }, true);\n                }\n\n            };\n\n            /**\n             * Ajax request to move section to target.\n             * @param {str|object} dropzone\n             */\n            var ajaxReqMoveSection = function(dropzone) {\n                var domTargetSection = parentSectionNumber(dropzone);\n                var currentSection = sectionNumber(movingObjects[0]);\n                var targetSection = currentSection < domTargetSection ?\n                        domTargetSection - 1 :\n                        domTargetSection;\n\n                var params = {\n                    \"class\": 'section',\n                    id: currentSection,\n                    value: targetSection\n                };\n\n                ajaxReqMoveGeneral(params, function() {\n\n                    // Update TOC chapters.\n                    ajax.call([\n                        {\n                            methodname: 'theme_snap_course_toc_chapters',\n                            args: {\n                                courseshortname: courseLib.courseConfig.shortname\n                            },\n                            done: function(response) {\n                                // Update TOC.\n                                templates.render('theme_snap/course_toc_chapters', response.chapters)\n                                    .done(function(result) {\n                                        // Update chapters.\n                                        $('#chapters').replaceWith(result);\n\n                                        // Move current section before target section.\n                                        $('#section-' + domTargetSection).before($('#section-' + currentSection));\n\n                                        // Update section ids, next previous links, etc.\n                                        updateSections(currentSection, targetSection, [], null);\n\n                                        // Navigate to section in its new location.\n                                        location.hash = 'section-' + targetSection;\n                                        courseLib.showSection();\n\n                                        // Finally, we have finished moving the section!\n                                        stopMoving();\n                                    });\n                            },\n                            fail: function(response) {\n                                ajaxNotify.ifErrorShowBestMsg(response);\n                                stopMoving();\n                            }\n                        }\n                    ], true, true);\n\n                }, true);\n            };\n\n            /**\n             * Listen for edit action clicks, hide, show, duplicate, etc..\n             */\n            var assetEditListeners = function() {\n                var actionSelectors = '.snap-asset-actions .js_snap_hide, ';\n                actionSelectors += '.snap-asset-actions .js_snap_show, ';\n                actionSelectors += '.snap-asset-actions .js_snap_delete, ';\n                actionSelectors += '.snap-asset-actions .js_snap_duplicate,';\n                actionSelectors += '.snap-asset-actions .js_snap_stealth';\n\n                $(document).on('click', actionSelectors, function(e) {\n                    assetAction(e, this);\n                });\n            };\n\n            /**\n             * Listen for availability actions, hide, show, stealth.\n             */\n            var availabilityListeners = function() {\n                $(document).on('click', '#availability-menu .choicelist div[data-optionnumber]',\n                    function(e) {\n                        e.preventDefault();\n                        const cmIds = [];\n                        let courseId = self.courseConfig.id;\n                        let dataId = $(this).find('.option-name a').attr('data-id');\n                        let dataAction = $(this).find('.option-name a').attr('data-action');\n                        let url = $(this).find('.option-name a').attr('href');\n\n                        if (dataAction === 'cmShow') {\n                            dataAction = 'cm_show';\n                        } else if (dataAction === 'cmHide') {\n                            dataAction = 'cm_hide';\n                        } else if (dataAction === 'cmStealth') {\n                            dataAction = 'cm_stealth';\n                        }\n                        cmIds.push(dataId);\n\n                        ajax.call([\n                            {\n                                methodname: 'core_courseformat_update_course',\n                                args: {action: dataAction, courseid: courseId, ids: cmIds},\n                                done: function(res) {\n                                    res = JSON.parse(res);\n                                    let cmid = res[0].fields.id;\n                                    let module = $('#module-' + cmid);\n                                    module.find('#availability-menu .selected .option-select-indicator [data-for=\"checkedIcon\"]')\n                                        .addClass('d-none');\n                                    module.find('#availability-menu .selected .option-select-indicator [data-for=\"uncheckedIcon\"]')\n                                        .removeClass('d-none');\n                                    module.find('#availability-menu .selected').removeClass('border bg-primary-light selected');\n                                    if (res[0].fields.visible) {\n                                        if (res[0].fields.stealth) {\n                                            module.addClass('stealth');\n                                            module.removeClass('draft');\n                                            var selected = module.find('#availability-menu a[data-action=\"cmStealth\"]');\n                                        } else {\n                                            module.removeClass('stealth');\n                                            module.removeClass('draft');\n                                            var selected = module.find('#availability-menu a[data-action=\"cmShow\"]');\n                                        }\n                                    } else {\n                                        module.addClass('draft');\n                                        module.removeClass('stealth');\n                                        var selected = module.find('#availability-menu a[data-action=\"cmHide\"]');\n                                    }\n                                    selected.parents('div[data-optionnumber][data-selected]')\n                                        .addClass('border bg-primary-light selected');\n                                    let indicator = selected.parent().siblings('.option-select-indicator');\n                                    indicator.find('span[data-for=\"checkedIcon\"]').removeClass('d-none');\n                                    indicator.find('span[data-for=\"uncheckedIcon\"]').addClass('d-none');\n                                },\n                                fail: function(reason) {\n                                    if (reason.errorcode === 'nopermissions') {\n                                        // Open the availability URL like Boost does for non Admin users.\n                                        window.open(url, \"_self\");\n                                    } else {\n                                        ajaxNotify.ifErrorShowBestMsg(reason);\n                                    }\n                                },\n                            }\n                        ]);\n                    }\n                );\n            };\n\n            /**\n             * Listen for group mode actions.\n             */\n            var groupModeListeners = function() {\n                $(document).on('click',\n                    '#snap-groups-menu .dropdown-item-outline, .groups-dropdown-menu .dropdown-item-outline',\n                        function(e) {\n                        e.preventDefault();\n                        const cmIds = [];\n                        let courseId = self.courseConfig.id;\n                        let dataId = $(this).find('.option-name a').attr('data-id');\n                        let dataAction = $(this).find('.option-name a').attr('data-action');\n                        let dataOptionNumber = $(this).attr('data-optionnumber');\n                        let actionText = '';\n                        if (dataAction === 'cmNoGroups') {\n                            dataAction = 'cm_nogroups';\n                            actionText = M.util.get_string('groupsnone', 'moodle');\n                        } else if (dataAction === 'cmSeparateGroups') {\n                            dataAction = 'cm_separategroups';\n                            actionText = M.util.get_string('groupsseparate', 'moodle');\n                        } else if (dataAction === 'cmVisibleGroups') {\n                            dataAction = 'cm_visiblegroups';\n                            actionText = M.util.get_string('groupsvisible', 'moodle');\n                        }\n                        cmIds.push(dataId);\n                        ajax.call([\n                            {\n                                methodname: 'core_courseformat_update_course',\n                                args: {action: dataAction, courseid: courseId, ids: cmIds},\n                                done: function() {\n                                    let activityCard = $('#module-'+dataId);\n\n                                    let selectedIconUrl = $(activityCard).find(\n                                        '[data-optionnumber='+dataOptionNumber+'] .option-icon img'\n                                    ).attr('src');\n\n                                    $(activityCard).find(\n                                        '.snap-activity-groups-dropdown .snap-groups-more img'\n                                    ).attr('src', selectedIconUrl);\n\n                                    $(activityCard).find(\n                                        '.snap-activity-groups-dropdown .snap-groups-more img'\n                                    ).attr('alt', actionText);\n\n                                    $(activityCard).find(\n                                        '#snap-groups-menu .border.bg-primary-light.selected,' +\n                                        '.groups-dropdown-menu .border.bg-primary-light.selected'\n                                    ).removeClass('border bg-primary-light selected');\n                                    $(activityCard).find(\n                                        '#snap-groups-menu a.selected,' +\n                                        '.groups-dropdown-menu a.selected'\n                                    ).removeClass('selected');\n                                    $(activityCard).find(\n                                        '.option-select-indicator [data-for=\"checkedIcon\"]'\n                                    ).addClass('d-none');\n                                    $(activityCard).find(\n                                        '.option-select-indicator [data-for=\"uncheckedIcon\"]'\n                                    ).removeClass('d-none');\n\n                                    $(activityCard).find(\n                                        '[data-optionnumber='+dataOptionNumber+']'\n                                    ).addClass('border bg-primary-light selected');\n                                    $(activityCard).find(\n                                        '.groups-dropdown-menu a[data-id='+dataId+'], ' +\n                                        '#snap-groups-menu a.selected'\n                                    ).addClass('selected');\n                                    $(activityCard).find(\n                                        '[data-optionnumber='+dataOptionNumber+'] ' +\n                                        '.option-select-indicator [data-for=\"checkedIcon\"]'\n                                    ).removeClass('d-none');\n                                    $(activityCard).find(\n                                        '[data-optionnumber='+dataOptionNumber+'] ' +\n                                        '.option-select-indicator  [data-for=\"uncheckedIcon\"]'\n                                    ).addClass('d-none');\n                                },\n                            }\n                        ]);\n                    });\n            };\n\n            /**\n             * Listen for sub dropdowns changes.\n             */\n            var subPanelListeners = function() {\n                $(document).on('click', '.dropdown-subpanel', function(e) {\n                    e.stopPropagation();\n                    $('.dropdown-subpanel').not(this).find('.dropdown-subpanel-content').hide();\n                    $('.dropdown-subpanel').not(this).find('.dropdown-toggle').removeClass('active');\n                    if ($(this).find('.dropdown-toggle').hasClass('active')) {\n                        // Closing the parent dropdown.\n                        $(this).parent().parent().click();\n                        $(this).parent().parent().blur();\n                        $(this).find('.dropdown-subpanel-content').hide();\n                        $(this).find('.dropdown-toggle').removeClass('active');\n                    } else {\n                        $(this).find('.dropdown-subpanel-content').show();\n                        $(this).find('.dropdown-toggle').addClass('active');\n                    }\n                });\n\n                // If we click outside the subpanel element.\n                $(document).on('click', function(event) {\n                    var subPanelElement = $('.dropdown-subpanel');\n                    if (!subPanelElement.is(event.target) && !subPanelElement.has(event.target).length) {\n                        $('#snap-asset-menu .dropdown-subpanel-content').hide();\n                        $('#snap-asset-menu .dropdown-toggle').removeClass('active');\n                    }\n                });\n            };\n\n            /**\n             * Generic section action handler.\n             *\n             * @param {string} action visibility, highlight\n             * @param {null|function} onComplete for when completed.\n             */\n            var sectionActionListener = function(action, onComplete) {\n\n                let selector = '.snap-section-editing.actions .snap-' + action;\n                if ($('.snap-section-editing.actions .snap-' + action).parents('.dropdown-item').length > 0) {\n                    selector = '.snap-section-editing.actions .dropdown-item:has(.snap-' + action + ')';\n                }\n                $('#region-main').on('click', selector, function(e) {\n                    const activeDropdownSel = '#extra-actions-dropdown-' + parentSectionNumber(this);\n                    if($(activeDropdownSel).dropdown().parent().hasClass('show')) {\n                        $(activeDropdownSel).dropdown('toggle');\n                    }\n                    e.stopPropagation();\n                    e.preventDefault();\n\n                    var trigger = this;\n\n                    /**\n                     * Invalid section action exception.\n                     *\n                     * @param {string} action\n                     */\n                    var InvalidActionException = function(action) {\n                        this.message = 'Invalid section action: ' + action;\n                        this.name = 'invalidActionException';\n                    };\n\n                    // Check action is valid.\n                    var validactions = ['visibility', 'highlight'];\n                    if (validactions.indexOf(action) === -1) {\n                        throw new InvalidActionException(action);\n                    }\n\n                    if (!ajaxTracker.start('section_' + action, trigger)) {\n                        // Request already in progress.\n                        return;\n                    }\n\n                    // For toggling visibility.\n                    var toggle, loadModules = true;\n                    if (action === 'visibility') {\n                        toggle = $(this).hasClass('snap-hide') ? 0 : 1;\n                        if (moduleCache && moduleCache.length > 0 && progressCache && progressCache.length > 0) {\n                            loadModules = false;\n                        }\n                    } else {\n                        // For toggling highlight/mark as current.\n                        toggle = $(this).attr('aria-pressed') === 'true' ? 0 : 1;\n                    }\n                    var sectionNumber = parentSectionNumber(this);\n                    var sectionActionsSelector = '#section-' + sectionNumber + ' .snap-section-editing';\n                    var actionSelector = sectionActionsSelector + ' .snap-' + action;\n\n                    // Make ajax call.\n                    var ajaxPromises = ajax.call([\n                        {\n                            methodname: 'theme_snap_course_sections',\n                            args : {\n                                courseshortname: courseLib.courseConfig.shortname,\n                                action: action,\n                                sectionnumber: sectionNumber,\n                                value: toggle,\n                                loadmodules: loadModules,\n                            }\n                        }\n                    ], true, true);\n\n                    // Handle ajax promises.\n                    ajaxPromises[0]\n                    .fail(function(response) {\n                        var errMessage, errAction;\n                        if (action === 'visibility') {\n                            errMessage = M.util.get_string('error:failedtochangesectionvisibility', 'theme_snap');\n                            errAction = M.util.get_string('action:changesectionvisibility', 'theme_snap');\n                        } else {\n                            errMessage = M.util.get_string('error:failedtohighlightsection', 'theme_snap');\n                            errAction = M.util.get_string('action:highlightsectionvisibility', 'theme_snap');\n                        }\n                        ajaxNotify.ifErrorShowBestMsg(response, errAction, errMessage).done(function() {\n                            // Allow another request now this has finished.\n                            ajaxTracker.complete('section_' + action);\n                        });\n                    }).always(function() {\n                        $(trigger).removeClass('ajaxing');\n                    }).done(function(response) {\n                        // Update section action and then reload TOC.\n                        // Checking if action is inside the menu.\n                        if ($(actionSelector).parents('.dropdown-item').length > 0) {\n                            response.actionmodel.isinmenu = true;\n                        }\n                        return templates.render('theme_snap/course_action_section', response.actionmodel)\n                        .then(function(result) {\n                            // Checking if action is inside the menu.\n                            if ($(actionSelector).parents('.dropdown-item').length > 0) {\n                                $(actionSelector).parent().parent('li').replaceWith(result);\n                            } else {\n                                $(actionSelector).parent('li').replaceWith(result);\n                                $(actionSelector).focus();\n                            }\n                            // Update TOC.\n                            if (!loadModules) {\n                                if (moduleCache && moduleCache.length > 0 && response.toc.modules.length === 0) {\n                                    // Modules not loaded on request. Replacing them on the toc.\n                                    response.toc.modules = moduleCache;\n                                }\n\n                                if (progressCache && progressCache.length > 0) {\n                                    var progressCacheCopy = progressCache.slice(0);\n                                    $.each(response.toc.chapters.chapters, function(index) {\n                                        response.toc.chapters.chapters[index].progress = progressCacheCopy.shift();\n                                    });\n                                }\n                            }\n\n                            if (loadModules) {\n                                // Caching modules for future use.\n                                moduleCache = response.toc.modules;\n\n                                // Caching progress for future use.\n                                progressCache = [];\n                                $.each(response.toc.chapters.chapters, function(index, value) {\n                                    progressCache.push(value.progress);\n                                });\n                            }\n\n                            return templates.render('theme_snap/course_toc', response.toc);\n                        }).then(function(result) {\n                            $('#course-toc').html($(result).html());\n                            $(document).trigger('snapTOCReplaced');\n                            if (onComplete && typeof (onComplete) === 'function') {\n                                var completion = onComplete(sectionNumber, toggle);\n                                if (self.courseConfig.partialrender) {\n                                    if (typeof onComplete === 'function') {\n                                        ajaxTracker.complete('section_' + action);\n                                    }\n                                } else {\n                                    if (completion && typeof (completion.always) === 'function') {\n                                        // Callback returns a promise, js no longer running.\n                                        completion.always(\n                                            function() {\n                                                // Allow another request now this has finished.\n                                                ajaxTracker.complete('section_' + action);\n                                            }\n                                        );\n                                    } else {\n                                        // Callback does not return a promise, js no longer running.\n                                        // Allow another request now this has finished.\n                                        ajaxTracker.complete('section_' + action);\n                                    }\n                                }\n                            } else {\n                                // Allow another request now this has finished.\n                                ajaxTracker.complete('section_' + action);\n                            }\n                        });\n                    });\n                });\n            };\n\n            /**\n             * Highlight section on click.\n             */\n            var highlightSectionListener = function() {\n                sectionActionListener('highlight', function(sectionNumber) {\n                    $('#section-' + sectionNumber).toggleClass('current');\n\n                    // Reset sections which are not highlighted.\n                    var $notCurrent = $('li.section.main')\n                    .not('#section-' + sectionNumber)\n                    .not('#section-0').removeClass(\"current\");\n\n                    $notCurrent.each(function() {\n                        var highlighter = this.querySelector('.snap-highlight');\n                        var sectionNumber = parentSectionNumber(highlighter);\n                        let highlighterref = '';\n                        var highlightString = M.util.get_string('highlight', 'moodle');\n                        if (highlighter.closest('.dropdown-item') !== null) {\n                            highlighterref = highlighter.parentElement\n                                .getAttribute('href')\n                                .replace(/(marker=)[0-9]+/ig, '$1' + sectionNumber);\n                            highlighter.innerHTML = highlightString;\n                            highlighter.setAttribute('href', highlighterref);\n                            highlighter.setAttribute('aria-pressed', 'false');\n                            highlighter.parentElement.setAttribute('href', highlighterref);\n                            highlighter.parentElement.setAttribute('aria-pressed', 'false');\n                            highlighter.parentElement.setAttribute('aria-label', highlightString);\n                        } else {\n                            highlighterref = highlighter.parentElement\n                                .getAttribute('href')\n                                .replace(/(marker=)[0-9]+/ig, '$1' + sectionNumber);\n                            highlighter.innerHTML = highlightString;\n                            highlighter.setAttribute('href', highlighterref);\n                            highlighter.setAttribute('aria-pressed', 'false');\n                        }\n                    });\n                });\n            };\n\n            /**\n             * Delete section on click.\n             */\n            var deleteSectionListener = function() {\n                $(document).on('click', '.snap-section-editing.actions .snap-delete', function(e) {\n                    sectionDelete(e, this);\n                });\n            };\n\n            /**\n             * Show section permalink on click.\n             */\n            var permalinkSectionListener = function() {\n                $(document).on('click', '.snap-section-editing.actions .snap-permalink', function(e) {\n                    e.preventDefault();\n                    ModalCopyToClipboard.create({\n                            text: this.parentNode.getAttribute('href'),\n                        }, str.get_string('sectionlink', 'course')\n                    );\n                });\n            };\n\n            /**\n             * Toggle section visibility on click.\n             */\n            var toggleSectionListener = function() {\n                /**\n                 * Toggle hidden class and update section navigation.\n                 * @param {number} sectionNumber\n                 * @param {boolean} toggle\n                 * @returns {Promise}\n                 */\n                var manageHiddenClass = function(sectionNumber, toggle) {\n                    if (toggle === 0) {\n                        $('#section-' + sectionNumber).addClass('hidden');\n                    } else {\n                        $('#section-' + sectionNumber).removeClass('hidden');\n                        $('#section-' + sectionNumber + ' .stealth-section-hidden').removeClass('stealth');\n                        $('#section-' + sectionNumber + ' .stealth-section-hidden').removeClass('stealth-section-hidden');\n                    }\n\n                    // Update the section navigation either side of the current section.\n                    var selectors = [\n                        '#section-' + (sectionNumber - 1),\n                        '#section-' + (sectionNumber + 1)\n                    ];\n                    var selector = selectors.join(',');\n                    return updateSectionNavigation(selector);\n                };\n                sectionActionListener('visibility', manageHiddenClass);\n            };\n\n            /**\n             * Show footer alert for moving.\n             *\n             * @param {domNode} focusEl The element to be focused after this callback.\n             */\n            var footerAlertShowMove = function(focusEl = null) {\n                footerAlert.show(function(e) {\n                    e.preventDefault();\n                    stopMoving();\n                    $('.snap-asset-move-wrapper').attr('hidden', 'hidden');\n                    if (focusEl !== null) {\n                        focusEl.focus();\n                    }\n                });\n            };\n\n            /**\n             * When section move link is clicked, get the data we need and start the move.\n             */\n            var moveSectionListener = function() {\n                // Listen clicks on move links.\n                $(\"#region-main\").on('click', '.snap-section-editing.actions .snap-move', function(e) {\n                    e.stopPropagation();\n                    e.preventDefault();\n\n                    $('body').addClass('snap-move-inprogress');\n                    footerAlertShowMove();\n\n                    // Moving a section.\n                    var sectionNumber = parentSectionNumber(this);\n                    log.debug('Section is', sectionNumber);\n                    var section = $('#section-' + sectionNumber);\n                    var sectionName = section.find('.sectionname').text();\n\n                    log.debug('Moving this section', sectionName);\n                    movingObjects = [section];\n                    // This should never happen, but just in case...\n                    $('.section-moving').removeClass('section-moving');\n                    section.addClass('section-moving');\n                    $('a[href=\"#section-' + sectionNumber + '\"]').parent('li').addClass('section-moving');\n                    $('body').addClass('snap-move-section');\n                    if (self.courseConfig.partialrender) {\n                        $('#section-' + (sectionNumber + 1) + ' .snap-drop.section-drop').removeClass('partial-render');\n                    }\n                    var title = M.util.get_string('moving', 'theme_snap', sectionName);\n                    footerAlert.setTitle(title);\n                    updateSectionDropMsg(sectionName);\n                });\n            };\n\n            /**\n             * Add drop zones at the end of sections.\n             */\n            var addAfterDrops = function() {\n                if (document.body.id === \"page-site-index\") {\n                    $('#region-main .sitetopic ul.section').append(\n                        '<li class=\"snap-drop asset-drop\">' +\n                        '<div class=\"asset-wrapper\">' +\n                        '<a href=\"#\">' +\n                        M.util.get_string('movehere', 'theme_snap') +\n                        '</a>' +\n                        '</div>' +\n                        '</li>');\n                } else {\n                    $('li.section .content ul.section').append(\n                        '<li class=\"snap-drop asset-drop\">' +\n                        '<div class=\"asset-wrapper\">' +\n                        '<a href=\"#\">' +\n                        M.util.get_string('movehere', 'theme_snap') +\n                        '</a>' +\n                        '</div>' +\n                        '</li>');\n                }\n            };\n\n            /**\n             * Add listener for move checkbox.\n             */\n            var assetMoveListener = function() {\n                $(\"#region-main\").on('change', '.js-snap-asset-move', function(e) {\n                    e.stopPropagation();\n\n                    var asset = $(this).parents('.snap-asset')[0];\n\n                    // Make sure after drop is at the end of section.\n                    var section = $(asset).parents('ul.section')[0];\n                    var afterdrop = $(section).find('li.snap-drop.asset-drop');\n                    $(section).append(afterdrop);\n\n                    if (movingObjects.length === 0) {\n                        // Moving asset - activity or resource.\n                        // Initiate move.\n                        $('.snap-asset-move-wrapper').removeAttr('hidden');\n                        $('.readmore-container').attr('hidden', 'hidden');\n\n                        var assetname = $(asset).find('.snap-asset-link .instancename').html();\n\n                        log.debug('Moving this asset', assetname);\n\n                        var classes = $(asset).attr('class'),\n                            regex = /(?=snap-mime)([a-z0-9\\-]*)/;\n                        var assetclasses = regex.exec(classes);\n                        classes = '';\n                        if (assetclasses) {\n                            classes = assetclasses.join(' ');\n                        }\n                        log.debug('Moving this class', classes);\n                        $(asset).addClass('asset-moving');\n                        $('.snap-asset button').attr('disabled','disabled');\n                        $(asset).find('button').removeAttr('disabled');\n                        $('.snap-asset .snap-asset-content a').attr('tabindex','-1');\n                        $('.snap-asset .mod-link').attr('tabindex','-1');\n                        $(asset).find('a').removeAttr('tabindex');\n\n                        $(asset).find('.js-snap-asset-move').prop('checked', 'checked');\n\n                        $('body').addClass('snap-move-inprogress');\n                        $('body').addClass('snap-move-asset');\n\n                    }\n\n                    if ($(this).prop('checked')) {\n                        // Add asset to moving array.\n                        movingObjects.push(asset);\n                        $(asset).find('a').removeAttr('tabindex');\n                        $(asset).find('button').removeAttr('disabled');\n                        $(asset).addClass('asset-moving');\n                    } else {\n                        // Remove from moving array.\n                        removeMovingObject(asset);\n                        // Remove moving class\n                        $(asset).find('.snap-asset-content a').attr('tabindex','-1');\n                        $(asset).find('button').attr('disabled','disabled');\n                        $(asset).removeClass('asset-moving');\n                        if (movingObjects.length === 0) {\n                            // Nothing is ticked for moving, cancel the move.\n                            stopMoving();\n                        }\n                    }\n                    footerAlertShowMove($(this));\n                    updateMovingMessage();\n                });\n            };\n\n            /**\n             * When an asset or drop zone is clicked, execute move.\n             */\n            var movePlaceListener = function() {\n                $(document).on('click', '.snap-move-note, .snap-drop', function(e) {\n                    log.debug('Snap drop clicked', e);\n                    if (movingObjects) {\n                        e.stopPropagation();\n                        e.preventDefault();\n                        if ($('body').hasClass('snap-move-section')) {\n                            ajaxReqMoveSection(this);\n                        } else {\n                            var target;\n                            if ($(this).hasClass('snap-drop')) {\n                                target = this;\n                            } else {\n                                target = $(this).closest('.snap-asset');\n                            }\n                            ajaxReqMoveAsset(target);\n                        }\n                    }\n                });\n            };\n\n            /**\n             * Set observers for TOC and navigation buttons in the footer.\n             */\n            var setCourseSectionObervers = function () {\n                setTocObservers();\n                setNavigationFooterObservers();\n            };\n\n            /**\n             * Add listeners.\n             */\n            var addListeners = function() {\n                moveSectionListener();\n                toggleSectionListener();\n                highlightSectionListener();\n                deleteSectionListener();\n                permalinkSectionListener();\n                assetMoveListener();\n                movePlaceListener();\n                assetEditListeners();\n                availabilityListeners();\n                groupModeListeners();\n                subPanelListeners();\n                addAfterDrops();\n                if (courseLib.courseConfig.partialrender) {\n                    setCourseSectionObervers();\n                }\n                $('body').addClass('snap-course-listening');\n            };\n\n            /**\n             * Override core functions.\n             */\n            var overrideCore = function() {\n                // Check M.course exists (doesn't exist in social format).\n                if (M.course && M.course.resource_toolbox) {\n                    /* eslint-disable camelcase */\n                    M.course.resource_toolbox.handle_resource_dim = function(button, activity, action) {\n                        return (action === 'hide') ? 0 : 1;\n                    };\n                    /* eslint-enable camelcase */\n                }\n            };\n\n            /**\n             * Make an Ajax request for caching the TOC so it's not so expensive to hide and show sections.\n             */\n            var cacheTOC = function() {\n                if ($('.snap-section-editing.actions').length === 0) {\n                    // Only cache the TOC if there are sections.\n                    return;\n                }\n\n                var action = 'toc';\n\n                var trigger = $('#region-main');\n\n                if (!ajaxTracker.start('section_' + action, trigger)) {\n                    // Request already in progress.\n                    return;\n                }\n\n                // Make ajax call.\n                var ajaxPromises = ajax.call([\n                    {\n                        methodname: 'theme_snap_course_sections',\n                        args : {\n                            courseshortname: courseLib.courseConfig.shortname,\n                            action: action,\n                            sectionnumber: 0,\n                            value: 0,\n                            loadmodules: 0,\n                        }\n                    }\n                ], true, true);\n\n                // Handle ajax promises.\n                ajaxPromises[0]\n                .fail(function(response) {\n                    var errMessage, errAction;\n                    errMessage = M.util.get_string('error:failedtotoc', 'theme_snap');\n                    errAction = M.util.get_string('action:sectiontoc', 'theme_snap');\n                    ajaxNotify.ifErrorShowBestMsg(response, errAction, errMessage).done(function() {\n                        // Allow another request now this has finished.\n                        ajaxTracker.complete('section_' + action);\n                    });\n                }).always(function() {\n                    $(trigger).removeClass('ajaxing');\n                }).done(function(response) {\n                    // Caching modules for future use.\n                    moduleCache = response.toc.modules;\n\n                    // Caching progress for future use.\n                    progressCache = [];\n                    $.each(response.toc.chapters.chapters, function(index, value) {\n                        progressCache.push(value.progress);\n                    });\n\n                    ajaxTracker.complete('section_' + action);\n                });\n            };\n\n            /**\n             * Initialise script.\n             */\n            var initialise = function() {\n                // Add listeners.\n                addListeners();\n\n                // Cache TOC.\n                cacheTOC();\n\n                // Override core functions\n                util.whenTrue(function() {\n                    return M.course && M.course.init_section_toolbox;\n                }, function() {\noverrideCore();\n}, true);\n\n            };\n            initialise();\n        },\n\n        /**\n         * Exposed function that renders a specific course section and sets focus on an activity module.\n         * @param {string} section\n         * @param {string} mod\n         */\n        renderAndFocusSection: function(section, mod) {\n            getSection(section, mod);\n        },\n\n        setTocObserver: function() {\n            setTocObservers();\n        }\n    };\n\n});\n"],"names":["define","$","log","ajax","str","templates","notification","util","ajaxNotify","footerAlert","Event","fragment","ModalCopyToClipboard","movingObject","ajaxTracker","self","this","movingObjects","ajaxing","sectionsProcess","moduleCache","progressCache","setTocObservers","courseConfig","format","click","e","section","target","attr","length","getSection","split","urlParams","mod","updateMovingMessage","title","assetname","find","html","M","get_string","setTitle","updateSectionDropMsg","sectionName","each","sectionDropMsg","moving","before","data","setSrNotice","indexOf","push","params","courseid","id","show","hide","loadFragment","contextid","done","js","node","renderSection","folders","index","folder","content","folderAssetTypeHeader","prependTo","anchor","existingSections","parseInt","tempnode","replaceNodeContents","remove","closest","reduce","prev","curr","Math","abs","contents","after","runTemplateJS","notifyFilterContentUpdated","sections","removeClass","addClass","toctype","elements","tmpid","key","element","sectionNum","newLink","href","replace","modid","targmod","scrollToElement","searchpin","prepend","focus","scrollToModule","text","movingId","visibleSectionLink","parent","append","modchooserSectionReturn","init","courseLib","triggersByKey","start","jsPendingKey","trigger","subSelector","debug","js_pending","pending_js","complete","js_complete","sectionNumber","el","partialrender","parentSectionNumber","parents","stopMoving","hideAndReset","removeAttr","prop","moveFailed","actname","removeAjaxLoading","window","setTimeout","ajaxReqMoveGeneral","onSuccess","finalItem","addAjaxLoading","sesskey","cfg","courseId","field","req","type","async","url","wwwroot","ajaxurl","ifErrorShowBestMsg","errorShown","class","fail","always","getSectionTitle","updateSectionNavigation","selector","totalSectionCount","dfd","Deferred","allSections","completed","idx","extraclasses","previousSection","nextSection","previous","next","hasClass","classes","navigation","render","result","replaceWith","resolve","promise","updateSections","current","predeleteSections","deletedSection","loadedSections","obj","newOrder","oldIndex","newIndex","k","undefined","splice","calculateSections","value","chapterTitle","fullTitle","setCourseSectionObervers","ajaxReqMoveAsset","shift","Number","beforeId","document","body","sectionId","assetEditListeners","on","actionSelectors","triggerEl","preventDefault","assetEl","cmid","instanceName","trim","action","errActionKey","errMessageKey","errAction","errMessage","actionAJAX","call","methodname","args","response","get_strings","component","then","strings","delConf","plugindata","match","name","delTitle","ok","cancel","confirm","assetAction","sectionActionListener","onComplete","activeDropdownSel","dropdown","stopPropagation","message","toggle","loadModules","actionSelector","courseshortname","shortname","sectionnumber","loadmodules","actionmodel","isinmenu","toc","modules","progressCacheCopy","slice","chapters","progress","completion","deleteSectionListener","delProgress","ajaxPromises","ids","location","hash","showSection","sectionDelete","footerAlertShowMove","focusEl","assetMoveListener","asset","afterdrop","assetclasses","exec","join","movePlaceListener","domTargetSection","currentSection","targetSection","addListeners","toggleClass","not","highlighter","querySelector","highlighterref","highlightString","parentElement","getAttribute","innerHTML","setAttribute","create","parentNode","cmIds","dataId","dataAction","res","JSON","parse","fields","module","visible","stealth","selected","indicator","siblings","reason","errorcode","open","dataOptionNumber","actionText","activityCard","selectedIconUrl","blur","event","subPanelElement","is","has","cacheTOC","whenTrue","course","init_section_toolbox","resource_toolbox","handle_resource_dim","button","activity","renderAndFocusSection","setTocObserver"],"mappings":"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"}