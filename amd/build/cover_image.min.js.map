{"version":3,"sources":["../src/cover_image.js"],"names":["define","$","log","ajax","notification","ajaxNotify","addCoverImageAlert","id","msg","closestr","M","util","get_string","length","before","humanFileSize","size","i","Math","floor","pow","toFixed","state1","removeClass","remove","addClass","val","state2","coverImage","siteMaxBytes","ajaxParams","data","css","click","e","preventDefault","file","filedata","on","files","target","type","match","reader","FileReader","onload","theFile","result","maxbytes","maxbytesstr","message","img","get","src","width","name","readAsDataURL","parent","hasClass","imageData","split","imagedata","imagefilename","call","methodname","args","params","done","response","contrast","success","warning","fail","ifErrorShowBestMsg","courseImage","courseCoverImage","courseShortName","categoryid","courseshortname","categoryImage","categoryCoverImage","categoryId"],"mappings":"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","sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package   theme_snap\n * @copyright Copyright (c) 2015 Blackboard Inc. (http://www.blackboard.com)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/log', 'core/ajax', 'core/notification', 'theme_snap/ajax_notification'],\n    function($, log, ajax, notification, ajaxNotify) {\n\n        // TODO - in Moodle 3.1 we should use the core template for this.\n        var addCoverImageAlert = function(id, msg) {\n            var closestr = M.util.get_string('closebuttontitle', 'moodle');\n            if (!$(id).length) {\n                $('#snap-coverimagecontrol').before(\n                    '<div id=\"' + id + '\" class=\"snap-alert-cover-image alert alert-warning\" role=\"alert\">' +\n                    msg +\n                    '<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"' + closestr + '\">' +\n                    '<span aria-hidden=\"true\">&times;</span>' +\n                    '</button>' +\n                    '</div>'\n                );\n            }\n        };\n\n        /**\n         * Get human file size from bytes.\n         * http://stackoverflow.com/questions/10420352/converting-file-size-in-bytes-to-human-readable.\n         * @param {int} size\n         * @returns {string}\n         */\n        var humanFileSize = function(size) {\n            var i = Math.floor(Math.log(size) / Math.log(1024));\n            return (size / Math.pow(1024, i)).toFixed(2) * 1 + ' ' + ['B', 'kB', 'MB', 'GB', 'TB'][i];\n        };\n\n        /**\n         * First state - image selection button visible.\n         */\n        var state1 = function() {\n            $('#snap-changecoverimageconfirmation .ok').removeClass('ajaxing');\n            $('#snap-alert-cover-image-size').remove();\n            $('#snap-alert-cover-image-bytes').remove();\n            $('label[for=\"snap-coverfiles\"]').removeClass('ajaxing');\n            $('#snap-changecoverimageconfirmation').removeClass('state-visible');\n            $('label[for=\"snap-coverfiles\"]').addClass('state-visible');\n            $('#snap-coverfiles').val('');\n        };\n\n        /**\n         * Second state - confirm / cancel buttons visible.\n         */\n        var state2 = function() {\n            $('#snap-alert-cover-image-upload-failed').remove();\n            $('#snap-changecoverimageconfirmation').removeClass('disabled');\n            $('label[for=\"snap-coverfiles\"]').removeClass('state-visible');\n            $('#snap-changecoverimageconfirmation').addClass('state-visible');\n            $('body').removeClass('cover-image-change');\n        };\n\n        /**\n         *\n         * @param {int} siteMaxBytes\n         * @param {object} ajaxParams\n         */\n        var coverImage = function(siteMaxBytes, ajaxParams) {\n            // Take a backup of what the current background image url is (if any).\n            $('#page-header').data('servercoverfile', $('#page-header').css('background-image'));\n\n            $('#changecoverimage').click(function(e) {\n                e.preventDefault();\n                $(this).removeClass('state-visible');\n                $('label[for=\"snap-coverfiles\"]').addClass('state-visible');\n            });\n\n            var file,\n                filedata;\n\n            $('#snap-coverfiles').on('change', function(e) {\n                $('body').addClass('cover-image-change');\n                var files = e.target.files; // FileList object\n                if (!files.length) {\n                    return;\n                }\n\n                file = files[0];\n\n                // Only process image files.\n                if (!file.type.match('image.*')) {\n                    return;\n                }\n\n                var reader = new FileReader();\n\n                $('label[for=\"snap-coverfiles\"]').addClass('ajaxing');\n\n                // Closure to capture the file information.\n                reader.onload = (function(theFile) {\n                    return function(e) {\n\n                        // Set page header to use local version for now.\n                        filedata = e.target.result;\n\n                        // Ensure that the page-header in courses has the mast-image class.\n                        $('.path-course-view #page-header').addClass('mast-image');\n                        $('.path-course-view #page-header .breadcrumb-item a').addClass('mast-breadcrumb');\n\n                        // Warn if image file size exceeds max upload size.\n                        // Note: The site max bytes is intentional, as the person who can do the upload would be able to\n                        // override the course upload limit anyway.\n                        var maxbytes = siteMaxBytes;\n                        if (theFile.size > maxbytes) {\n                            // Go back to initial state and show warning about image file size.\n                            state1();\n                            var maxbytesstr = humanFileSize(maxbytes);\n                            var message = M.util.get_string('error:coverimageexceedsmaxbytes', 'theme_snap', maxbytesstr);\n                            addCoverImageAlert('snap-alert-cover-image-bytes', message);\n                            return;\n                        } else {\n                            $('#snap-alert-cover-image-bytes').remove();\n                        }\n\n                        // Warn if image resolution is too small.\n                        var img = $('<img />');\n                        img = img.get(0);\n                        img.src = filedata;\n                        $(img).on('load', function() {\n                            if (img.width < 1024) {\n                                addCoverImageAlert('snap-alert-cover-image-size',\n                                    M.util.get_string('error:coverimageresolutionlow', 'theme_snap')\n                                );\n                            } else {\n                                $('#snap-alert-cover-image-size').remove();\n                            }\n                        });\n\n                        $('#page-header').css('background-image', 'url(' + filedata + ')');\n                        $('#page-header').data('localcoverfile', theFile.name);\n\n                        state2();\n                    };\n                })(file);\n\n                // Read in the image file as a data URL.\n                reader.readAsDataURL(file);\n\n            });\n            $('#snap-changecoverimageconfirmation .ok').click(function() {\n\n                if ($(this).parent().hasClass('disabled')) {\n                    return;\n                }\n\n                $('#snap-alert-cover-image-size').remove();\n                $('#snap-alert-cover-image-bytes').remove();\n\n                $('#snap-changecoverimageconfirmation .ok').addClass('ajaxing');\n                $('#snap-changecoverimageconfirmation').addClass('disabled');\n\n                var imageData = filedata.split('base64,')[1];\n\n                ajaxParams.imagedata = imageData;\n                ajaxParams.imagefilename = file.name;\n\n                ajax.call([\n                    {\n                        methodname: 'theme_snap_cover_image',\n                        args: {params: ajaxParams},\n                        done: function(response) {\n                            state1();\n                            if(response.contrast) {\n                                addCoverImageAlert('snap-alert-cover-image-size',\n                                    response.contrast\n                                );\n                            }\n                            if (!response.success && response.warning) {\n                                addCoverImageAlert('snap-alert-cover-image-upload-failed', response.warning);\n                            }\n                        },\n                        fail: function(response) {\n                            state1();\n                            ajaxNotify.ifErrorShowBestMsg(response);\n                        }\n                    }\n                ], true, true);\n            });\n            $('#snap-changecoverimageconfirmation .cancel').click(function() {\n\n                if ($(this).parent().hasClass('disabled')) {\n                    return;\n                }\n\n                $('#page-header').css('background-image', $('#page-header').data('servercoverfile'));\n                state1();\n            });\n            $('#snap-coverimagecontrol').addClass('snap-js-enabled');\n        };\n\n        var categoryCoverImage = function(categoryId, siteMaxBytes) {\n            var ajaxParams = {imagefilename: null, imagedata: null, categoryid: categoryId,\n                    courseshortname: null};\n\n            coverImage(siteMaxBytes, ajaxParams);\n        };\n\n        /**\n         * Main function\n         * @param {string} courseShortName\n         * @param {int} siteMaxBytes\n         */\n        var courseCoverImage = function(courseShortName, siteMaxBytes) {\n            var ajaxParams = {imagefilename: null, imagedata: null, categoryid: null,\n                    courseshortname: courseShortName};\n\n            coverImage(siteMaxBytes, ajaxParams);\n        };\n        return {courseImage: courseCoverImage, categoryImage: categoryCoverImage};\n    }\n);\n"],"file":"cover_image.min.js"}