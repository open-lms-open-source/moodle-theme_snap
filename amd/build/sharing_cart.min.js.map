{"version":3,"file":"sharing_cart.min.js","sources":["../src/sharing_cart.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n *  Sharing Cart\n *\n *  @package\n *  @copyright  Copyright (c) 2020 Open LMS (https://www.openlms.net)\n *  @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\n\nexport default class SharingCartForSnap {\n    constructor(courseSections) {\n        this.snapSpinner = '';\n        this.courseSections = courseSections;\n    }\n\n    /**\n     * Get a string from moodle\n     * @param {String} identifier\n     * @returns {String}\n     */\n    str = (identifier) => {\n        return M.str.block_sharing_cart[identifier] || M.str.moodle[identifier];\n    };\n    /**\n     * Sets a create command pointer\n     * @param {string} create_command\n     */\n    setCreateCommand = (create_command) => {\n        this.create_command = create_command;\n    };\n    /**\n     *  Create a custom command icon\n     *  @param {String} cssClass The css class for the icon\n     *  @param {String} title The title and tooltip for the icon\n     *  @param {String} imageUrl Image URL for the icon\n     */\n    create_special_activity_command = (cssClass, title, imageUrl) => {\n        return $('<a href=\"javascript:void(0)\"/>')\n            .addClass(cssClass)\n            .addClass('dropdown-item menu-action cm-edit-action')\n            .attr('title', title)\n            .append(\n                $('<img class=\"icon\"/>')\n                    .attr('alt', title)\n                    .attr('src', imageUrl)\n            );\n    };\n    /**\n     * Adds a spinner when necessary\n     * @param {function} spinner\n     */\n    addSpinner = (spinner) => {\n        if (this.snapSpinner) {\n            this.snapSpinner.show();\n        } else {\n            this.snapSpinner = spinner;\n        }\n    };\n    /**\n     * Hides the spinner if exist\n     */\n    hideSpinner = () => {\n        if (this.snapSpinner) {\n            this.snapSpinner.hide();\n        }\n    };\n    /**\n     * Creates a custom modal when restoring a sharing cart activity/module\n     * @param {Object} input\n     */\n    onRestore = (input) => {\n        const restore_targets = input.restore_targets;\n        const course = input.course;\n        const param = input.param;\n        const get_action_url = input.get_action_url;\n        const ModalFactory = input.ModalFactory;\n        const ModalEvents = input.ModalEvents;\n        const id = input.id;\n\n        var sectionsURLs = [];\n        this.courseSections.forEach(function(section) {\n            var urlArray = {\n                'directory': restore_targets.is_directory,\n                'course'   : course.id,\n                'section'  : section.num,\n                'sesskey'  : M.cfg.sesskey\n            };\n            urlArray[param] = id;\n            var url = get_action_url('restore', urlArray);\n\n            var sectionName = null;\n            if (section.name === null) {\n                $('#chapters').find('.chapter-title').each(function() {\n                    var currSection = $(this).attr('href');\n                    if (currSection == '#section-'+section.num) {\n                        sectionName = $(this).text();\n                    }\n                });\n            } else {\n                sectionName = section.name;\n            }\n            var sectionURL = {\n                name : sectionName,\n                url : url\n            };\n            sectionsURLs.push(sectionURL);\n        });\n\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: M.str.block_sharing_cart['restore'],\n            body: ((sections) => {\n                var s = M.str.block_sharing_cart['snap_dialog_restore'];\n                // Create Select element.\n                s += '<select id=\"select-dialog\" class=\"custom-select\">';\n                for(var i = 0; i < sections.length; i++) {\n                    s += '<option value=\"' + sections[i].url + '\">' + sections[i].name + '</option>';\n                }\n                s += '</select> <br> <br>';\n                return s;\n            })(sectionsURLs)\n        })\n            .done(function(modal) {\n                modal.show();\n                modal.getRoot().on(ModalEvents.save, function() {\n                    window.location.href = $('#select-dialog').val();\n                });\n                modal.getRoot().on(ModalEvents.cancel, function() {\n                    modal.destroy();\n                });\n            });\n    };\n\n    /**\n     *\n     * @param {node} $activity\n     * @param {object} iconBackup\n     * @param {function} on_backup\n     */\n    add_backup_command = ($activity, iconBackup, on_backup) => {\n        var $menu = $activity.find(\"ul[role='menu']\");\n\n        if($menu.length)\n        {\n            var li = $menu.find('li').first().clone();\n            var $backup = li.find('a').attr('title', this.str('backup'))\n                .attr('href', 'javascript:void(0)'); //eslint-disable-line no-script-url\n            var img = li.find('img');\n\n            if (img.length) {\n                li.find('img')\n                    .attr('alt', this.str('backup'))\n                    .attr('title', this.str('backup'))\n                    .attr('src', M.util.image_url(iconBackup.pix));\n            } else {\n                li.find('i')\n                    .attr('class', 'icon fa fa-upload')\n                    .attr('title', this.str('backup'))\n                    .attr('aria-label', this.str('backup'));\n            }\n\n            li.find('span').html(this.str('backup'));\n            $menu.append(li);\n        }\n        else\n        {\n            var $backup = this.create_command(\"backup\");\n            if ($('#page-course-view-tiles').length) {\n                $menu = $activity.find('div[role=\"menu\"]');\n            } else {\n                $menu = $activity.find('div.snap-edit-more-dropdown ul.dropdown-menu');\n            }\n            if($menu.length)\n            {\n                const cssClass = iconBackup.css;\n                const title = this.str('backup');\n                const imageUrl =  M.util.image_url(iconBackup.pix);\n                $backup = this.create_special_activity_command(cssClass, title, imageUrl);\n\n                if($menu.css(\"display\") === \"none\")\n                {\n                    var $button = $menu.find('.editing_backup');\n                    if ($button.length == 0) {\n                        $menu.append($backup);\n                        $backup.append($(\"<span class='menu-action-text'/>\").append($backup.attr('title')));\n                    }\n                }\n            }\n            else\n            {\n                $activity.find(\".commands\").append($backup);\n            }\n        }\n        // Get activity name\n        var activityClass = $activity[0].className;\n        var modtype = activityClass.substr(activityClass.indexOf('modtype_') + 8);\n        var activityName = this.str('activity_string');\n        if (modtype !== 'label') {\n            activityName = $('.activity#' + $activity[0].id)\n                .find('.activityinstance p.instancename')\n                .html();\n        }\n\n        $backup.click(function(e)\n        {\n            on_backup(e, activityName);\n        });\n    };\n\n    snapFix = (input) => {\n        const course = input.course;\n        const iconBackup = input.iconBackup;\n        const on_section_backup = input.on_section_backup;\n        const on_backup = input.on_backup;\n        const _this = this;\n\n        if(course.is_frontpage)\n        {\n            if($('.sitetopic li.activity').length > 0)\n            {\n                var valid = $('.sitetopic li.activity').data('block-sharing-cart');\n                if(valid !== 'done')\n                {\n                    $('.sitetopic li.activity').each(function()\n                    {\n                        _this.add_backup_command($(this), iconBackup, on_backup);\n                    });\n                    $('.sitetopic li.activity').data(\"block-sharing-cart\", \"done\");\n                }\n            }\n            if($('.block_site_main_menu').length > 0)\n            {\n                var valid = $('.block_site_main_menu .content > ul >  li').data('block-sharing-cart');\n                if(valid !== 'done')\n                {\n                    $('.block_site_main_menu .content > ul >  li').each(function()\n                    {\n                        _this.add_backup_command($(this), iconBackup, on_backup);\n                    });\n                    $('.block_site_main_menu .content > ul >  li').data(\"block-sharing-cart\", \"done\");\n                }\n            }\n        }\n        else\n        {\n            if($('.course-content li.activity').length > 0)\n            {\n                var valid = $('.course-content li.activity').data('block-sharing-cart');\n                if(valid !== 'done' || this.courseSections.length == 1)\n                {\n                    $('.course-content li.activity').each(function()\n                    {\n                        _this.add_backup_command($(this), iconBackup, on_backup);\n                    });\n                    $('.course-content li.activity').data(\"block-sharing-cart\", \"done\");\n                }\n            }\n        }\n\n        if (M.cfg.theme !== 'snap') {\n            let _this = this;\n            $(\"li.section\").each(function () {\n                var sectionID = $(this).find(\"div.content h3.sectionname span.inplaceeditable\").attr(\"data-itemid\");\n\n                var $menu = $(this).find(\"ul[role='menu']\").first();\n\n                if ($menu.length){\n                    var li = $menu.find('li').first().clone();\n                    var img = li.find('img');\n\n                    if (img.length) {\n                        img.attr('alt', _this.str('backup'))\n                            .attr('title', _this.str('backup'))\n                            .attr('src', M.util.image_url(iconBackup.pix, null));\n                    } else {\n                        li.find('i')\n                            .attr('class', 'icon fa fa-upload')\n                            .attr('title', _this.str('backup'))\n                            .attr('aria-label', _this.str('backup'));\n                    }\n\n                    li.find('span').html(_this.str('backup'));\n                    li.find('a').attr('href', 'javascript:void(0)'); //eslint-disable-line no-script-url\n\n                    $menu.append(li);\n\n                    li.find('a').click(function () {\n                        on_section_backup(sectionID);\n                    });\n                }\n                else {\n                    $menu = $(this).find(\"div[role='menu']\").first();\n\n                    var $backup = null;\n\n                    if ($menu.length) {\n                        const cssClass = iconBackup.css;\n                        const title = _this.str('backup');\n                        const imageUrl =  M.util.image_url(iconBackup.pix);\n                        $backup = _this.create_special_activity_command(cssClass, title, imageUrl);\n                        $menu.append($backup.attr(\"role\", \"menuitem\"));\n\n                        if ($menu.css(\"display\") === \"none\") {\n                            $backup.append($(\"<span class='menu-action-text'/>\").append($backup.attr('title')));\n                        }\n                    }\n                    else {\n                        $backup = _this.create_command(\"backup\");\n                        $(this).find(\".commands\").append($backup);\n                    }\n\n                    $backup.click(function () {\n                        on_section_backup(sectionID);\n                    });\n                }\n            });\n        } else {\n            $.each($(\"a.snap-delete\"), function(i, val)\n            {\n                var sectionID = $(val).attr(\"href\").split('?')[1].split('&')[0].split('=')[1];\n                var $link = $('<a/>').attr('class', 'snap-sharing-cart').attr('role', 'button').attr('id', sectionID);\n                $link.attr('tabindex', '0').attr('title', 'Backup Section');\n                var $button = $(val).parent().find('a.snap-sharing-cart');\n                if ($button.length == 0) {\n                    $(val).parent().append($link);\n                }\n            });\n\n            $('a.snap-sharing-cart').unbind().click(function () {\n                const sectionId = $(this).attr('id');\n                const section = _this.courseSections ? _this.courseSections.find(section => section['id'] === sectionId)\n                    : {num: 0, name: undefined};\n                const sectionNumber = section['num'];\n                const courseId = course.id;\n                const sectionName = section['name'] === null ? undefined : section['name'];\n                on_section_backup(sectionId, sectionNumber, courseId, sectionName);\n            });\n        }\n    };\n}"],"names":["SharingCartForSnap","courseSections","identifier","M","str","block_sharing_cart","moodle","create_command","_this2","cssClass","title","imageUrl","addClass","attr","append","spinner","snapSpinner","show","hide","input","restore_targets","course","param","get_action_url","ModalFactory","ModalEvents","id","sectionsURLs","forEach","section","urlArray","is_directory","num","cfg","sesskey","url","sectionName","name","find","each","this","text","sectionURL","push","create","type","types","SAVE_CANCEL","body","sections","s","i","length","done","modal","getRoot","on","save","window","location","href","val","cancel","destroy","$activity","iconBackup","on_backup","$menu","li","first","clone","$backup","util","image_url","pix","html","css","create_special_activity_command","activityClass","className","modtype","substr","indexOf","activityName","click","e","on_section_backup","_this","is_frontpage","data","add_backup_command","theme","sectionID","img","split","$link","parent","unbind","sectionId","undefined","sectionNumber","courseId"],"mappings":"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"}