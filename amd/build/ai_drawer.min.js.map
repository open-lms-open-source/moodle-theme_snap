{"version":3,"file":"ai_drawer.min.js","sources":["../src/ai_drawer.js"],"sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package\n * @author    Julian Tovar <julian.tovar@openlms.net>\n * @copyright Copyright (c) 2025 Open LMS\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nconst SELECTORS = {\n    AIDRAWER_CLOSE_BUTTON: '#ai-drawer button#ai-drawer-close',\n    GOTO_TOP_LINK: '#goto-top-link',\n    SIDEBAR: '#snap-sidebar-menu',\n    HEADER: 'header',\n    DRAWER_BUTTONS: '.snap-sidebar-menu-item[data-activeselector], ' +\n        '.drawer-toggler.drawer-left-toggle [data-activeselector]',\n    AIDRAWER_BUTTON: '.ai-course-summarise-controls button[aria-controls=\"ai-drawer\"]',\n    AIDRAWER: 'div#ai-drawer',\n    NAV_UNPINNED: '#mr-nav.headroom--unpinned',\n};\n\nconst CLASSES = {\n    CUSTOM_MENU_ITEM: 'custom-menu-item',\n    SHOW: 'show',\n    ACTIVE: 'active',\n    COLLAPSED: 'collapsed',\n};\n\nconst POPOVERS_AND_DRAWERS = {\n    CLICKABLE_SELECTORS: [\n        '#user-menu-toggle', // User menu\n        '#nav-intellicart-popover-container', // Intellicart\n        '#nav-notification-popover-container', // Notifications\n        '#local-accessibility-buttoncontainer', // Accessibility\n        '.snap-sidebar-menu-item[data-activeselector=\"#admin-menu-trigger.active\"]', // Admin gear\n        '.snap-sidebar-menu-item[data-activeselector=\"#theme_snap-drawers-blocks.show\"]', // Blocks drawer\n        '.snap-sidebar-menu-item[data-activeselector=\"#snap_feeds_side_menu_trigger.active\"]', // Snap feeds\n    ]\n};\n\nexport const init = () => {\n    setupClickHandlers();\n    setupAIDrawerDynamicLayout();\n    setupEventListeners();\n};\n\n/**\n * Setup the AI drawer position dynamically if needed, and be aware of other drawer, popover and dropdown usage by the user.\n */\nconst setupAIDrawerDynamicLayout = () => {\n    // Don't spend time if we don't need to set up anything at all.\n    const AIDrawerButton = document.querySelector(SELECTORS.AIDRAWER_BUTTON);\n    const header = document.querySelector(SELECTORS.HEADER);\n    if (AIDrawerButton && header) {\n        // Set the position of the AISummary on page load.\n        const AIDrawer = document.querySelector(SELECTORS.AIDRAWER);\n        if (AIDrawer) {\n            repositionHeightAndTopPosition(header, AIDrawer);\n        }\n        // Set the position of the AISummary if the user scrolls.\n        window.addEventListener('scroll', function() {\n            const isNavUnpinned = document.querySelector(SELECTORS.NAV_UNPINNED);\n            const AIDrawer = document.querySelector(SELECTORS.AIDRAWER);\n            if (AIDrawer) {\n                if (isNavUnpinned) {\n                    AIDrawer.style.top = '0px';\n                    AIDrawer.style.height = '100vh';\n                } else {\n                    repositionHeightAndTopPosition(header, AIDrawer);\n                }\n            }\n        });\n    }\n};\n\n/**\n * Gets the visible height and the top position of a given element.\n * @param {mixed} reference The element we take as reference for the visible height and top position.\n * @param {mixed} positionedElement The element we are repositioning.\n */\nfunction repositionHeightAndTopPosition(reference, positionedElement) {\n    const elementRect = reference.getBoundingClientRect();\n    const visibleHeight = window.innerHeight;\n    const topPosition = Math.max(0, elementRect.bottom);\n    positionedElement.style.top = `${topPosition}px`;\n    positionedElement.style.height = `${visibleHeight - topPosition}px`;\n}\n\n/**\n * Close the AI drawer if active\n */\nconst closeAIDrawer = () => {\n    repositionGotoTopLink();\n    const AIDrawerButton = document.querySelector(SELECTORS.AIDRAWER_CLOSE_BUTTON);\n    if (AIDrawerButton) {\n        AIDrawerButton.click();\n        AIDrawerButton.classList.remove(CLASSES.ACTIVE);\n    }\n};\n\n/**\n * Setup the click event handlers for all elements involved (namely, the AI drawer, the other drawers, popovers, dropdowns).\n */\nconst setupClickHandlers = () => {\n    let isClosingDrawers = false;\n\n    const checkAndCloseAIDrawer = () => {\n        if (isClosingDrawers) {\n            return false;\n        }\n\n        let isOpenAIDrawer = false;\n        const AIDrawer = document.querySelector(SELECTORS.AIDRAWER);\n        if (AIDrawer.classList.contains(CLASSES.SHOW)) {\n            isOpenAIDrawer = true;\n        }\n\n        if (isOpenAIDrawer) {\n            // Set flag to prevent recursive calls\n            isClosingDrawers = true;\n            // Close all drawers first\n            closeAIDrawer();\n            isClosingDrawers = false;\n            return true;\n        }\n\n        return false;\n    };\n\n    POPOVERS_AND_DRAWERS.CLICKABLE_SELECTORS.forEach(selector => {\n        const element = document.querySelector(selector);\n        if (element) {\n            // Handle mouse clicks\n            element.addEventListener('click', () => {\n                checkAndCloseAIDrawer();\n            }, true);\n\n            // Handle keyboard events (Enter key)\n            element.addEventListener('keydown', (e) => {\n                // Check if the Enter key was pressed\n                if (e.key === 'Enter' || e.keyCode === 13) {\n                    checkAndCloseAIDrawer();\n                }\n            }, true);\n        }\n    });\n\n    /**\n     * Close all active drawers except the one matching the given selector\n     */\n    const checkAndCloseOtherDrawers = () => {\n        const drawerButtons = document.querySelectorAll(SELECTORS.DRAWER_BUTTONS);\n        drawerButtons.forEach(button => {\n            const activeSelector = button.dataset.activeselector;\n            const activeElements = document.querySelectorAll(activeSelector);\n            const isActive = Array.from(activeElements).some(el =>\n                el.classList.contains(CLASSES.SHOW) ||\n                el.classList.contains(CLASSES.ACTIVE) ||\n                !el.classList.contains(CLASSES.COLLAPSED) // Consider not collapsed as active\n            );\n\n            if (isActive) {\n                const isCustomContent = button.classList.contains(CLASSES.CUSTOM_MENU_ITEM);\n                if (isCustomContent) {\n                    const clickableElement = button.querySelector('a, button') || button;\n                    clickableElement.click();\n                } else {\n                    button.click();\n                }\n                button.classList.remove(CLASSES.ACTIVE);\n            }\n        });\n        setTimeout(() => {\n            repositionGotoTopLink();\n        }, 50); // Small delay to allow the drawer state to update\n    };\n\n    const AIDrawerButton = document.querySelector(SELECTORS.AIDRAWER_BUTTON);\n    AIDrawerButton.addEventListener('click', () => {\n        checkAndCloseOtherDrawers();\n    }, true);\n\n    // Handle keyboard events (Enter key)\n    AIDrawerButton.addEventListener('keydown', (e) => {\n        // Check if the Enter key was pressed\n        if (e.key === 'Enter' || e.keyCode === 13) {\n            checkAndCloseOtherDrawers();\n        }\n    }, true);\n};\n\n/**\n * Setup needed event listeners\n */\nconst setupEventListeners = () => {\n    window.addEventListener('scroll', () => {\n        // Add a small delay to avoid performance issues with rapid scroll events\n        setTimeout(() => {\n            const header = document.querySelector(SELECTORS.HEADER);\n            const AIDrawer = document.querySelector(SELECTORS.AIDRAWER);\n\n            repositionHeightAndTopPosition(header, AIDrawer);\n\n            // Check if Go to Top link is visible and reposition it if needed\n            const gotoTopLink = document.querySelector(SELECTORS.GOTO_TOP_LINK);\n            if (gotoTopLink) {\n                const computedStyle = window.getComputedStyle(gotoTopLink);\n                if (computedStyle.visibility === 'visible') {\n                    repositionGotoTopLink();\n                }\n            }\n        }, 50);\n    });\n};\n\n/**\n * Reposition the \"Go to Top\" button based on open drawers\n */\nconst repositionGotoTopLink = () => {\n    const gotoTopLink = document.querySelector(SELECTORS.GOTO_TOP_LINK);\n    if (!gotoTopLink) {\n        return;\n    }\n\n    gotoTopLink.style.marginRight = '';\n\n    // Check if sidebar is showing\n    const sidebar = document.querySelector(SELECTORS.SIDEBAR);\n    const isSidebarShowing = sidebar && sidebar.classList.contains(CLASSES.SHOW);\n\n    // Only proceed if sidebar is showing\n    if (isSidebarShowing) {\n        const AIDrawer = document.querySelector(SELECTORS.AIDRAWER);\n\n        if (AIDrawer) {\n            // Get the first active drawer found for this selector type\n            if (AIDrawer.offsetWidth > 0 && !AIDrawer.classList.contains('drawer-left')) {\n                // Get the width of the drawer\n                const drawerWidth = AIDrawer.offsetWidth;\n                // Add margin to position the link to the left of the drawer\n                gotoTopLink.style.marginRight = `${drawerWidth}px`;\n                return; // Exit after finding the first open drawer\n            }\n        }\n    }\n};\n"],"names":["SELECTORS","CLASSES","POPOVERS_AND_DRAWERS","CLICKABLE_SELECTORS","setupClickHandlers","setupAIDrawerDynamicLayout","setupEventListeners","AIDrawerButton","document","querySelector","header","AIDrawer","repositionHeightAndTopPosition","window","addEventListener","isNavUnpinned","style","top","height","reference","positionedElement","elementRect","getBoundingClientRect","visibleHeight","innerHeight","topPosition","Math","max","bottom","isClosingDrawers","checkAndCloseAIDrawer","isOpenAIDrawer","classList","contains","repositionGotoTopLink","click","remove","closeAIDrawer","forEach","selector","element","e","key","keyCode","checkAndCloseOtherDrawers","querySelectorAll","button","activeSelector","dataset","activeselector","activeElements","Array","from","some","el","setTimeout","gotoTopLink","getComputedStyle","visibility","marginRight","sidebar","offsetWidth","drawerWidth"],"mappings":"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"}