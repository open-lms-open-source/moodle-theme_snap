/**
 * This file is part of Moodle - http://moodle.org/
 *
 * Moodle is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Moodle is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @package
 * @copyright Copyright (c) 2016 Open LMS (https://www.openlms.net)
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("theme_snap/course-lazy",["jquery","theme_snap/util","theme_snap/section_asset_management","theme_snap/course_modules","core/str"],(function($,util,sectionAssetManagement,courseModules,str){return function(courseConfig){var self=this;self.courseConfig=courseConfig;var onCoursePage=function(){return 0===$("body").attr("id").indexOf("page-course-view-")};this.setTOCVisibleSection=function(){var currentSectionId=$(".section.main.state-visible, #coursetools.state-visible, #snap-add-new-section.state-visible").attr("id");$("#chapters li").removeClass("snap-visible-section"),$("#chapters li a").attr("aria-current","false");var visibleSectionLink=$('#chapters a[href$="'+currentSectionId+'"]');visibleSectionLink.parent("li").addClass("snap-visible-section"),visibleSectionLink.attr("aria-current","true")};var checkToolParameter=function(checkParameter){return-1!=window.location.href.indexOf(checkParameter)};this.showSection=function(){if(!onCoursePage())return;var urlParams=location.hash.split("&"),section=urlParams[0],mod=urlParams[1]||null,sectionId=!1;if(-1!=section.indexOf("#sectionid")&&(sectionId=section.match(/#sectionid-(\d+)-title/)[1]),sectionId){var $chapter=$('.chapters .chapter-title[section-id="'+sectionId+'"]');$chapter.length>0&&(section="#section-"+(section=$chapter.attr("section-number")))}if(section.startsWith("#h5pbook"))return;var sectionSetByServer="";($(".section.main.state-visible.set-by-server").length?(sectionSetByServer="#"+$(".section.main.state-visible.set-by-server").attr("id"),$(".section.main.state-visible.set-by-server").removeClass("set-by-server")):$(".course-content .section.main, #moodle-blocks,#coursetools, #snap-add-new-section,#tiles-section").removeClass("state-visible"),""==section)&&location.search.substring(1).split("&").forEach((function(param){param.indexOf("section=")>=0&&(param.replace(param),section="#"+param.replace("=","-"))}));""!==section&&section!==sectionSetByServer&&$(sectionSetByServer).removeClass("state-visible");let courseTools="#coursetools";if($(courseTools).hasClass("editing-tiles")){$(courseTools).removeClass("state-visible"),$(courseTools).addClass("d-none");let labelDuplicateButton=$(".launch-tiles-standard.modtype_label .actions .editing_duplicate");labelDuplicateButton&&$(labelDuplicateButton).attr("data-action","tiles-duplicate")}let sectionParameter=checkToolParameter("section-"),dashboardParameter=checkToolParameter("coursetools");if(sectionParameter&&!dashboardParameter&&($("#tiles-section").addClass("state-visible"),$(courseTools).removeClass("state-visible"),$(courseTools).addClass("d-none")),!sectionParameter&&dashboardParameter){if($("#snap-course-tools").hasClass("tiles-dashboard")&&($("#tiles-section").removeClass("state-visible"),$(courseTools).addClass("state-visible"),$(courseTools).removeClass("d-none"),$(".btn-editing").length)){let urlEditing=document.querySelector(".btn-editing").href;urlEditing.includes("#coursetools")||(str.get_strings([{key:"editcoursecontent",component:"theme_snap"},{key:"editmodetiles",component:"theme_snap"},{key:"turneditingoff",component:"moodle"}]).done((function(stringsjs){document.querySelector(".btn-editing").text==stringsjs[1]?document.querySelector(".btn-editing").innerHTML=stringsjs[0]:document.querySelector(".btn-editing").innerHTML=stringsjs[2]})),document.querySelector(".btn-editing").href=urlEditing+"#coursetools")}$("#snap-course-tools").hasClass("snap-course-dashboard")&&$(courseTools).removeClass("d-none")}"#coursetools"==section&&$("#moodle-blocks").addClass("state-visible"),null!==mod?($(section).addClass("state-visible"),function(modid){$("#toc-search-results").html("");var targmod=$("#"+modid.replace("#",""));util.scrollToElement(targmod);var searchpin=$("#searchpin");searchpin.length||(searchpin=$('<i id="searchpin"></i>')),$(targmod).find(".instancename").prepend(searchpin),$(targmod).attr("tabindex","-1").focus(),$("#course-toc").removeClass("state-visible")}(mod)):($(section).addClass("state-visible").focus(),scrollBack()),$(".section.main.state-visible,#coursetools.state-visible,#snap-add-new-section.state-visible").length||($(".section.main.current").length?$(".section.main.current").addClass("state-visible").focus():$("#section-0").addClass("state-visible").focus(),scrollBack()),""==section&&"tiles"==self.courseConfig.format&&$("#tiles-section").addClass("state-visible").focus(),"tiles"==self.courseConfig.format&&($(courseTools).hasClass("state-visible")||$("#tiles-section").hasClass("state-visible")||$("#tiles-section").addClass("state-visible"),$('#page-course-view-tiles .tiles[data-for="course_sectionlist"]').length&&($(courseTools).hasClass("state-visible")||$("#page-course-view-tiles .tiles").hasClass("state-visible")||$("#page-course-view-tiles .tiles").addClass("state-visible")),dashboardParameter||$("#snap-course-dashboard").addClass("state-visible")),$("li.snap-activity:visible, li.snap-resource:visible").on("click","a.mod-link",(function(){sessionStorage.setItem("lastMod",$(this).parents("[id^=module]").attr("id"))})),this.setTOCVisibleSection()};var scrollBack=function(){var storedmod=sessionStorage.getItem("lastMod");null===storedmod?window.scrollTo(0,0):(util.scrollToElement($("#"+storedmod)),sessionStorage.removeItem("lastMod"))},renderFromHash=function(){var params=$(location).attr("hash").replace("#","").split("&"),section=!1,sectionId=!1,mod=0;if($.each(params,(function(idx,param){-1!=param.indexOf("sectionid")?sectionId=param.match(/sectionid-(\d+)-title/)[1]:-1!=param.indexOf("section")?section=param.split("section-")[1]:-1!=param.indexOf("module")&&(mod=param.split("module-")[1])})),sectionId){var $chapter=$('.chapters .chapter-title[section-id="'+sectionId+'"]');$chapter.length>0&&(section=$chapter.attr("section-number"))}section||location.search.substring(1).split("&").forEach((function(param){param.indexOf("section=")>=0&&(param.replace(param),section=param.replace("section=",""))}));section&&$('.chapters .chapter-title[href="#section-'+section+'"]').length>0&&sectionAssetManagement.renderAndFocusSection(section,mod)};!function(){if(sectionAssetManagement.init(self),courseModules.init(courseConfig),self.courseConfig.enablecompletion&&require(["theme_snap/course_conditionals-lazy"],(function(conditionals){conditionals(courseConfig)})),onCoursePage()&&(self.showSection(),$(document).on("snapTOCReplaced",(function(){self.setTOCVisibleSection(),self.courseConfig.partialrender&&sectionAssetManagement.setTocObserver()})),self.courseConfig.partialrender)){renderFromHash(),$(window).on("hashchange",(function(){renderFromHash()}));var sections=$('.course-content li[id^="section-"]'),sectionParam=location.hash.split("&")[0];if(1==sections.length&&"#coursetools"!=sectionParam&&"#snap-add-new-section"!=sectionParam){sections.addClass("state-visible");var section=sections.attr("id").split("section-")[1];if("top"==self.courseConfig.toctype&&"topics"==self.courseConfig.format&&section>0){var title=sections.find(".sectionname").html(),elements=$(".chapter-title"),tmpid=0;$.each(elements,(function(key,element){$(element).attr("section-number")==section&&(tmpid=key)})),sections.find(".sectionname").html(title),sections.find(".sectionnumber").html(tmpid+".")}}}}(),$(".section-modchooser-link").click((function(){var sectionNum=$(this).attr("data-sectionid");$(".snap-modchooser-addlink").each((function(){var newLink=this.href.replace(/(section=)[0-9]+/gi,"$1"+sectionNum);$(this).attr("href",newLink)}))}))}}));

//# sourceMappingURL=course-lazy.min.js.map