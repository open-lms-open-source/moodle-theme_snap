{"version":3,"file":"courseindex_adjustments.min.js","sources":["../src/courseindex_adjustments.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Additional settings in the course index.\n *\n * @module theme_snap/courseindex_adjustments\n * @copyright  Copyright (c) 2025 Open LMS\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ajax from \"core/ajax\";\nimport snapsection from 'theme_snap/section_asset_management';\n\n/**\n * Ensures that all course index links have a title attribute for accessibility.\n *\n * @param {HTMLElement|Document} root - The root node to search for course index links.\n */\nconst injectTitles = (root) => {\n    root.querySelectorAll('a.courseindex-link, a.aalink.stretched-link').forEach((link) => {\n        if (!link.hasAttribute('title')) {\n            const text = link.textContent.trim();\n            if (text) {\n                link.setAttribute('title', text);\n            }\n        }\n    });\n};\n\n/**\n * Processes a newly added node by injecting icons and titles if applicable.\n *\n * @param {Node} node - The node added to the DOM.\n */\nconst processNode = (node) => {\n    if (node.nodeType !== 1) {\n        return;\n    }\n    injectTitles(node);\n};\n\n/**\n * Get hidden TOC activities list from config.\n * @returns {number[]} Array of hidden course module IDs\n */\nconst getHiddenTocActivities = () => {\n    const config = require('core/config');\n    return config.hiddenTocActivities || [];\n};\n\n/**\n * Remove hidden activities from the course index DOM.\n */\nconst filterHiddenActivitiesFromDOM = () => {\n    const hiddencmids = getHiddenTocActivities();\n    if (!hiddencmids || hiddencmids.length === 0) {\n        return;\n    }\n\n    const courseindex = document.querySelector('#courseindex');\n    if (!courseindex) {\n        return;\n    }\n\n    // Remove activities that are marked as hidden.\n    // Course index activities use data-id and data-for=\"cm\" attributes.\n    hiddencmids.forEach(cmid => {\n        const activityElement = courseindex.querySelector(`[data-id=\"${cmid}\"][data-for=\"cm\"]`);\n        if (activityElement) {\n            activityElement.remove();\n        }\n    });\n};\n\nconst getCourseState = async() => {\n\n    const courseStateData = await ajax.call([{\n        methodname: 'core_courseformat_get_state',\n        args: {\n            courseid: M.cfg.courseId,\n        }\n    }])[0];\n    return JSON.parse(courseStateData);\n};\n\n/**\n * Initializes the course index adjustments.\n *\n * - Adds missing title attributes to links.\n * - Observes changes in the course index and applies the same adjustments to new nodes.\n */\nexport const init = () => {\n    injectTitles(document);\n\n    const target = document.querySelector('#courseindex');\n    if (target) {\n        // Filter hidden activities immediately and after DOM changes.\n        filterHiddenActivitiesFromDOM();\n        const observer = new MutationObserver((mutations) => {\n            snapsection.setNavigationObservers();\n            mutations.forEach((m) => {\n                m.addedNodes.forEach(processNode);\n            });\n            // Filter hidden activities after DOM mutations.\n            filterHiddenActivitiesFromDOM();\n            getCourseState().then(courseState => {\n                const sections = document.querySelectorAll('#courseindex-content .courseindex-section');\n                const currentSectionId = courseState.section.filter(el => el.current)[0]?.id;\n                sections.forEach(section => {\n                    if (currentSectionId === section.dataset.id) {\n                        section.classList.add('current');\n                        if (document.querySelector('body:not(.path-course-view-section)')) {\n                            section.querySelector('.courseindex-item').classList.add('pageitem');\n                        }\n                    } else {\n                        section.classList.remove('current');\n                        if (document.querySelector('body:not(.path-course-view-section)')) {\n                            section.querySelector('.courseindex-item').classList.remove('pageitem');\n                        }\n                    }\n                });\n            });\n            const sectionsInView = document.querySelectorAll('body:not(.path-course-view-section)' +\n                ' #courseindex-content .courseindex-section');\n            sectionsInView.forEach((section) => {\n                if (section.classList.contains('current')) {\n                    section.querySelector('.courseindex-item').classList.add('pageitem');\n                } else {\n                    section.querySelector('.courseindex-item').classList.remove('pageitem');\n                }\n            });\n        });\n        observer.observe(target, {childList: true, subtree: true});\n    }\n};\n"],"names":["injectTitles","root","querySelectorAll","forEach","link","hasAttribute","text","textContent","trim","setAttribute","processNode","node","nodeType","filterHiddenActivitiesFromDOM","hiddencmids","require","hiddenTocActivities","length","courseindex","document","querySelector","cmid","activityElement","remove","target","MutationObserver","mutations","setNavigationObservers","m","addedNodes","async","courseStateData","ajax","call","methodname","args","courseid","M","cfg","courseId","JSON","parse","getCourseState","then","courseState","sections","currentSectionId","section","filter","el","current","_courseState$section$","id","dataset","classList","add","contains","observe","childList","subtree"],"mappings":";;;;;;;wMA+BMA,aAAgBC,OAClBA,KAAKC,iBAAiB,+CAA+CC,SAASC,WACrEA,KAAKC,aAAa,SAAU,OACvBC,KAAOF,KAAKG,YAAYC,OAC1BF,MACAF,KAAKK,aAAa,QAASH,WAWrCI,YAAeC,OACK,IAAlBA,KAAKC,UAGTZ,aAAaW,OAeXE,8BAAgC,WAC5BC,YARSC,QAAQ,eACTC,qBAAuB,OAQhCF,aAAsC,IAAvBA,YAAYG,oBAI1BC,YAAcC,SAASC,cAAc,gBACtCF,aAMLJ,YAAYX,SAAQkB,aACVC,gBAAkBJ,YAAYE,kCAA2BC,2BAC3DC,iBACAA,gBAAgBC,2BAsBR,KAChBvB,aAAamB,gBAEPK,OAASL,SAASC,cAAc,mBAClCI,OAAQ,CAERX,gCACiB,IAAIY,kBAAkBC,8CACvBC,yBACZD,UAAUvB,SAASyB,IACfA,EAAEC,WAAW1B,QAAQO,gBAGzBG,gCA9BWiB,iBAEbC,sBAAwBC,cAAKC,KAAK,CAAC,CACrCC,WAAY,8BACZC,KAAM,CACFC,SAAUC,EAAEC,IAAIC,aAEpB,UACGC,KAAKC,MAAMV,kBAuBVW,GAAiBC,MAAKC,8CACZC,SAAW1B,SAASjB,iBAAiB,6CACrC4C,+CAAmBF,YAAYG,QAAQC,QAAOC,IAAMA,GAAGC,UAAS,2CAA7CC,sBAAiDC,GAC1EP,SAAS1C,SAAQ4C,UACTD,mBAAqBC,QAAQM,QAAQD,IACrCL,QAAQO,UAAUC,IAAI,WAClBpC,SAASC,cAAc,wCACvB2B,QAAQ3B,cAAc,qBAAqBkC,UAAUC,IAAI,cAG7DR,QAAQO,UAAU/B,OAAO,WACrBJ,SAASC,cAAc,wCACvB2B,QAAQ3B,cAAc,qBAAqBkC,UAAU/B,OAAO,mBAKrDJ,SAASjB,iBAAiB,iFAElCC,SAAS4C,UAChBA,QAAQO,UAAUE,SAAS,WAC3BT,QAAQ3B,cAAc,qBAAqBkC,UAAUC,IAAI,YAEzDR,QAAQ3B,cAAc,qBAAqBkC,UAAU/B,OAAO,kBAI/DkC,QAAQjC,OAAQ,CAACkC,WAAW,EAAMC,SAAS"}