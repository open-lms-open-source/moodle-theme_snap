{"version":3,"file":"sidebar_menu.min.js","sources":["../src/sidebar_menu.js"],"sourcesContent":["/* eslint-disable no-trailing-spaces */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport {isSmall} from 'core/pagehelpers';\nimport {addCloseButtonToBlockSettings} from './util';\nimport {setUserPreferences, getUserPreferences} from 'core_user/repository';\n\n/**\n * JavaScript for the Snap theme sidebar menu functionality\n *\n * @module     theme_snap/sidebar_menu\n * @copyright  2024 Open LMS (https://www.openlms.net)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nconst SELECTORS = {\n    SIDEBAR: '#snap-sidebar-menu',\n    TRIGGER: '.snap-sidebar-menu-trigger',\n    TRIGGER_ICON: '.snap-sidebar-menu-trigger i',\n    HEADER: 'header',\n    DRAWER_BUTTON: '.snap-sidebar-menu-item[data-activeselector], ' +\n        '.drawer-toggler.drawer-left-toggle [data-activeselector]',\n    COURSE_INDEX_DRAWER_BUTTON: '.drawer-toggler.drawer-left-toggle',\n    MESSAGES_POPOVER: '[data-region=\"popover-region-messages\"]',\n    CLOSE_DRAWER_BUTTON: '[data-action=\"closedrawer\"]',\n    SIDEBAR_MENU_ITEM: '.snap-sidebar-menu-item',\n    NAV_UNPINNED: '#mr-nav.headroom--unpinned',\n    GOTO_TOP_LINK: '#goto-top-link',\n    COURSE_TOC: '#course-toc',\n    PAGE_HEADER: 'page-header',\n    DRAWER_LEFT: '.drawer-left.drawer',\n    SNAP_COURSE_FOOTER: 'snap-course-footer',\n    MODAL_BACKDROP: 'body > div > div.modal-backdrop',\n    CLOSE_MESSAGE_DRAWER_BUTTON: '[id^=\"message-drawer-\"] a[data-action=\"closedrawer\"]',\n    MESSAGE_APP_CLASS: 'div[id^=\\'drawer-\\'] > div.message-app',\n    MESSAGE_DRAWER_TOGGLE: 'a[id^=\"message-drawer-toggle\"]',\n};\n\nconst CLASSES = {\n    CUSTOM_MENU_ITEM: 'custom-menu-item',\n    SHOW: 'show',\n    ACTIVE: 'active',\n    COLLAPSED: 'collapsed',\n    ROTATE: 'rotate-180',\n    STATE_VISIBLE: 'state-visible',\n    POSITIONING_OFFSCREEN: 'positioning-offscreen',\n    DRAWER_OPEN: 'snap_drawer_open',\n};\n\nconst DRAWERS = {\n    SELECTORS: [\n        '.drawer',\n        '.block_settings.block',\n        '#snap_feeds_side_menu',\n        '.drawer:has(.message-app)'\n    ],\n    ACTIVE_SELECTORS: [\n        '.drawer-left.drawer.show',\n        '.drawer-right.drawer.show',\n        '.block_settings.block.state-visible',\n        '#snap_feeds_side_menu.state-visible',\n        '.drawer:not(.hidden):has(.message-app)'\n    ]\n};\n\nconst POPOVERS_DROPDOWNS = {\n    CLICKABLE_SELECTORS: [\n        '#user-menu-toggle', // User menu\n        '#nav-intellicart-popover-container', // Intellicart\n        '#nav-notification-popover-container', // Notifications\n        '#local-accessibility-buttoncontainer', // Accessibility\n    ]\n};\n\nconst ACTIVE_SELECTORS = {\n    BLOCKS_DRAWER: '[data-activeselector=\"#theme_snap-drawers-blocks.show\"]',\n    SNAP_FEEDS: '[data-activeselector=\"#snap_feeds_side_menu_trigger.active\"]',\n    MESSAGES_DRAWER: '[data-activeselector=\\'[data-region=\"popover-region-messages\"]:not(.collapsed)\\']',\n};\n\nconst PREFERENCES = {\n    BLOCKS_DRAWER: 'drawer-open-block',\n    SNAP_FEEDS: 'snap-feeds-open',\n    MESSAGES_DRAWER: 'snap-message-drawer-open',\n};\n\nconst FORCEOPEN_BODY_IDS = [\n    'page-mod-quiz-attempt',\n    'page-mod-book-view'\n];\n\nconst PREFERENCE_MAP = {\n    [PREFERENCES.BLOCKS_DRAWER]: ACTIVE_SELECTORS.BLOCKS_DRAWER,\n    [PREFERENCES.SNAP_FEEDS]: ACTIVE_SELECTORS.SNAP_FEEDS,\n    [PREFERENCES.MESSAGES_DRAWER]: ACTIVE_SELECTORS.MESSAGES_DRAWER,\n};\n\nlet lastScrollX = 0;\n\n/**\n * Toggle sidebar menu visibility and update its position\n */\nconst toggleSidebar = () => {\n    const sidebar = document.querySelector(SELECTORS.SIDEBAR);\n    const icon = document.querySelector(SELECTORS.TRIGGER_ICON);\n    const isClosing = sidebar.classList.contains(CLASSES.SHOW);\n\n    sidebar.classList.toggle(CLASSES.SHOW);\n    icon.classList.toggle(CLASSES.ROTATE);\n    updateElementPositions();\n    \n    // If we're closing the sidebar, close any open drawers\n    if (isClosing) {\n        closeAllDrawers();\n    }\n};\n\n/**\n * Update the position of UI elements relative to the header\n * @param {Array|string|null} selectors - CSS selector(s) for elements to update, or null for sidebar only\n */\nconst updateElementPositions = (selectors = null) => {\n    const header = document.querySelector(SELECTORS.HEADER);\n    if (!header) {\n        return;\n    }\n\n    const headerRect = header.getBoundingClientRect();\n    const visibleHeight = window.innerHeight;\n    const topPosition = Math.max(0, headerRect.bottom);\n    const isNavUnpinned = document.querySelector(SELECTORS.NAV_UNPINNED);\n    \n    const sidebar = document.querySelector(SELECTORS.SIDEBAR);\n    if (sidebar) {\n        if (isNavUnpinned) {\n            sidebar.style.top = '0px';\n            sidebar.style.height = '100vh';\n        } else {\n            sidebar.style.top = `${topPosition}px`;\n            sidebar.style.height = `${visibleHeight - topPosition}px`;\n        }\n        \n        // Remove positioning-offscreen class after positioning is complete\n        // Add a small delay before removing the positioning-offscreen class\n        setTimeout(() => {\n            sidebar.classList.remove(CLASSES.POSITIONING_OFFSCREEN);\n        }, 100);\n    }\n\n    if (selectors) {\n        const selectorsArray = Array.isArray(selectors) ? selectors : [selectors];\n        \n        // Update each element's position\n        selectorsArray.forEach(selector => {\n            const elements = queryActiveDrawers(selector);\n            \n            elements.forEach(element => {    \n                if (isNavUnpinned) {\n                    element.style.top = '0px';\n                    element.style.height = '100vh';\n                } else {\n                    element.style.top = `${topPosition}px`;\n                    element.style.height = `${visibleHeight - topPosition}px`;\n                }\n                \n                // Ensure the element is visible within the viewport if it's active\n                if (element.classList.contains(CLASSES.SHOW) || \n                    element.classList.contains(CLASSES.ACTIVE) || \n                    !element.classList.contains(CLASSES.COLLAPSED)) {\n                    element.style.maxHeight = isNavUnpinned ? '100vh' : `${visibleHeight - topPosition}px`;\n                }\n            });\n        });\n    }\n\n    /**\n     * Updates the vertical position of the course index button so that it:\n     * - Is positioned at 40% of the viewport height by default,\n     * - Never overlaps or sits above the bottom of the page header,\n     * - Never overlaps or goes below the top of the footer,\n     *\n     * Ensures the button stays visible and properly positioned between header and footer,\n     * and updates its position dynamically on window resize and scroll events.\n     */\n    const courseindexbutton = document.querySelector(SELECTORS.COURSE_INDEX_DRAWER_BUTTON);\n    const drawer = document.querySelector(SELECTORS.DRAWER_LEFT);\n    const footer = document.getElementById(SELECTORS.SNAP_COURSE_FOOTER);\n\n    if (courseindexbutton && drawer) {\n        const updateButtonVisibility = () => {\n            const pageHeader = document.getElementById(SELECTORS.PAGE_HEADER);\n            const headerRect = pageHeader.getBoundingClientRect();\n            const footerRect = footer.getBoundingClientRect();\n\n            const top40Percent = window.innerHeight * 0.4;\n\n            const buttonHeight = courseindexbutton.offsetHeight || 0;\n            const maxTop = footerRect.top - buttonHeight - 10;\n\n            let newTop = Math.max(headerRect.bottom + 1, top40Percent);\n\n            newTop = Math.min(newTop, maxTop);\n            courseindexbutton.style.top = `${newTop}px`;\n\n        };\n        updateButtonVisibility();\n    }\n};\n\n/**\n * Handle drawer button clicks\n * @param {Event} e - The event object\n */\nconst handleDrawerButtonClick = (e) => {\n    setTimeout(() => {\n        const button = e.target.closest(SELECTORS.DRAWER_BUTTON);\n        repositionGotoTopLink();\n        if (!button) {\n            return;\n        }\n\n        const activeSelector = button.dataset.activeselector;\n        if (!activeSelector) {\n            return;\n        }\n\n        const activeElements = document.querySelectorAll(activeSelector);\n        const isActive = Array.from(activeElements).some(\n            (el) =>\n            el.classList.contains(CLASSES.SHOW) ||\n            el.classList.contains(CLASSES.ACTIVE) ||\n            !el.classList.contains(CLASSES.COLLAPSED) // Consider not collapsed as active\n        );\n\n        if (isActive) {\n            // If this drawer is being opened, close others\n            closeOtherDrawers(activeSelector, button);\n            button.classList.add(CLASSES.ACTIVE);\n            setDrawerPreference(activeSelector, true);\n            toggleBodyDrawerClass();\n        } else {\n            button.classList.remove(CLASSES.ACTIVE);\n            setDrawerPreference(activeSelector, false);\n            toggleBodyDrawerClass();\n        }\n    }, 50); // Small delay to allow the drawer state to update\n};\n\n/**\n * Close all active drawers except the one matching the given selector\n * @param {string} currentSelector - The selector for the drawer to keep open\n * @param {Element} currentButton - The button that was clicked\n */\nconst closeOtherDrawers = (currentSelector, currentButton) => {\n    const drawerButtons = document.querySelectorAll(SELECTORS.DRAWER_BUTTON);\n    repositionGotoTopLink();\n    drawerButtons.forEach(button => {\n        if (button === currentButton) {\n            return;\n        }\n\n        const activeSelector = button.dataset.activeselector;\n        if (!activeSelector || activeSelector === currentSelector) {\n            return;\n        }\n\n        const activeElements = document.querySelectorAll(activeSelector);\n        const isActive = Array.from(activeElements).some(el =>\n            el.classList.contains(CLASSES.SHOW) ||\n            el.classList.contains(CLASSES.ACTIVE) ||\n            !el.classList.contains(CLASSES.COLLAPSED) // Consider not collapsed as active\n        );\n\n        if (isActive) {\n            const isCustomContent = button.classList.contains(CLASSES.CUSTOM_MENU_ITEM);\n            if (isCustomContent) {\n                const clickableElement = button.querySelector('a, button') || button;\n                clickableElement.click();\n            } else {\n                button.click();\n            }\n            setDrawerPreference(activeSelector, false);\n            button.classList.remove(CLASSES.ACTIVE);\n        }\n    });\n};\n\n/**\n * Close all active drawers\n */\nconst closeAllDrawers = () => {\n    const drawerButtons = document.querySelectorAll(SELECTORS.DRAWER_BUTTON);\n    repositionGotoTopLink();\n    drawerButtons.forEach(button => {\n        const activeSelector = button.dataset.activeselector;\n        if (!activeSelector) {\n            return;\n        }\n        \n        const activeElements = document.querySelectorAll(activeSelector);\n        const isActive = Array.from(activeElements).some(el =>\n            el.classList.contains(CLASSES.SHOW) ||\n            el.classList.contains(CLASSES.ACTIVE) ||\n            !el.classList.contains(CLASSES.COLLAPSED) // Consider not collapsed as active\n        );\n\n        if (isActive) {\n            const isCustomContent = button.classList.contains(CLASSES.CUSTOM_MENU_ITEM);\n            if (isCustomContent) {\n                const clickableElement = button.querySelector('a, button') || button;\n                clickableElement.click();\n            } else {\n                button.click();\n            }\n            button.classList.remove(CLASSES.ACTIVE);\n        }\n    });\n};\n\n/**\n * Handle messages popover click\n * @param {Event} e - The event object\n */\nconst handleMessagesPopoverClick = (e) => {\n    const sidebarItem = e.currentTarget.closest(SELECTORS.SIDEBAR_MENU_ITEM);\n    repositionGotoTopLink();\n    if (sidebarItem) {\n        const isCollapsed = e.currentTarget.classList.contains(CLASSES.COLLAPSED);\n        if (isCollapsed) {\n            e.currentTarget.classList.remove(CLASSES.COLLAPSED);\n        } else {\n            e.currentTarget.classList.add(CLASSES.COLLAPSED);\n        }\n    }\n};\n\n/**\n * Set the Actual Drawer based on user preferences.\n *\n * @return {Promise}\n */\nconst setActiveDrawer = async() => {\n    let preferences = await getUserPreferences(null, M.cfg.userId);\n    const preferencesArray = {};\n\n    // Ensure required preference keys exist with default value if missing.\n    const defaultPreferences = {};\n    Object.values(PREFERENCES).forEach(key => {\n        if (!(key in preferences)) {\n            defaultPreferences[key] = 0;\n        }\n    });\n    preferences = { ...defaultPreferences, ...preferences };\n\n    Object.keys(preferences).forEach(pref => {\n        if (M.cfg.behatsiterunning) {\n            preferencesArray[pref] = 0;\n        } else {\n            preferencesArray[pref] = preferences[pref];\n        }\n        if (pref === PREFERENCES.BLOCKS_DRAWER) {\n            // Force open but not in small screen sizes.\n            if (FORCEOPEN_BODY_IDS.includes(document.body.id) && window.innerWidth > 500) {\n                preferencesArray[pref] = 1;\n            }\n        }\n    });\n    // Review which user preference is set to true, from PREFERENCE_MAP\n    for (const [prefKey, drawerSelector] of Object.entries(PREFERENCE_MAP)) {\n        // See if any Drawer was opened. (Preference set to 1)\n        const shouldOpen = preferencesArray[prefKey] === 1 || preferencesArray[prefKey] === '1';\n\n        if (shouldOpen) {\n            const button = document.querySelector(drawerSelector);\n            if (button) {\n                // Simulate click on button.\n                const clickableElement = button.querySelector('a, button') || button;\n                clickableElement.click();\n            }\n        }\n    }\n};\n\n/**\n * Set User preferences for the corresponding Drawer selected.\n * If \"Value\" = true, sets selected drawer to open and others to closed.\n * If \"Value\" = false, sets selected drawer to closed only.\n * @param {string} activeSelector - The selector for the drawer requested\n * @param {boolean} value - The value for the preference\n */\nconst setDrawerPreference = (activeSelector, value) => {\n    // Loop all preferences map and set true or false to selected one.\n    for (const [preference, selector] of Object.entries(PREFERENCE_MAP)) {\n        if (selector.includes(activeSelector) && !isSmall() && value) {\n            // Set open status to selected Drawer.\n            setUserPreferences([{name: preference, value: true, userid: M.cfg.userId}]);\n        } else if (value) {\n            // Set closed status to other Drawers.\n            setUserPreferences([{name: preference, value: false, userid: M.cfg.userId}]);\n        } else if (selector.includes(activeSelector) && !value) {\n            // Set closed status to selected Drawer.\n            setUserPreferences([{name: preference, value: false, userid: M.cfg.userId}]);\n        }\n    }\n};\n\n\n/**\n * Handle close drawer button clicks\n */\nconst handleCloseDrawerClick = () => {\n    repositionGotoTopLink();\n    // Remove active classes from all drawer buttons\n    document.querySelectorAll(SELECTORS.DRAWER_BUTTON).forEach(button => {\n        button.classList.remove(CLASSES.ACTIVE);\n        document.body.classList.remove(CLASSES.DRAWER_OPEN);\n    });\n    \n    // Add collapsed class to messages popover if it's open\n    const messagesPopover = document.querySelector(SELECTORS.MESSAGES_POPOVER);\n    if (messagesPopover && !messagesPopover.classList.contains(CLASSES.COLLAPSED)) {\n        messagesPopover.classList.add(CLASSES.COLLAPSED);\n    }\n};\n\n/**\n * Setup all event listeners\n */\nconst setupEventListeners = () => {\n    const trigger = document.querySelector(SELECTORS.TRIGGER);\n    if (trigger) {\n        trigger.addEventListener('click', toggleSidebar);\n    }\n\n    // Update both sidebar and drawer positions on resize and scroll\n    window.addEventListener('resize', () => {\n        updateElementPositions(DRAWERS.SELECTORS);\n    });\n    \n    window.addEventListener('scroll', () => {\n        // Add a small delay to avoid performance issues with rapid scroll events\n        setTimeout(() => {\n            updateElementPositions(DRAWERS.SELECTORS);\n            \n            // Check if Go to Top link is visible and reposition it if needed\n            const gotoTopLink = document.querySelector(SELECTORS.GOTO_TOP_LINK);\n            if (gotoTopLink) {\n                const computedStyle = window.getComputedStyle(gotoTopLink);\n                if (computedStyle.visibility === 'visible') {\n                    repositionGotoTopLink();\n                }\n            }\n            \n            // Handle horizontal scrolling to control sticky elements (e.g. grader)\n            toggleSidebarOnHorizontalScroll(window.scrollX);\n        }, 50);\n    });\n\n    // Add click event listeners to drawer buttons\n    document.querySelectorAll(SELECTORS.DRAWER_BUTTON).forEach(button => {\n        button.addEventListener('click', handleDrawerButtonClick);\n    });\n    \n    // Add click event listener to messages popover\n    const messagesPopover = document.querySelector(SELECTORS.MESSAGES_POPOVER);\n    if (messagesPopover) {\n        messagesPopover.addEventListener('click', handleMessagesPopoverClick);\n\n        // We have an event from Core subscribed with PubSub, that always runs after Snap has run,\n        // and it creates the unwanted modal backdrop, see message/amd/src/message_drawer.js.\n        const messageDrawerPopover = document.querySelector(SELECTORS.MESSAGES_POPOVER);\n        const messageDrawerCloseIcon = document.querySelector(SELECTORS.CLOSE_MESSAGE_DRAWER_BUTTON);\n        const dismissCoreModalBackdrop = function(mutations) {\n            for (const mutation of mutations) {\n                if (mutation.type === 'childList') {\n                    const messagesPopoverCoreModalBackdrop =\n                        document.querySelector(SELECTORS.MODAL_BACKDROP);\n                    if (messagesPopoverCoreModalBackdrop && (document.activeElement === messageDrawerPopover\n                        || document.activeElement === messageDrawerCloseIcon)) {\n                        messagesPopoverCoreModalBackdrop.remove();\n                    }\n                    const messagePopoverIsHidden =\n                        document.querySelector(SELECTORS.MESSAGE_APP_CLASS)\n                            .parentElement.classList.contains('hidden');\n                    const messageDrawerIcon = document.querySelector(SELECTORS.MESSAGE_DRAWER_TOGGLE);\n\n                    if (messagePopoverIsHidden && messageDrawerIcon === document.activeElement) {\n                        messageDrawerIcon.blur();\n                    }\n                }\n            }\n        };\n        const messageDrawerObserver = new MutationObserver(dismissCoreModalBackdrop);\n        messageDrawerObserver.observe(document.body, {subtree: true, childList: true});\n    }\n    \n    // Add click event listeners to elements with data-action=\"closedrawer\"\n    document.querySelectorAll(SELECTORS.CLOSE_DRAWER_BUTTON).forEach(element => {\n        element.addEventListener('click', handleCloseDrawerClick);\n    });\n    \n    // Set up popover/dropdown click handlers\n    setupPopoverClickHandlers();\n};\n\n/**\n * Initialize the sidebar menu functionality\n */\nexport const init = () => {\n    addCloseButtonToBlockSettings();\n    setupEventListeners();\n    updateElementPositions();\n    \n    // Update positions of all drawers\n    updateElementPositions(DRAWERS.SELECTORS);\n    // Open active Drawer.\n    setActiveDrawer();\n};\n\n/**\n * Query active drawers, applying a workaround for selectors containing ':has' if needed.\n * TODO: Delete this when the selenium version of the job is higher than 3.141.59\n *\n * @param {string} selector The CSS selector to query.\n * @returns {NodeListOf<Element>|Array<Element>} A NodeList or an Array of matching elements.\n */\nconst queryActiveDrawers = (selector) => {\n    // Check if the selector string contains ':has(' and matches the specific known case\n    if (selector === '.drawer:not(.hidden):has(.message-app)') {\n        // Workaround for :has(.message-app)\n        const potentialDrawers = document.querySelectorAll('.drawer:not(.hidden)');\n        return Array.from(potentialDrawers).filter(drawer => drawer.querySelector('.message-app'));\n    } else if (selector === '.drawer:has(.message-app)') {\n        const potentialDrawers = document.querySelectorAll('.drawer');\n        return Array.from(potentialDrawers).filter(drawer => drawer.querySelector('.message-app'));\n    } else {\n        // Standard query for other selectors\n        return document.querySelectorAll(selector);\n    }\n};\n\n/**\n * Reposition the \"Go to Top\" button based on open drawers\n */\nconst repositionGotoTopLink = () => {\n    const gotoTopLink = document.querySelector(SELECTORS.GOTO_TOP_LINK);\n    if (!gotoTopLink) {\n        return;\n    }\n    \n    gotoTopLink.style.marginRight = '';\n    \n    // Check if sidebar is showing\n    const sidebar = document.querySelector(SELECTORS.SIDEBAR);\n    const isSidebarShowing = sidebar && sidebar.classList.contains(CLASSES.SHOW);\n    \n    // Only proceed if sidebar is showing\n    if (isSidebarShowing) {\n        // Check each drawer selector using the helper function\n        for (const selector of DRAWERS.ACTIVE_SELECTORS) {\n            const activeDrawers = queryActiveDrawers(selector); // Use the helper function\n\n            if (activeDrawers.length > 0) {\n                // Get the first active drawer found for this selector type\n                const drawer = activeDrawers[0];\n                if (drawer.offsetWidth > 0 && !drawer.classList.contains('drawer-left')) {\n                    // Get the width of the drawer\n                    const drawerWidth = drawer.offsetWidth;\n                    // Add margin to position the link to the left of the drawer\n                    gotoTopLink.style.marginRight = `${drawerWidth}px`;\n                    return; // Exit after finding the first open drawer\n                }\n            }\n        }\n    }\n};\n\n/**\n * Hide or show the sidebar based on horizontal scroll position\n * @param {number} scrollX - The horizontal scroll position\n */\nconst toggleSidebarOnHorizontalScroll = (scrollX) => {\n    const sidebar = document.querySelector(SELECTORS.SIDEBAR);\n    if (!sidebar) {\n        return;\n    }\n    if (scrollX !== 0) {\n        if (lastScrollX === 0) {\n            // Hide sidebar\n            sidebar.style.right = '-100%';\n            sidebar.classList.remove('show');\n            // Hide active drawers\n            DRAWERS.ACTIVE_SELECTORS.forEach(selector => {\n                const activeDrawers = queryActiveDrawers(selector); // Use the helper function\n                activeDrawers.forEach(drawer => {\n                    drawer.style.right = '-100%';\n                });\n            });\n        }\n    } else if (lastScrollX !== 0) {\n        // When returning to scroll position 0\n        sidebar.style.right = '';\n        sidebar.classList.add('show');\n        // Restore active drawers visibility\n        DRAWERS.ACTIVE_SELECTORS.forEach(selector => {\n            const activeDrawers = queryActiveDrawers(selector); // Use the helper function\n            activeDrawers.forEach(drawer => {\n                drawer.style.right = '';\n            });\n        });\n    }\n    lastScrollX = scrollX;\n};\n\n/**\n * Add event listeners to popover/dropdown elements to close drawers first\n */\nconst setupPopoverClickHandlers = () => {\n    let isClosingDrawers = false;\n\n    const checkAndCloseDrawers = () => {\n        if (isClosingDrawers) {\n            return false;\n        }\n\n        let hasOpenDrawers = false;\n        DRAWERS.ACTIVE_SELECTORS.forEach(selector => {\n            const activeDrawers = queryActiveDrawers(selector); // Use the helper function\n            if (activeDrawers.length > 0) {\n                hasOpenDrawers = true;\n            }\n        });\n\n        if (hasOpenDrawers) {\n            // Set flag to prevent recursive calls\n            isClosingDrawers = true;\n            // Close all drawers first\n            closeAllDrawers();\n            isClosingDrawers = false;\n            return true;\n        }\n\n        return false;\n    };\n\n    POPOVERS_DROPDOWNS.CLICKABLE_SELECTORS.forEach(selector => {\n        const elements = document.querySelectorAll(selector);\n\n        elements.forEach(element => {\n            // Handle mouse clicks\n            element.addEventListener('click', () => {\n                checkAndCloseDrawers();\n            }, true);\n\n            // Handle keyboard events (Enter key)\n            element.addEventListener('keydown', (e) => {\n                // Check if the Enter key was pressed\n                if (e.key === 'Enter' || e.keyCode === 13) {\n                    checkAndCloseDrawers();\n                }\n            }, true);\n        });\n    });\n};\n\n/**\n * Toggle the \"snap_drawer_open\" class in the body, used to apply styles if necessary.\n */\nconst toggleBodyDrawerClass = () => {\n    const drawerButtons = document.querySelectorAll(SELECTORS.DRAWER_BUTTON);\n    let drawerActive = false;\n    drawerButtons.forEach(button => {\n        const activeSelector = button.dataset.activeselector;\n        if (!activeSelector) {\n            return;\n        }\n\n        const activeElements = document.querySelectorAll(activeSelector);\n        const isActive = Array.from(activeElements).some(el =>\n            el.classList.contains(CLASSES.SHOW) ||\n            el.classList.contains(CLASSES.ACTIVE) ||\n            !el.classList.contains(CLASSES.COLLAPSED) // Consider not collapsed as active\n        );\n\n        if (isActive) {\n            drawerActive = true;\n        }\n    });\n    if (drawerActive) {\n        document.body.classList.add(CLASSES.DRAWER_OPEN);\n    } else {\n        document.body.classList.remove(CLASSES.DRAWER_OPEN);\n    }\n};\n"],"names":["SELECTORS","CLASSES","DRAWERS","ACTIVE_SELECTORS","POPOVERS_DROPDOWNS","CLICKABLE_SELECTORS","PREFERENCES","BLOCKS_DRAWER","SNAP_FEEDS","MESSAGES_DRAWER","FORCEOPEN_BODY_IDS","PREFERENCE_MAP","lastScrollX","toggleSidebar","sidebar","document","querySelector","icon","isClosing","classList","contains","toggle","updateElementPositions","closeAllDrawers","selectors","header","headerRect","getBoundingClientRect","visibleHeight","window","innerHeight","topPosition","Math","max","bottom","isNavUnpinned","style","top","height","setTimeout","remove","Array","isArray","forEach","selector","queryActiveDrawers","element","maxHeight","courseindexbutton","drawer","footer","getElementById","updateButtonVisibility","footerRect","top40Percent","buttonHeight","offsetHeight","maxTop","newTop","min","handleDrawerButtonClick","e","button","target","closest","repositionGotoTopLink","activeSelector","dataset","activeselector","activeElements","querySelectorAll","from","some","el","closeOtherDrawers","add","setDrawerPreference","toggleBodyDrawerClass","currentSelector","currentButton","drawerButtons","click","handleMessagesPopoverClick","sidebarItem","currentTarget","value","preference","Object","entries","includes","name","userid","M","cfg","userId","handleCloseDrawerClick","body","messagesPopover","trigger","addEventListener","gotoTopLink","getComputedStyle","visibility","toggleSidebarOnHorizontalScroll","scrollX","messageDrawerPopover","messageDrawerCloseIcon","MutationObserver","mutations","mutation","type","messagesPopoverCoreModalBackdrop","activeElement","messagePopoverIsHidden","parentElement","messageDrawerIcon","blur","observe","subtree","childList","setupPopoverClickHandlers","setupEventListeners","async","preferences","preferencesArray","defaultPreferences","values","key","keys","pref","behatsiterunning","id","innerWidth","prefKey","drawerSelector","setActiveDrawer","potentialDrawers","filter","marginRight","activeDrawers","length","offsetWidth","drawerWidth","right","isClosingDrawers","checkAndCloseDrawers","hasOpenDrawers","keyCode","drawerActive"],"mappings":"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"}