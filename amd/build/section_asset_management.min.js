/**
 * This file is part of Moodle - http://moodle.org/
 *
 * Moodle is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Moodle is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @package
 * @copyright Copyright (c) 2015 Open LMS (https://www.openlms.net)
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("theme_snap/section_asset_management",["jquery","core/log","core/ajax","core/str","core/templates","core/notification","theme_snap/util","theme_snap/ajax_notification","core_filters/events","core/fragment","core_courseformat/local/content/actions","core_courseformat/courseeditor"],(function($,log,ajax,str,templates,notification,util,ajaxNotify,Event,fragment,Actions,CourseEditor){var ajaxTracker,self=this,sectionsProcess=[],progressCache=null,setTocObservers=function(){"weeks"!=self.courseConfig.format&&"topics"!=self.courseConfig.format||$("#toc-searchables li a").click((function(e){var urlParams=$(e.target).attr("href").split("&"),section=urlParams[0],mod=urlParams[1]||null;section=section.split("#section-")[1],getSection(section,mod)}))},setNavigationFooterObservers=function(){"weeks"!=self.courseConfig.format&&"topics"!=self.courseConfig.format||$(".section_footer a.next_section, .section_footer a.previous_section").click((function(e){e.preventDefault();var section=$(this).attr("section-number");void 0!==section&&section.length>0&&(self.courseConfig.sectionnum=parseInt(section),getSection(section,0))}))};var getSection=function(section,mod){if(0==$("ul.sections > #section-"+section).length&&-1==sectionsProcess.indexOf(section)){sectionsProcess.push(section);var params={courseid:self.courseConfig.id,section:section};$(".sk-fading-circle").show(),$(".course-content ."+self.courseConfig.format+'ul.sections > li[id^="section-"]').hide(),fragment.loadFragment("theme_snap","section",self.courseConfig.contextid,params).done((function(html,js){var node=$(html);renderSection(section,node,mod,js);var folders=node.find("li.snap-activity.modtype_folder");$.each(folders,(function(index,folder){var content=$(folder).find("div.contentwithoutlink div.snap-assettype");if(content.length>0&&0==$(folder).find("div.activityinstance div.snap-header-card .asset-type").length){var folderAssetTypeHeader=$(folder).find("div.activityinstance div.snap-header-card");content.prependTo(folderAssetTypeHeader)}}))}))}else $(window).trigger("hashchange")},renderSection=function(section,html,mod,js){var anchor=$(".course-content"),existingSections=[];anchor.find("ul.sections>li[id^=section-]").each((function(){existingSections.push(parseInt($(this).attr("id").split("section-")[1]))}));var tempnode=$("<div></div>");if(templates.replaceNodeContents(tempnode,html,""),existingSections.length>0){var closest=existingSections.reduce((function(prev,curr){return Math.abs(curr-section)<Math.abs(prev-section)?curr:prev}));closest>section?anchor.find("ul.sections > #section-"+closest).before(tempnode.contents()):anchor.find("ul.sections > #section-"+closest).after(tempnode.contents())}else $(".sk-fading-circle").after(tempnode);templates.runTemplateJS(js),$(".sk-fading-circle").hide(),Event.notifyFilterContentUpdated($(".course-content ."+self.courseConfig.format));var sections=anchor.find('ul.sections>li[id^="section-"]');sections.removeClass("state-visible");var id="ul.sections>#section-"+section;$(id).addClass("state-visible"),sections.show(),setNavigationFooterObservers(),$(id+" .section-modchooser-link").click((function(){var sectionNum=$(this).attr("data-sectionid");$(".snap-modchooser-addlink").each((function(){var newLink=this.href.replace(/(section=)[0-9]+/gi,"$1"+sectionNum);$(this).attr("href",newLink)}))})),0!=mod&&void 0!==mod&&function(modid){$("#toc-search-results").html("");var targmod=$("#"+modid.replace("#",""));util.scrollToElement(targmod);var searchpin=$("#searchpin");searchpin.length||(searchpin=$('<i id="searchpin"></i>')),$(targmod).find(".instancename").prepend(searchpin),$(targmod).attr("tabindex","-1").focus(),$("#course-toc").removeClass("state-visible")}(mod)};return{init:function(courseLib){self.courseConfig=courseLib.courseConfig;ajaxTracker=new function(){var triggersByKey={};this.start=function(jsPendingKey,trigger,subSelector){return this.ajaxing(jsPendingKey)?(log.debug("Skipping ajax request for "+jsPendingKey+", AJAX already in progress"),!1):(M.util.js_pending(jsPendingKey),triggersByKey[jsPendingKey]={trigger:trigger,subSelector:subSelector},trigger&&(subSelector?$(trigger).find(subSelector).addClass("ajaxing"):$(trigger).addClass("ajaxing")),!0)},this.ajaxing=function(jsPendingKey){return M.util.pending_js.indexOf(jsPendingKey)>-1},this.complete=function(jsPendingKey){var trigger,subSelector;triggersByKey[jsPendingKey]&&(trigger=triggersByKey[jsPendingKey].trigger,subSelector=triggersByKey[jsPendingKey].subSelector),trigger&&(subSelector?$(trigger).find(subSelector).removeClass("ajaxing"):$(trigger).removeClass("ajaxing")),delete triggersByKey[jsPendingKey],M.util.js_complete(jsPendingKey)}};var setCourseSectionObservers=function(){setTocObservers(),setNavigationFooterObservers();const isLoggedIn=document.querySelector("#snap-header  .usermenu"),onCoursePage=document.body.classList.contains("path-course-view");if(!isLoggedIn||!onCoursePage)return;CourseEditor.getCurrentCourseEditor().isEditing||function(){const sections=document.querySelector("ul.sections");sections&&sections.addEventListener("click",(function(e){const actionLink=e.target.closest('.action-menu a[data-action],.section-actions a[data-action],[data-action="newModule"].section-modchooser-link');let actionName=actionLink.dataset.action;if(!actionLink||"permalink"===actionName||"update"===actionName)return;e.preventDefault(),e.stopPropagation();const reactiveCourseEditor=CourseEditor.getCurrentCourseEditor();"topics"==self.courseConfig.format&&require(["format_topics/section"],(function(SectionModule){let editMode=reactiveCourseEditor.isEditing;reactiveCourseEditor._editing=!0,SectionModule.init(),reactiveCourseEditor._editing=editMode}));const actions=new Actions.prototype.constructor({element:actionLink,reactive:reactiveCourseEditor});"function"==typeof actions._dispatchClick&&actions._dispatchClick(e)}),{capture:!0})}()};setCourseSectionObservers(),$("body").addClass("snap-course-listening"),function(){if(0!==$(".snap-section-editing.actions").length){var trigger=$("#region-main");ajaxTracker.start("section_toc",trigger)&&ajax.call([{methodname:"theme_snap_course_sections",args:{courseshortname:courseLib.courseConfig.shortname,action:"toc",sectionnumber:0,value:0,loadmodules:0}}],!0,!0)[0].fail((function(response){var errMessage,errAction;errMessage=M.util.get_string("error:failedtotoc","theme_snap"),errAction=M.util.get_string("action:sectiontoc","theme_snap"),ajaxNotify.ifErrorShowBestMsg(response,errAction,errMessage).done((function(){ajaxTracker.complete("section_toc")}))})).always((function(){$(trigger).removeClass("ajaxing")})).done((function(response){progressCache=[],$.each(response.toc.chapters.chapters,(function(index,value){progressCache.push(value.progress)})),ajaxTracker.complete("section_toc")}))}}(),util.whenTrue((function(){return M.course&&M.course.init_section_toolbox}),(function(){M.course&&M.course.resource_toolbox&&(M.course.resource_toolbox.handle_resource_dim=function(button,activity,action){return"hide"===action?0:1})}),!0)},renderAndFocusSection:function(section,mod){getSection(section,mod)},setTocObserver:function(){setTocObservers()}}}));

//# sourceMappingURL=section_asset_management.min.js.map