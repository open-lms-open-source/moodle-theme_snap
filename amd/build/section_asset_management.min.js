/**
 * This file is part of Moodle - http://moodle.org/
 *
 * Moodle is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Moodle is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @package
 * @copyright Copyright (c) 2015 Open LMS (https://www.openlms.net)
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("theme_snap/section_asset_management",["jquery","core/log","core/ajax","core/str","core/templates","core/notification","theme_snap/util","theme_snap/ajax_notification","core_filters/events","core/fragment","core_courseformat/local/content/actions","core_courseformat/courseeditor","theme_snap/activity_cards"],(function($,log,ajax,str,templates,notification,util,ajaxNotify,Event,fragment,Actions,CourseEditor,activityCards){var self=this,sectionsProcess=[],setNavigationObservers=function(){if("weeks"==self.courseConfig.format||"topics"==self.courseConfig.format){var $elements=$([".section_footer a.next_section",".section_footer a.previous_section","#courseindex-content .courseindex-section-title a.courseindex-link"].join(", "));$elements.off("click"),$elements.click((function(e){var link=$(this),section=link.attr("section-number");if(!section){if(M.cfg.behatsiterunning)return;section=link.closest(".courseindex-section").attr("data-number")}void 0!==section&&section.length>0&&(e.preventDefault(),self.courseConfig.sectionnum=parseInt(section),getSection(section,0))})),setTOCVisibleSection()}};var setTOCVisibleSection=function(){var sectionIdSel=".section.main.state-visible, #coursetools.state-visible, #snap-add-new-section.state-visible";var currentSectionId=$(sectionIdSel).attr("data-id");$("#courseindex .courseindex-section").removeClass("snap-visible-section"),$("#courseindex .courseindex-section a.courseindex-link").attr("aria-current","false");var visibleSection=$('#courseindex .courseindex-section[data-id="'.concat(currentSectionId,'"]'));visibleSection.addClass("snap-visible-section"),visibleSection.find("a.courseindex-link").attr("aria-current","true")},getSection=function(section,mod){if(0==$("ul.sections > #section-"+section).length&&-1==sectionsProcess.indexOf(section)){sectionsProcess.push(section);var params={courseid:self.courseConfig.id,section:section};$(".sk-fading-circle").show(),$(".course-content ."+self.courseConfig.format+'ul.sections > li[id^="section-"]').hide(),fragment.loadFragment("theme_snap","section",self.courseConfig.contextid,params).done((function(html,js){var node=$(html);renderSection(section,node,mod,js);var folders=node.find("li.snap-activity.modtype_folder");$.each(folders,(function(index,folder){var content=$(folder).find("div.contentwithoutlink div.snap-assettype");if(content.length>0&&0==$(folder).find("div.activityinstance div.snap-header-card .asset-type").length){var folderAssetTypeHeader=$(folder).find("div.activityinstance div.snap-header-card");content.prependTo(folderAssetTypeHeader)}}))}))}else $(window).trigger("hashchange");updateBreadcrumb(section)},updateBreadcrumb=function(sectionId){const state=CourseEditor.getCurrentCourseEditor().state;if(!state||!state.section)return;const targetSection=Array.from(state.section.values()).find((sec=>sec.section==sectionId));if(!targetSection)return;let breadcrumbSections=[];if("mod_subsection"===targetSection.component&&targetSection.parentsectionid){const parentSection=state.section.find((sec=>sec.id==targetSection.parentsectionid));parentSection&&breadcrumbSections.push({id:parentSection.id,name:parentSection.title,url:parentSection.sectionurl,isCurrent:!1})}breadcrumbSections.push({id:targetSection.id,name:targetSection.title,url:targetSection.sectionurl,isCurrent:!0});let html="";breadcrumbSections.forEach((step=>{const ariaCurrent=step.isCurrent?'aria-current="page"':"";html+='<li class="breadcrumb-item">\n                            <a href="'.concat(step.url,'" ').concat(ariaCurrent,' data-section-name-for="').concat(step.id,'" >').concat(step.name,"</a>\n                         </li>")}));const breadcrumbList=document.querySelector("ol.breadcrumb");breadcrumbList.querySelectorAll("a[data-section-name-for]").forEach((link=>{const listItem=link.closest("li.breadcrumb-item");listItem&&listItem.remove()})),breadcrumbList.insertAdjacentHTML("beforeend",html)},renderSection=function(section,html,mod,js){var anchor=$(".course-content"),existingSections=[];anchor.find("ul.sections>li[id^=section-]").each((function(){existingSections.push(parseInt($(this).attr("id").split("section-")[1]))}));var tempnode=$("<div></div>");if(templates.replaceNodeContents(tempnode,html,""),existingSections.length>0){var closest=existingSections.reduce((function(prev,curr){return Math.abs(curr-section)<Math.abs(prev-section)?curr:prev}));closest>section?anchor.find("ul.sections > #section-"+closest).before(tempnode.contents()):anchor.find("ul.sections > #section-"+closest).after(tempnode.contents())}else $(".sk-fading-circle").after(tempnode);templates.runTemplateJS(js),$(".sk-fading-circle").hide(),Event.notifyFilterContentUpdated($(".course-content ."+self.courseConfig.format));var sections=anchor.find('ul.sections>li[id^="section-"]');sections.removeClass("state-visible");var id="ul.sections>#section-"+section;$(id).addClass("state-visible"),sections.show(),setNavigationObservers(),activityCards.init(),$(id+" .section-modchooser-link").click((function(){var sectionNum=$(this).attr("data-sectionid");$(".snap-modchooser-addlink").each((function(){var newLink=this.href.replace(/(section=)[0-9]+/gi,"$1"+sectionNum);$(this).attr("href",newLink)}))})),0!=mod&&void 0!==mod&&function(modid){$("#toc-search-results").html("");var targmod=$("#"+modid.replace("#",""));util.scrollToElement(targmod);var searchpin=$("#searchpin");searchpin.length||(searchpin=$('<i id="searchpin"></i>')),$(targmod).find(".instancename").prepend(searchpin),$(targmod).attr("tabindex","-1").focus()}(mod)};return{init:function(courseLib){self.courseConfig=courseLib.courseConfig;var setCourseSectionObservers=function(){"weeks"!=self.courseConfig.format&&"topics"!=self.courseConfig.format||$("#toc-searchables li a").click((function(e){var urlParams=$(e.target).attr("href").split("&"),section=urlParams[0],mod=urlParams[1]||null;section=section.split("#section-")[1],getSection(section,mod)})),setNavigationObservers();const isLoggedIn=document.querySelector("#snap-header  .usermenu"),onCoursePage=document.body.classList.contains("path-course-view");if(!isLoggedIn||!onCoursePage)return;CourseEditor.getCurrentCourseEditor().isEditing||function(){const sections=document.querySelector("ul.sections");sections&&sections.addEventListener("click",(function(e){const actionLink=e.target.closest('.action-menu a[data-action],.section-actions a[data-action],[data-action="newModule"].section-modchooser-link');if(!actionLink)return;let actionName=actionLink.dataset.action;if("permalink"===actionName||"update"===actionName)return;e.preventDefault(),e.stopPropagation();const reactiveCourseEditor=CourseEditor.getCurrentCourseEditor();"topics"==self.courseConfig.format&&require(["format_topics/section"],(function(SectionModule){let editMode=reactiveCourseEditor.isEditing;reactiveCourseEditor._editing=!0,SectionModule.init(),reactiveCourseEditor._editing=editMode}));const actions=new Actions.prototype.constructor({element:actionLink,reactive:reactiveCourseEditor});if("function"==typeof actions._dispatchClick&&(actions._dispatchClick(e),"cmDelete"===actionName)){let cmid=actionLink.dataset.id;$('#toc-searchables li[data-id="'+cmid+'"]').remove()}}),{capture:!0})}()};setCourseSectionObservers(),$("body").addClass("snap-course-listening"),util.whenTrue((function(){return M.course&&M.course.init_section_toolbox}),(function(){M.course&&M.course.resource_toolbox&&(M.course.resource_toolbox.handle_resource_dim=function(button,activity,action){return"hide"===action?0:1})}),!0)},renderAndFocusSection:function(section,mod){getSection(section,mod)},setNavigationObservers:function(){setNavigationObservers()},setTOCVisibleSection:function(){setTOCVisibleSection()}}}));

//# sourceMappingURL=section_asset_management.min.js.map