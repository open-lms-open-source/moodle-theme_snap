define(["jquery","core/log","core/ajax","core/templates","core/notification","theme_snap/util","theme_snap/ajax_notification","theme_snap/footer_alert"],function(a,b,c,d,e,f,g,h){return{init:function(i){var j,k=[],l=!1,m=function(b){return parseInt(a(b).attr("id").replace("section-",""))},n=function(b){return m(a(b).parents("li.section.main")[0])},o=function(){a("body").removeClass("snap-move-inprogress"),a("body").removeClass("snap-move-section"),a("body").removeClass("snap-move-asset"),h.hideAndReset(),a(".section-moving").removeClass("section-moving"),a(".asset-moving").removeClass("asset-moving"),a(".js-snap-asset-move").removeAttr("checked"),k=[]},p=function(){var b=a(j).find(".instancename").html();h.removeAjaxLoading(),h.setTitle(M.util.get_string("movefailed","theme_snap",b)),window.setTimeout(function(){o(!1)},2e3)},q=function(){var b;if(1===k.length){var c=a(k[0]).find(".snap-asset-link .instancename").html();c=c||M.str.label.pluginname,b=M.util.get_string("moving","theme_snap",c)}else b=M.util.get_string("movingcount","theme_snap",k.length);h.setTitle(b)},r=function(a){var b=k.indexOf(a);b>-1&&k.splice(b,1),q()},s=function(b,c){if(0===a(b).find(".loadingstat").length){var d=c?" spinner-dark":"";a(b).append('<div class="loadingstat spinner-three-quarters'+d+'">'+M.util.get_string("loading","theme_snap")+"</div>")}},t=function(c,d,e){if(l)return void b.debug("Skipping ajax request, one already in progress");h.addAjaxLoading(),c.sesskey=M.cfg.sesskey,c.courseId=i.courseConfig.id,c.field="move",b.debug("Making course/rest.php request",c);var f=a.ajax({type:"POST",async:!0,data:c,url:M.cfg.wwwroot+i.courseConfig.ajaxurl});f.done(function(a){g.ifErrorShowBestMsg(a).done(function(a){return a?(b.debug("Ajax request fail"),void p()):(b.debug("Ajax request successful"),d&&d(),e&&"resource"===c["class"]&&o(),void 0)})}),f.fail(function(){p()}),e&&f.always(function(){l=!1,h.removeAjaxLoading()})},u=function(b){return a("#chapters li:nth-of-type("+(b+1)+") .chapter-title").html()},v=function(b){var c,e,f=a.Deferred();if(b){c=a(b);var g=a("#region-main .course-content > ul li.section");e=g.length}else b="#region-main .course-content > ul li.section",c=a(b),e=c.length;var h=0;return a.each(c,function(b,g){var i,j,k=m(g),l=k-1,n=k+1,o=!1,p=!1;l>-1&&(i=a("#section-"+l).hasClass("hidden"),j=i?" dimmed_text":"",o={section:l,title:u(l),classes:j}),n<e&&(i=a("#section-"+n).hasClass("hidden"),j=i?" dimmed_text":"",p={section:n,title:u(n),classes:j});var q={previous:o,next:p};d.render("theme_snap/course_section_navigation",q).done(function(b){a("#section-"+k+" .section_footer").replaceWith(b),h++,h===c.length&&f.resolve()})}),f.promise()},w=function(){a.each(a("#region-main .course-content > ul li.section"),function(b,c){a(c).attr("id","section-"+b);var d=u(b);a("#section-"+b+" .content .sectionname").html(d)}),v()},x=function(f,j){f.preventDefault();var k=n(j),m=a("#section-"+k),o=m.find(".sectionname").text(),p=function(){if(l)return void b.debug("Skipping ajax request, one already in progress");var e=M.util.get_string("deletingsection","theme_snap",o);h.setTitle(e),h.addAjaxLoading(""),h.show();var f={courseshortname:i.courseConfig.shortname,action:"delete",sectionnumber:k,value:1};b.debug("Making course/rest.php section delete request",f);var j=c.call([{methodname:"theme_snap_course_sections",args:f}],!0,!0);j[0].done(function(b){d.render("theme_snap/course_toc",b.toc).done(function(b){a("#course-toc").html(a(b).html()),a(document).trigger("snapTOCReplaced"),m.remove(),w(),k>=a(".course-content > ul li.section").length&&(location.hash="section-"+(k-1)),i.showSection()}).always(function(){h.hideAndReset(),l=!1})}).fail(function(a){g.ifErrorShowBestMsg(a),h.hideAndReset(),l=!1})},q=M.util.get_string("confirm","moodle"),r=M.util.get_string("confirmdeletesection","moodle",o),s=M.util.get_string("deletesectionconfirm","theme_snap"),t=M.util.get_string("cancel","moodle");e.confirm(q,r,s,t,p)},y=function(c,d){c.preventDefault();var f=a(a(d).parents(".snap-asset")[0]),j=Number(f[0].id.replace("module-","")),k=f.find(".instancename").text(),m={id:j,"class":"resource",sesskey:M.cfg.sesskey,courseId:i.courseConfig.id,action:"DELETE"},n="",o="",p={type:M.util.get_string("pluginname",f.attr("class").match(/modtype_([^\s]*)/)[1])};""!==k.trim()?(p.name=k,n=M.util.get_string("deletechecktypename","moodle",p),o=M.util.get_string("deletingassetname","theme_snap",p)):(n=M.util.get_string("deletechecktype","moodle",p),o=M.util.get_string("deletingasset","theme_snap",p.type));var q=function(){if(l)return void b.debug("Skipping ajax request, one already in progress");h.setTitle(o),h.addAjaxLoading(""),h.show(),b.debug("Making course/rest.php asset delete request",m);var c=a.ajax({type:"POST",async:!0,data:m,dataType:"text",url:M.cfg.wwwroot+i.courseConfig.ajaxurl});c.done(function(c,d,e){""!==c?g.ifErrorShowBestMsg(c).done(function(c){return c?void b.debug("Ajax request fail"):(b.debug("Ajax request successful"),f.remove(),a('#toc-searchables li[data-id="'+j+'"]').remove(),void 0)}):200===e.status&&(b.debug("Ajax request successful"),f.remove(),a('#toc-searchables li[data-id="'+j+'"]').remove())}),c.fail(function(a){g.ifErrorShowBestMsg(a)}),c.always(function(){h.hideAndReset()})},r=M.util.get_string("confirm","moodle"),s=M.util.get_string("deleteassetconfirm","theme_snap",p.type),t=M.util.get_string("cancel","moodle");e.confirm(r,n,s,t,q)},z=function(b,c,d){b.preventDefault();var e=M.cfg.wwwroot+"/course/rest.php",f=a(a(c).parents(".snap-asset")[0]),h=f.attr("id").replace("module-","");s(a(f).find(".snap-meta"),!0);var j=i.courseConfig.id,k=M.util.get_string("error:failedtochangeassetvisibility","theme_snap"),l=M.util.get_string("action:changeassetvisibility","theme_snap");a.ajax({type:"POST",async:!0,url:e,dataType:"html",complete:function(){f.find(".snap-meta .loadingstat").remove()},error:function(a){g.ifErrorShowBestMsg(a,l,k)},success:function(a){g.ifErrorShowBestMsg(a,l,k).done(function(a){a||(d?f.removeClass("draft"):f.addClass("draft"))})},data:{id:h,"class":"resource",field:"visible",sesskey:M.cfg.sesskey,value:d?1:0,courseId:j}})},A=function(c){var d={};b.debug("Move objects",k),d["class"]="resource",q(),j=k.shift(),d.id=Number(j.id.replace("module-","")),c&&!a(c).hasClass("snap-drop")?d.beforeId=Number(a(c)[0].id.replace("module-","")):d.beforeId=0,"page-site-index"===document.body.id?d.sectionId=1:c?d.sectionId=n(c):d.sectionId=n(j),k.length>0?t(d,function(){a(c).before(a(j)),A(c)},!1):t(d,function(){a(c).before(a(j))},!0)},B=function(b){var e=n(b),f=m(k[0]),h=f<e?e-1:e,j={"class":"section",id:f,value:h};t(j,function(){c.call([{methodname:"theme_snap_course_toc_chapters",args:{courseshortname:i.courseConfig.shortname},done:function(b){d.render("theme_snap/course_toc_chapters",b.chapters).done(function(b){a("#chapters").replaceWith(b),a("#section-"+e).before(a("#section-"+f)),w(),location.hash="section-"+h,i.showSection(),o()})},fail:function(a){g.ifErrorShowBestMsg(a),o()}}],!0,!0)},!0)},C=function(){a(document).on("click",".snap-asset-actions .js_snap_hide",function(a){z(a,this,!1)}),a(document).on("click",".snap-asset-actions .js_snap_show",function(a){z(a,this,!0)}),a(document).on("click",".snap-asset-actions .js_snap_delete",function(a){y(a,this)}),a(document).on("click",".snap-section-editing.actions .snap-delete",function(a){x(a,this)}),a(document).on("click",".snap-asset-actions .js_snap_duplicate",function(b){b.preventDefault();var c=a(a(this).parents(".snap-asset")[0]),d=c.attr("id").replace("module-","");s(a(c).find(".snap-meta"),!0);var e=i.courseConfig.id,f=M.cfg.wwwroot+"/course/rest.php",h=M.util.get_string("action:duplicateasset","theme_snap"),j=M.util.get_string("error:failedtoduplicateasset","theme_snap");a.ajax({type:"POST",async:!0,url:f,dataType:"json",complete:function(){c.find(".snap-meta .loadingstat").remove()},error:function(a){g.ifErrorShowBestMsg(a,h,j)},success:function(b){g.ifErrorShowBestMsg(b,h,j).done(function(d){d||a(b.fullcontent).insertAfter(c)})},data:{"class":"resource",field:"duplicate",id:d,sr:0,sesskey:M.cfg.sesskey,courseId:e}})})},D=function(e,f){a("#region-main").on("click",".snap-section-editing.actions .snap-"+e,function(h){h.stopPropagation(),h.preventDefault();var j=function(a){this.message="Invalid section action: "+a,this.name="invalidActionException"},k=["visibility","highlight"];if(k.indexOf(e)===-1)throw new j(e);if(l)return void b.debug("Skipping ajax request, one already in progress");l=!0;var m="visibility"===e?"snap-show":"snap-marker",o=a(this).hasClass(m)?1:0,p=n(this),q="#section-"+p+" .snap-section-editing",r=q+" .snap-"+e;s(q,!0);var t="sectionupdate_"+(new Date).getTime().toString(16)+Math.floor(1e3*Math.random());M.util.js_pending(t);var u=c.call([{methodname:"theme_snap_course_sections",args:{courseshortname:i.courseConfig.shortname,action:e,sectionnumber:p,value:o}}],!0,!0);u[0].fail(function(a){var b,c;"visibility"===e?(b=M.util.get_string("error:failedtochangesectionvisibility","theme_snap"),c=M.util.get_string("action:changesectionvisibility","theme_snap")):(b=M.util.get_string("error:failedtohighlightsection","theme_snap"),c=M.util.get_string("action:highlightsectionvisibility","theme_snap")),g.ifErrorShowBestMsg(a,c,b).done(function(){M.util.js_complete(t)})}).always(function(){a(q+" .loadingstat").remove(),l=!1}).done(function(b){return d.render("theme_snap/course_action_section",b.actionmodel).then(function(c){return a(r).replaceWith(c),a(r).focus(),d.render("theme_snap/course_toc",b.toc)}).then(function(b){if(a("#course-toc").html(a(b).html()),a(document).trigger("snapTOCReplaced"),f&&"function"==typeof f){var c=f(p,o);c&&"function"==typeof c.always?c.always(function(){M.util.js_complete(t)}):M.util.js_complete(t)}else M.util.js_complete(t)})})})},E=function(){D("highlight",function(b){a("#section-"+b).toggleClass("current")})},F=function(){var b=function(b,c){0===c?a("#section-"+b).addClass("hidden"):a("#section-"+b).removeClass("hidden");var d=["#section-"+(b-1),"#section-"+(b+1)],e=d.join(",");return v(e)};D("visibility",b)},G=function(){h.show(function(a){a.preventDefault(),o()})},H=function(){a("#region-main").on("click",".snap-section-editing.actions .snap-move",function(c){c.stopPropagation(),c.preventDefault(),a("body").addClass("snap-move-inprogress"),G();var d=n(this);b.debug("Section is",d);var e=a("#section-"+d),f=e.find(".sectionname").text();b.debug("Moving this section",f),k=[e],a(".section-moving").removeClass("section-moving"),e.addClass("section-moving"),a('a[href="#section-'+d+'"]').parent("li").addClass("section-moving"),a("body").addClass("snap-move-section");var g=M.util.get_string("moving","theme_snap",f);h.setTitle(g),a(".section-drop").each(function(){var b=M.util.get_string("movingdropsectionhelp","theme_snap",{moving:f,before:a(this).data("title")});a(this).html(b)}),h.setSrNotice(M.util.get_string("movingstartedhelp","theme_snap",f))})},I=function(){"page-site-index"===document.body.id?a("#region-main .sitetopic ul.section").append('<li class="snap-drop asset-drop"><div class="asset-wrapper"><a href="#">'+M.util.get_string("movehere","theme_snap")+"</a></div></li>"):a("li.section .content ul.section").append('<li class="snap-drop asset-drop"><div class="asset-wrapper"><a href="#">'+M.util.get_string("movehere","theme_snap")+"</a></div></li>")},J=function(){a("#region-main").on("change",".js-snap-asset-move",function(c){c.stopPropagation();var d=a(this).parents(".snap-asset")[0],e=a(d).parents("ul.section")[0],f=a(e).find("li.snap-drop.asset-drop");if(a(e).append(f),0===k.length){var g=a(d).find(".snap-asset-link .instancename").html();b.debug("Moving this asset",g);var h=a(d).attr("class"),i=/(?=snap-mime)([a-z0-9\-]*)/,j=i.exec(h);h="",j&&(h=j.join(" ")),b.debug("Moving this class",h),a(d).addClass("asset-moving"),a(d).find(".js-snap-asset-move").prop("checked","checked"),a("body").addClass("snap-move-inprogress"),a("body").addClass("snap-move-asset")}a(this).prop("checked")?(k.push(d),a(d).addClass("asset-moving")):(r(d),a(d).removeClass("asset-moving"),0===k.length&&o()),G(),q()})},K=function(){a(document).on("click",".snap-move-note, .snap-drop",function(c){if(b.debug("Snap drop clicked",c),k)if(c.stopPropagation(),c.preventDefault(),a("body").hasClass("snap-move-section"))B(this);else{var d;d=a(this).hasClass("snap-drop")?this:a(this).closest(".snap-asset"),A(d)}})},L=function(){H(),F(),E(),J(),K(),C(),I(),a("body").addClass("snap-course-listening")},N=function(){M.course&&M.course.resource_toolbox&&(M.course.resource_toolbox.handle_resource_dim=function(a,b,c){return"hide"===c?0:1})},O=function(){L(),f.whenTrue(function(){return M.course&&M.course.init_section_toolbox},function(){N()},!0)};O()}}});