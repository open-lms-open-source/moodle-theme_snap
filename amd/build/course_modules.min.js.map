{"version":3,"sources":["../src/course_modules.js"],"names":["define","$","ajax","util","ajaxNotify","str","Event","updateModCompletion","module","completionhtml","find","html","focus","document","trigger","listenManualCompletion","on","e","preventDefault","form","hasClass","id","val","completionState","parents","first","addClass","call","methodname","args","completionstate","done","response","ifErrorShowBestMsg","errorShown","removeClass","fail","then","revealPageMod","pageMod","completionHTML","slideToggle","is","attr","listenPageModuleReadMore","closest","scrollToElement","isexpanded","toggleClass","readmore","pageModContent","data","readPageUrl","M","cfg","wwwroot","type","async","url","success","loadingStrPromise","get_string","when","loadingStr","prepend","getPageUrl","remove","notifyFilterContentUpdated","lightboxMedia","resourcemod","lightbox","appendto","onclose","lbox","length","append","click","stopPropagation","lightboxclose","lightboxopen","content","contentdiv","spinner","Y","Escape","removeAttr","init","target","hreftarget","link","href","withintarget","sessionStorage","setItem","window","open"],"mappings":"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","sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @package   theme_snap\n * @author    Guy Thomas <osdev@blackboard.com>\n * @copyright Copyright (c) 2016 Blackboard Inc.\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Course main functions.\n */\ndefine(\n    [\n        'jquery',\n        'core/ajax',\n        'theme_snap/util',\n        'theme_snap/ajax_notification',\n        'core/str',\n        'core/event'\n    ],\n    function($, ajax, util, ajaxNotify, str, Event) {\n\n        /**\n         * Module has been completed.\n         * @param {jQuery} module\n         * @param {string} completionhtml\n         */\n        var updateModCompletion = function(module, completionhtml) {\n            // Update completion tracking icon.\n            module.find('.snap-asset-completion-tracking').html(completionhtml);\n            module.find('.btn-link').focus();\n            $(document).trigger('snapModuleCompletionChange', module);\n        };\n\n        /**\n         * Listen for manual completion toggle.\n         */\n        var listenManualCompletion = function() {\n            $('.course-content').on('submit', 'form.togglecompletion', function(e) {\n                e.preventDefault();\n                var form = $(this);\n\n                if (form.hasClass('ajaxing')) {\n                    // Request already in progress.\n                    return;\n                }\n\n                var id = $(form).find('input[name=\"id\"]').val();\n                var completionState = $(form).find('input[name=\"completionstate\"]').val();\n                var module = $(form).parents('li.snap-asset').first();\n                form.addClass('ajaxing');\n\n                ajax.call([\n                    {\n                        methodname: 'theme_snap_course_module_completion',\n                        args: {id: id, completionstate: completionState},\n                        done: function(response) {\n\n                            ajaxNotify.ifErrorShowBestMsg(response).done(function(errorShown) {\n                                form.removeClass('ajaxing');\n                                if (errorShown) {\n                                    return;\n                                } else {\n                                    // No errors, update completion html for this module instance.\n                                    updateModCompletion(module, response.completionhtml);\n                                }\n                            });\n                        },\n                        fail: function(response) {\n                            ajaxNotify.ifErrorShowBestMsg(response).then(function() {\n                                form.removeClass('ajaxing');\n                            });\n                        }\n                    }\n                ], true, true);\n\n            });\n        };\n\n        /**\n         * Reveal page module content.\n         *\n         * @param {jQuery} pageMod\n         * @param {string} completionHTML - updated completionHTML\n         */\n        var revealPageMod = function(pageMod, completionHTML) {\n            pageMod.find('.pagemod-content').slideToggle(\"fast\", function() {\n                // Animation complete.\n                if (pageMod.is('.state-expanded')) {\n                    pageMod.attr('aria-expanded', 'true');\n                    pageMod.find('.pagemod-content').focus();\n\n                } else {\n                    pageMod.attr('aria-expanded', 'false');\n                    pageMod.focus();\n                }\n\n            });\n\n            if (completionHTML) {\n                updateModCompletion(pageMod, completionHTML);\n            }\n        };\n\n        /**\n         * Page mod toggle content.\n         */\n        var listenPageModuleReadMore = function() {\n            var pageToggleSelector = \".modtype_page .instancename,.pagemod-readmore,.pagemod-content .snap-action-icon\";\n            $(document).on(\"click\", pageToggleSelector, function(e) {\n                var pageMod = $(this).closest('.modtype_page');\n                util.scrollToElement(pageMod);\n                var isexpanded = pageMod.hasClass('state-expanded');\n                pageMod.toggleClass('state-expanded');\n\n                var readmore = pageMod.find('.pagemod-readmore');\n\n                var pageModContent = pageMod.find('.pagemod-content');\n                if (pageModContent.data('content-loaded') == 1) {\n                    // Content is already available so reveal it immediately.\n                    revealPageMod(pageMod);\n                    var readPageUrl = M.cfg.wwwroot + '/theme/snap/rest.php?action=read_page&contextid=' +\n                        readmore.data('pagemodcontext');\n                    if (!isexpanded) {\n                        $.ajax({\n                            type: \"GET\",\n                            async: true,\n                            url: readPageUrl,\n                            success: function(data) {\n                                ajaxNotify.ifErrorShowBestMsg(data).done(function(errorShown) {\n                                    if (errorShown) {\n                                        return;\n                                    } else {\n                                        // No errors, update completion html for this page mod instance.\n                                        updateModCompletion(pageMod, data.completionhtml);\n                                    }\n                                });\n                            }\n                        });\n                    }\n                } else {\n                    if (!isexpanded) {\n                        // Content is not available so request it.\n                        var loadingStrPromise = str.get_string('loading', 'theme_snap');\n                        $.when(loadingStrPromise).done(function(loadingStr) {\n                            pageMod.find('.contentafterlink').prepend(\n                                '<div class=\"ajaxstatus alert alert-info\">' + loadingStr + '</div>'\n                            );\n                        });\n                        var getPageUrl = M.cfg.wwwroot + '/theme/snap/rest.php?action=get_page&contextid=' +\n                            readmore.data('pagemodcontext');\n                        $.ajax({\n                            type: \"GET\",\n                            async: true,\n                            url: getPageUrl,\n                            success: function(data) {\n                                ajaxNotify.ifErrorShowBestMsg(data).done(function(errorShown) {\n                                    if (errorShown) {\n                                        return;\n                                    } else {\n                                        // No errors, reveal page mod.\n                                        pageModContent.prepend(data.html);\n                                        pageModContent.data('content-loaded', 1);\n                                        pageMod.find('.contentafterlink .ajaxstatus').remove();\n                                        revealPageMod(pageMod, data.completionhtml);\n                                        Event.notifyFilterContentUpdated('.pagemod-content');\n                                    }\n                                });\n                            }\n                        }).then(\n                            ()=>{\n                                $(document).trigger('snap-course-content-loaded');\n                            }\n                        );\n                    } else {\n                        revealPageMod(pageMod);\n                    }\n                }\n\n                e.preventDefault();\n            });\n        };\n\n        /**\n         * Light box media.\n         * @param {str|jQuery} resourcemod\n         */\n        var lightboxMedia = function(resourcemod) {\n            /**\n             * Ensure lightbox container exists.\n             *\n             * @param {string} appendto\n             * @param {function} onclose\n             * @returns {*|jQuery|HTMLElement}\n             */\n            var lightbox = function(appendto, onclose) {\n                var lbox = $('#snap-light-box');\n                if (lbox.length === 0) {\n                    $(appendto).append('<div id=\"snap-light-box\" tabindex=\"-1\">' +\n                        '<div id=\"snap-light-box-content\"></div>' +\n                        '<a id=\"snap-light-box-close\" class=\"pull-right snap-action-icon snap-icon-close\" href=\"#\">' +\n                        '<small>Close</small>' +\n                        '</a>' +\n                        '</div>');\n                    $('#snap-light-box-close').click(function(e) {\n                        e.preventDefault();\n                        e.stopPropagation();\n                        lightboxclose();\n                        if (typeof (onclose) === 'function') {\n                            onclose();\n                        }\n                    });\n                    lbox = $('#snap-light-box');\n                }\n                return lbox;\n            };\n\n            /**\n             * Close lightbox.\n             */\n            var lightboxclose = function() {\n                var lbox = lightbox();\n                lbox.remove();\n            };\n\n            /**\n             * Open lightbox and set content if necessary.\n             *\n             * @param {string} content\n             * @param {*} appendto\n             * @param {function} onclose\n             */\n            var lightboxopen = function(content, appendto, onclose) {\n                appendto = appendto ? appendto : $('body');\n                var lbox = lightbox(appendto, onclose);\n                if (content) {\n                    var contentdiv = $('#snap-light-box-content');\n                    contentdiv.html('');\n                    contentdiv.append(content);\n                }\n                lbox.addClass('state-visible');\n            };\n\n            var appendto = $('body');\n            var spinner = '<div class=\"loadingstat three-quarters\">' +\n                Y.Escape.html(M.util.get_string('loading', 'theme_snap')) +\n                '</div>';\n            lightboxopen(spinner, appendto, function() {\n                $(resourcemod).attr('tabindex', '-1').focus();\n                $(resourcemod).removeAttr('tabindex');\n            });\n\n            $.ajax({\n                type: \"GET\",\n                async: true,\n                url: M.cfg.wwwroot + '/theme/snap/rest.php?action=get_media&contextid=' + $(resourcemod).data('modcontext'),\n                success: function(data) {\n                    ajaxNotify.ifErrorShowBestMsg(data).done(function(errorShown) {\n                        if (errorShown) {\n                            return;\n                        } else {\n                            // No errors, open lightbox and update module completion.\n                            lightboxopen(data.html, appendto);\n                            updateModCompletion($(resourcemod), data.completionhtml);\n                            $(document).trigger('snapContentRevealed');\n                            $('#snap-light-box').focus();\n                        }\n                    });\n                }\n            });\n\n        };\n\n        return {\n\n            init: function() {\n\n                // Listeners\n                listenPageModuleReadMore();\n                listenManualCompletion();\n\n                // Add toggle class for hide/show activities/resources - additional to moodle adding dim.\n                $(document).on(\"click\", '[data-action=hide],[data-action=show]', function() {\n                    $(this).closest('li.activity').toggleClass('draft');\n                });\n\n                // Make lightbox for list display of resources.\n                $(document).on('click', '.js-snap-media .snap-asset-link [href*=\"/mod/resource/view.php?id=\"]', function(e) {\n                    lightboxMedia($(this).closest('.snap-resource, .snap-extended-resource'));\n                    e.preventDefault();\n                });\n\n                // Make resource cards clickable.\n                $(document).on('click', '.snap-resource-card .snap-resource, .snap-extended-resource', function(e) {\n                    var trigger = $(e.target),\n                        hreftarget = '_self',\n                        link = $(trigger).closest('.snap-resource').find('.snap-asset-link a'),\n                        href = '';\n                    if (link.length > 0) {\n                        href = $(link).attr('href');\n                    }\n\n                    // Excludes any clicks in the actions menu, on links or forms.\n                    var selector = '.snap-asset-completion-tracking, ' +\n                        '.snap-asset-actions, .contentafterlink a, .ally-actions, ' +\n                        '.snap-header-card, .contentafterlink, .snap-asset-meta';\n                    var withintarget = $(trigger).closest(selector).length;\n                    if (!withintarget) {\n                        if ($(this).hasClass('js-snap-media')) {\n                            lightboxMedia(this);\n                        } else {\n                            if (href === '') {\n                                return;\n                            }\n                            if ($(link).attr('target') === '_blank') {\n                                hreftarget = '_blank';\n                            }\n                            sessionStorage.setItem('lastMod', $(this).attr('id'));\n                            window.open(href, hreftarget);\n                        }\n                        e.preventDefault();\n                    }\n                });\n            }\n        };\n    }\n);\n"],"file":"course_modules.min.js"}